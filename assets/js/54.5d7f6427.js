(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{426:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("Badges",{attrs:{content:[{type:"tip",text:"React17"},{type:"tip",text:"精简"}]}}),t._v(" "),s("TimeToRead"),t._v(" "),s("h2",{attrs:{id:"目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[t._v("#")]),t._v(" 目录")]),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#目录"}},[t._v("目录")])]),s("li",[s("a",{attrs:{href:"#前言"}},[t._v("前言")])]),s("li",[s("a",{attrs:{href:"#finishconcurrentrender"}},[t._v("finishConcurrentRender")])]),s("li",[s("a",{attrs:{href:"#commitroot"}},[t._v("commitRoot")])]),s("li",[s("a",{attrs:{href:"#effectlist-的遍历"}},[t._v("EffectList 的遍历")])]),s("li",[s("a",{attrs:{href:"#commitbeforemutationeffects"}},[t._v("commitBeforeMutationEffects")])]),s("li",[s("a",{attrs:{href:"#commitmutationeffects"}},[t._v("commitMutationEffects")])]),s("li",[s("a",{attrs:{href:"#commitlayouteffects"}},[t._v("commitLayoutEffects")])]),s("li",[s("a",{attrs:{href:"#扩展"}},[t._v("扩展")]),s("ul",[s("li",[s("a",{attrs:{href:"#commitrootimpl-三次执行-flushpassiveeffects-有何含义"}},[t._v("commitRootImpl 三次执行 flushPassiveEffects 有何含义？")])])])]),s("li",[s("a",{attrs:{href:"#问题"}},[t._v("问题")]),s("ul",[s("li",[s("a",{attrs:{href:"#为什么在-layout-阶段之后需要-requestpaint"}},[t._v("为什么在 layout 阶段之后需要 requestPaint?")])])])]),s("li",[s("a",{attrs:{href:"#总结"}},[t._v("总结")])]),s("li",[s("a",{attrs:{href:"#参考"}},[t._v("参考")])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("在上篇文章中，我们对 React 渲染过程中的 “捕获” 与 “冒泡” 过程的理解有了更深一层的认识，并且从整体脉络上总结了  "),s("code",[t._v("Batch")]),t._v("  阶段和  "),s("code",[t._v("Render")]),t._v("  阶段的过程。从本文开始，我们将开始探讨  "),s("code",[t._v("Commit")]),t._v("  阶段的原理，逐步了解 FiberTree 向 DOMTree 飞跃的过程。")]),t._v(" "),s("p",[t._v("渲染根据调度方式的不同被分成了同步渲染和异步渲染，在同步的渲染结束后调用  "),s("code",[t._v("commitRoot")]),t._v("  提交本次的调和结果，而在异步渲染结束后是通过  "),s("code",[t._v("finishConcurrentRender")]),t._v("  来处理后续的工作的。下面我们就从  "),s("code",[t._v("finishConcurrentRender")]),t._v("  函数开始深入分析。")]),t._v(" "),s("h2",{attrs:{id:"finishconcurrentrender"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#finishconcurrentrender"}},[t._v("#")]),t._v(" finishConcurrentRender")]),t._v(" "),s("p",[t._v("从本质上来说  "),s("code",[t._v("finishConcurrentRender")]),t._v("  的核心作用还是执行  "),s("code",[t._v("commitRoot")]),t._v("  以提交调和结果，但是相比同步渲染而言，异步渲染要更加复杂，换句话说， "),s("code",[t._v("Render")]),t._v("  结束后要视情况而定是否需要立即  "),s("code",[t._v("Commit")]),t._v(" ，要根据 "),s("code",[t._v("Render")]),t._v("  阶段的执行情况（exitStatus）加以确认。 "),s("code",[t._v("Commit")]),t._v("  的操作应当足够高效，因为 DOM 的绘制过程成本不菲。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("finishConcurrentRender")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("RootErrored")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("RootSuspended")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("RootSuspendedWithDelay")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("markRootSuspended")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The work expired. Commit immediately.")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("RootCompleted")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The work completed. Ready to commit.")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br")])]),s("p",[t._v("分析如下：")]),t._v(" "),s("ul",[s("li",[t._v("只有在发生普通错误的时候才允许提交， "),s("code",[t._v("RootIncomplete")]),t._v("  (未完成状态) 和 "),s("code",[t._v("RootFatalErrored")]),t._v(" （致命错误状态）是不允许提交的。这也很符合预期，因为在进入此函数之前，普通错误就已经重试多次了。")]),t._v(" "),s("li",[t._v("对于  "),s("code",[t._v("RootSuspended")]),t._v("  和  "),s("code",[t._v("RootSuspendedWithDelay")]),t._v(" ，必须等到任务超时，才能够进行提交。")])]),t._v(" "),s("h2",{attrs:{id:"commitroot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitroot"}},[t._v("#")]),t._v(" commitRoot")]),t._v(" "),s("Badges",{attrs:{content:[{type:"tip",text:"重要"}]}}),t._v(" "),s("p",[s("code",[t._v("commitRoot")]),t._v("  主要调用  "),s("code",[t._v("commitRootImpl")]),t._v("  函数，源码如下：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitRootImpl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" renderPriorityLevel")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// means `flushPassiveEffects` will sometimes result in additional")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// passive effects. So we need to keep flushing in a loop until there are")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no more pending effects.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootWithPendingPassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 确保当前是 Batch 状态")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("RenderContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" CommitContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Should not already be working.'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" finishedWork "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当前 commit 的优先级")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("finishedLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 合并finishedWork子树的 lanes，剩余的未处理的优先级")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" remainingLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将剩余未处理的优先级挂载到 root.pendingLanes 上")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("markRootFinished")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remainingLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If there are pending passive effects, schedule a callback to process them.")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do this as early as possible, so it is queued before anything else that")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// might get scheduled in the commit phase. ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 确保子树有 PassiveMask 副作用时被调度以处理副作用")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// const PassiveMask = Passive | ChildDeletion;")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subtreeFlags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" PassiveMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoFlags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" PassiveMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoFlags\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rootDoesHavePassiveEffects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      rootDoesHavePassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NormalSchedulerPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This render triggered passive effects")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Check if there are any effects in the whole tree.")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断子树是否有副作用")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" subtreeHasEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subtreeFlags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BeforeMutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" MutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" LayoutMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" PassiveMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v("\n    NoFlags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断根节点是否有副作用")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootHasEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BeforeMutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" MutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" LayoutMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" PassiveMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v("\n    NoFlags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果子树或者根节点有副作用，则处理之")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subtreeHasEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" rootHasEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevExecutionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" executionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// executionContext 更新为 CommitContext")]),t._v("\n    executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" CommitContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The commit phase is broken into several sub-phases. We do a separate pass")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// of the effect list for each phase: all mutation effects come before all")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// layout effects, and so on.")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// The first phase a "before mutation" phase. We use this phase to read the')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// state of the host tree right before we mutate it. This is where")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// getSnapshotBeforeUpdate is called.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Commit  阶段分成三个步骤，分别是 before mutation, mutation 和 layout。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// before mutation 阶段在 mutation 之前读取旧状态，并调用相关的组件生命周期函数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" shouldFireAfterActiveInstanceBlur "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitBeforeMutationEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The next phase is the mutation phase, where we mutate the host tree.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mutation 阶段对副作用进行执行和更新，执行 DOM 操作，调用相关的生命周期函数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The work-in-progress tree is now the current tree. This must come after")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the mutation phase, so that the previous tree is still current during")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// componentWillUnmount, but before the layout phase, so that the finished")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// work is current during componentDidMount/Update.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// workInProgress 树切换到current树的时机是在mutation结束后，layout开始前。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这样做的原因是在mutation阶段调用类组件的componentWillUnmount的时候，还可以获取到卸载前的组件信息；")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在layout阶段调用componentDidMount/Update时，获取的组件信息更新后的。")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The next phase is the layout phase, where we call effects that read")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the host tree after it's been mutated. The idiomatic use case for this is")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// layout, but class component lifecycles also fire here for legacy reasons.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// layout 阶段在 mutation 阶段之后，读取组件的最新状态，并执行相关的生命周期函数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitLayoutEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Tell Scheduler to yield at the end of the frame, so the browser has an")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// opportunity to paint.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求调度器在帧尾阻塞 `Render` 过程，以使浏览器有足够的空闲时间绘制视图")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestPaint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Commit 完毕后恢复  executionContext ")]),t._v("\n    executionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" prevExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n  \n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includesSomeLane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pendingPassiveEffectsLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SyncLane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" LegacyRoot\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 退出 commitRoot 时调用，确保 Root 上新的任务会被调度")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensureRootIsScheduled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If layout work was scheduled, flush it now.")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushSyncCallbacks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br"),s("span",{staticClass:"line-number"},[t._v("45")]),s("br"),s("span",{staticClass:"line-number"},[t._v("46")]),s("br"),s("span",{staticClass:"line-number"},[t._v("47")]),s("br"),s("span",{staticClass:"line-number"},[t._v("48")]),s("br"),s("span",{staticClass:"line-number"},[t._v("49")]),s("br"),s("span",{staticClass:"line-number"},[t._v("50")]),s("br"),s("span",{staticClass:"line-number"},[t._v("51")]),s("br"),s("span",{staticClass:"line-number"},[t._v("52")]),s("br"),s("span",{staticClass:"line-number"},[t._v("53")]),s("br"),s("span",{staticClass:"line-number"},[t._v("54")]),s("br"),s("span",{staticClass:"line-number"},[t._v("55")]),s("br"),s("span",{staticClass:"line-number"},[t._v("56")]),s("br"),s("span",{staticClass:"line-number"},[t._v("57")]),s("br"),s("span",{staticClass:"line-number"},[t._v("58")]),s("br"),s("span",{staticClass:"line-number"},[t._v("59")]),s("br"),s("span",{staticClass:"line-number"},[t._v("60")]),s("br"),s("span",{staticClass:"line-number"},[t._v("61")]),s("br"),s("span",{staticClass:"line-number"},[t._v("62")]),s("br"),s("span",{staticClass:"line-number"},[t._v("63")]),s("br"),s("span",{staticClass:"line-number"},[t._v("64")]),s("br"),s("span",{staticClass:"line-number"},[t._v("65")]),s("br"),s("span",{staticClass:"line-number"},[t._v("66")]),s("br"),s("span",{staticClass:"line-number"},[t._v("67")]),s("br"),s("span",{staticClass:"line-number"},[t._v("68")]),s("br"),s("span",{staticClass:"line-number"},[t._v("69")]),s("br"),s("span",{staticClass:"line-number"},[t._v("70")]),s("br"),s("span",{staticClass:"line-number"},[t._v("71")]),s("br"),s("span",{staticClass:"line-number"},[t._v("72")]),s("br"),s("span",{staticClass:"line-number"},[t._v("73")]),s("br"),s("span",{staticClass:"line-number"},[t._v("74")]),s("br"),s("span",{staticClass:"line-number"},[t._v("75")]),s("br"),s("span",{staticClass:"line-number"},[t._v("76")]),s("br"),s("span",{staticClass:"line-number"},[t._v("77")]),s("br"),s("span",{staticClass:"line-number"},[t._v("78")]),s("br"),s("span",{staticClass:"line-number"},[t._v("79")]),s("br"),s("span",{staticClass:"line-number"},[t._v("80")]),s("br"),s("span",{staticClass:"line-number"},[t._v("81")]),s("br"),s("span",{staticClass:"line-number"},[t._v("82")]),s("br"),s("span",{staticClass:"line-number"},[t._v("83")]),s("br"),s("span",{staticClass:"line-number"},[t._v("84")]),s("br"),s("span",{staticClass:"line-number"},[t._v("85")]),s("br"),s("span",{staticClass:"line-number"},[t._v("86")]),s("br"),s("span",{staticClass:"line-number"},[t._v("87")]),s("br"),s("span",{staticClass:"line-number"},[t._v("88")]),s("br"),s("span",{staticClass:"line-number"},[t._v("89")]),s("br"),s("span",{staticClass:"line-number"},[t._v("90")]),s("br"),s("span",{staticClass:"line-number"},[t._v("91")]),s("br"),s("span",{staticClass:"line-number"},[t._v("92")]),s("br"),s("span",{staticClass:"line-number"},[t._v("93")]),s("br"),s("span",{staticClass:"line-number"},[t._v("94")]),s("br"),s("span",{staticClass:"line-number"},[t._v("95")]),s("br"),s("span",{staticClass:"line-number"},[t._v("96")]),s("br"),s("span",{staticClass:"line-number"},[t._v("97")]),s("br"),s("span",{staticClass:"line-number"},[t._v("98")]),s("br"),s("span",{staticClass:"line-number"},[t._v("99")]),s("br"),s("span",{staticClass:"line-number"},[t._v("100")]),s("br"),s("span",{staticClass:"line-number"},[t._v("101")]),s("br"),s("span",{staticClass:"line-number"},[t._v("102")]),s("br"),s("span",{staticClass:"line-number"},[t._v("103")]),s("br"),s("span",{staticClass:"line-number"},[t._v("104")]),s("br"),s("span",{staticClass:"line-number"},[t._v("105")]),s("br"),s("span",{staticClass:"line-number"},[t._v("106")]),s("br"),s("span",{staticClass:"line-number"},[t._v("107")]),s("br"),s("span",{staticClass:"line-number"},[t._v("108")]),s("br"),s("span",{staticClass:"line-number"},[t._v("109")]),s("br"),s("span",{staticClass:"line-number"},[t._v("110")]),s("br"),s("span",{staticClass:"line-number"},[t._v("111")]),s("br"),s("span",{staticClass:"line-number"},[t._v("112")]),s("br"),s("span",{staticClass:"line-number"},[t._v("113")]),s("br"),s("span",{staticClass:"line-number"},[t._v("114")]),s("br"),s("span",{staticClass:"line-number"},[t._v("115")]),s("br"),s("span",{staticClass:"line-number"},[t._v("116")]),s("br")])]),s("p",[t._v("此函数涵盖了  "),s("code",[t._v("Commit")]),t._v("  阶段的整个过程，有一些细节问题分析如下：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("flushPassiveEffects")]),t._v(" :  "),s("code",[t._v("flushPassiveEffects")]),t._v("  主要与  "),s("code",[t._v("useEffect")]),t._v("  的副作用相关，此函数以同步或者异步的方式执行  "),s("code",[t._v("useEffect")]),t._v("  的销毁函数和回调函数。细节部分将在 hook 相关章节进行详细探讨。如果子树有  "),s("code",[t._v("PassiveMask")]),t._v("  标记，则在调度器的回调中调用  "),s("code",[t._v("flushPassiveEffects")]),t._v(" 。")]),t._v(" "),s("li",[t._v("有四种副作用标记被用来判断是否需要  "),s("code",[t._v("Commit")]),t._v(" ，分别是： "),s("code",[t._v("BeforeMutationMask")]),t._v(" 、 "),s("code",[t._v("MutationMask")]),t._v(" 、 "),s("code",[t._v("LayoutMask")]),t._v(" 、 "),s("code",[t._v("PassiveMask")]),t._v(" 。当  "),s("code",[t._v("finishedWork")]),t._v("  根节点上或者子树上具有如上的副作用，则执行  "),s("code",[t._v("Commit")]),t._v("  操作。")]),t._v(" "),s("li",[s("code",[t._v("Commit")]),t._v("  过程分成三个步骤，分别是  "),s("code",[t._v("beforeMutation")]),t._v(" 、 "),s("code",[t._v("mutation")]),t._v("  和 "),s("code",[t._v("layout")]),t._v(" ，分别调用  "),s("code",[t._v("commitBeforeMutationEffects")]),t._v(" 、 "),s("code",[t._v("commitMutationEffects")]),t._v("  和  "),s("code",[t._v("commitLayoutEffects")]),t._v(" 。")]),t._v(" "),s("li",[t._v("workInProgress FiberTree 成为 current FiberTree 是在  "),s("code",[t._v("mutation")]),t._v("  阶段之后、layout 阶段之前完成的， "),s("code",[t._v("root.current = finishedWork")]),t._v(" 。之前的 current FiberTree 现在利索当前的就成了  "),s("code",[t._v("workInProgress FiberTree")]),t._v(" 。")]),t._v(" "),s("li",[t._v("在  "),s("code",[t._v("mutation")]),t._v("  阶段，React 已经根据 EffectTag 操纵 JavaScript 对 DOM 进行了插入、更新、删除等操作，由于浏览器的空闲时间实际上是被调度器控制的，所以在  "),s("code",[t._v("layout")]),t._v("  阶段完成之后，需要通知调度器进行 yield（阻塞渲染回调），给浏览器重绘留下充足的时间。 "),s("code",[t._v("requestPaint")]),t._v("  函数将在调度器部分进行详细的分析。")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("旧版本的执行逻辑")]),t._v(" "),s("p",[t._v("三个阶段：")]),t._v(" "),s("ul",[s("li",[t._v("before mutation：读取组件变更前的状态，针对类组件，调用 getSnapshotBeforeUpdate，让我们可以在 DOM 变更前获取组件实例的信息；针对函数组件，异步调度 useEffect。")]),t._v(" "),s("li",[t._v("mutation：针对 HostComponent，进行相应的 DOM 操作；针对类组件，调用 componentWillUnmount；针对函数组件，执行 useLayoutEffect 的销毁函数。")]),t._v(" "),s("li",[t._v("layout：在 DOM 操作完成后，读取组件的状态，针对类组件，调用生命周期 componentDidMount 和 componentDidUpdate，调用 setState 的回调；针对函数组件填充 useEffect 的 effect 执行数组，并调度 useEffect。")])])]),t._v(" "),s("p",[t._v("在进入下面三个核心函数的分析之前，我们需要先分析一下 FiberTree 上 Effect 的遍历过程。从上文中我们已经知道了，新版的 React 去除了 EffectList 的概念，将 Effect 冒泡收集到  "),s("code",[t._v("subtreeFlags")]),t._v("  标记上。因此，在对 EffectList 的遍历时，就不能直接使用旧版中链表的遍历方式。")]),t._v(" "),s("h2",{attrs:{id:"effectlist-的遍历"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#effectlist-的遍历"}},[t._v("#")]),t._v(" EffectList 的遍历")]),t._v(" "),s("p",[t._v("下面以  "),s("code",[t._v("commitMutationEffects")]),t._v("  探讨 FiberTree 中  "),s("code",[t._v("EffectList")]),t._v("  的遍历过程。这里同样分为 “捕获” 和 “冒泡” 的过程，将遍历过程穿插执行的工作可以理解为  "),s("code",[t._v("beginWork")]),t._v("  和  "),s("code",[t._v("completeWork")]),t._v(" 。（注意，此时遍历的原理与调和 FiberTree 时遍历的原理一致）。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/react/packages/react-reconciler/src/ReactFiberCommitWork.new.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("root")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FiberRoot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("firstChild")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" firstChild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects_begin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects_begin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("root")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FiberRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// begin work......（beginWork插槽）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" child "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// MutationMask 或者 BeforeMutationMask 或者 LayoutMask")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果当前 Fiber 有 subtreeFlags，说明子树中有相应的 EffectTag")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里的判断决定是否需要继续捕获")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subtreeFlags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" MutationMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoFlags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" child "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将子节点作为下一个遍历的节点，向下捕获")]),t._v("\n      nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" child"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不符合上述条件，说明子树中无响应的 EffectTag，因此开始冒泡")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects_complete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffects_complete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("root")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FiberRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fiber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// complete work......（completeWork插槽）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 冒泡时先冒泡到兄弟节点，无兄弟节点时再冒泡到父节点")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 冒泡一次后需要仅此进行捕获的判断，因此需要 return")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sibling "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sibling"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sibling "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n      nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sibling"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("return"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br")])]),s("p",[t._v("弄清楚上述的 “捕获” 和 “冒泡” 的遍历过程之后，在下文中  "),s("code",[t._v("commitBeforeMutationEffects")]),t._v(" 、 "),s("code",[t._v("commitMutationEffects")]),t._v("  和 "),s("code",[t._v("commitLayoutEffects")]),t._v("  三个函数中都是对此遍历方法的应用。因此在下文的分析中，我们将着重探讨  "),s("code",[t._v("beginWork")]),t._v("  和  "),s("code",[t._v("completeWork")]),t._v("  插槽中的工作细节。")]),t._v(" "),s("h2",{attrs:{id:"commitbeforemutationeffects"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitbeforemutationeffects"}},[t._v("#")]),t._v(" commitBeforeMutationEffects")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// completeWork插槽")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitBeforeMutationEffectsOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("分析如下：")]),t._v(" "),s("ul",[s("li",[t._v("在冒泡阶段在 fiber 上执行  "),s("code",[t._v("commitBeforeMutationEffectsOnFiber")]),t._v(" 。")])]),t._v(" "),s("h2",{attrs:{id:"commitmutationeffects"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitmutationeffects"}},[t._v("#")]),t._v(" commitMutationEffects")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// beginWork插槽")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" deletions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deletions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deletions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" deletions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" childToDelete "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" deletions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitDeletion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" childToDelete"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// completeWork插槽")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitMutationEffectsOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("p",[t._v("分析如下：")]),t._v(" "),s("ul",[s("li",[t._v("在捕获阶段查找 fiber 上  "),s("code",[t._v("deletions")]),t._v("  收集的待删除的节点，并且提交节点的删除。")]),t._v(" "),s("li",[t._v("在冒泡阶段调用  "),s("code",[t._v("commitMutationEffectsOnFiber")]),t._v(" 。")]),t._v(" "),s("li",[t._v("为什么删除操作要在捕获阶段单独进行，而不是放在冒泡阶段一起处理？因为删除操作相对于更新操作（添加或者更新）而言要简单许多，在当前已经遍历到的节点上，只需将前置工作中收集到的待删除的节点进行处理即可；相对而言， "),s("code",[t._v("commitMutationEffectsOnFiber")]),t._v("  的处理过程则要复杂的多，需要通过不同的 EffectTag 以进行不同的处理，并且处理方式也与组件的类型有很大的关联。所以此处将删除操作在捕获时即执行，一是因为删除操纵本身与 EffectTag 类型、组件类型无关，而是因为提前处理能够避免 DOM 操作的混乱性。")])]),t._v(" "),s("h2",{attrs:{id:"commitlayouteffects"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitlayouteffects"}},[t._v("#")]),t._v(" commitLayoutEffects")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// completeWork插槽")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" LayoutMask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoFlags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ......")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitLayoutEffectOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fiber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" committedLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("分析如下：")]),t._v(" "),s("ul",[s("li",[t._v("在捕获阶段执行  "),s("code",[t._v("commitLayoutEffectOnFiber")]),t._v(" ，但需使 fiber 上具有  "),s("code",[t._v("LayoutMask")]),t._v("  标记。")])]),t._v(" "),s("p",[t._v("我们可能已经注意到，在上述  "),s("code",[t._v("commitBeforeMutationEffectsOnFiber")]),t._v(" 、 "),s("code",[t._v("commitMutationEffectsOnFiber")]),t._v("  函数中，都没有 EffectTag 的标记要求，而  "),s("code",[t._v("commitLayoutEffectOnFiber")]),t._v("  却要求 fiber 具有  "),s("code",[t._v("LayoutMask")]),t._v("  标记。事实上  "),s("code",[t._v("MutationMask")]),t._v(" 、 "),s("code",[t._v("BeforeMutationMask")]),t._v("  或者  "),s("code",[t._v("LayoutMask")]),t._v("  都是 EffectTag 的集合：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Groups of flags that are used in the commit phase to skip over trees that")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// don't contain effects, by checking subtreeFlags.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" BeforeMutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Snapshot "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ChildDeletion "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Visibility"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" MutationMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Placement "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ChildDeletion "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ContentReset "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Ref "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Hydrating "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Visibility"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" LayoutMask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Callback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Ref "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Visibility"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("通过判断 subtreeFlags 上是否有这个 EffectTag 的组合，可以使捕获和冒泡的过程能够进行的针对需要进行操作的节点进行处理。")]),t._v(" "),s("h2",{attrs:{id:"扩展"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#扩展"}},[t._v("#")]),t._v(" 扩展")]),t._v(" "),s("h3",{attrs:{id:"commitrootimpl-三次执行-flushpassiveeffects-有何含义"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitrootimpl-三次执行-flushpassiveeffects-有何含义"}},[t._v("#")]),t._v(" "),s("code",[t._v("commitRootImpl")]),t._v("  三次执行  "),s("code",[t._v("flushPassiveEffects")]),t._v("  有何含义？")]),t._v(" "),s("p",[t._v("首先需要明确的是， "),s("code",[t._v("flushPassiveEffects")]),t._v("  是与  "),s("code",[t._v("useEffect")]),t._v("  所产生的的副作用是密切相关的，在发生一次 “渲染” 的前后，需要对这种  "),s("code",[t._v("Passive")]),t._v("  的副作用进行处理，包括执行副作用的销毁函数和副作用函数。")]),t._v(" "),s("p",[t._v("所谓副作用，是在某些触发渲染的时机上执行 DOM 操作、网络请求、日志打印、事件订阅、定时任务等行为。副作用是不能直接在组件主体（函数式组件）中执行的，因为 React 无法保证副作用在执行时所处的环境是正确的。事实上，在函数主体执行时，React 还处于调和阶段，并没有  "),s("code",[t._v("Commit")]),t._v("  下一次的渲染，况且直接在函数体中执行的副作用会极大的阻塞调和的效率（参照前文内容）。")]),t._v(" "),s("p",[t._v("因此，在函数式组件的主体函数中应当遵循 “"),s("strong",[t._v("只定义组件的特性和行为方式（包括视图的定义、事件回调的定义、副作用的定义、状态和计算属性的定义，因此可以把函数式组件分成  "),s("code",[t._v("Render")]),t._v(" 、 "),s("code",[t._v("Callback/Handler")]),t._v(" 、 "),s("code",[t._v("Effect")]),t._v("  和 "),s("code",[t._v("Props/State")]),t._v("  四个部分），不进行高成本的计算")]),t._v(" “的原则，“JSX” 本质上是一种"),s("strong",[t._v("动态的描述和定义组件的语法糖")]),t._v("。"),s("strong",[t._v("组件的状态和行为的变化应该由副作用和事件机制来推动")]),t._v("。（注意：副作用虽然可以用来模拟类似于类组件的生命周期，但是其理念是极为不同的，相比而言，副作用是函数式编程的产物，要更为灵活和高效，"),s("strong",[t._v("按照生命周期的想法去编写函数式组件是错误的，React 中提供的副作用钩子并不能准确的翻译 / 转化为类组件各种生命周期")]),t._v("！参见"),s("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render",target:"_blank",rel:"noopener noreferrer"}},[t._v(" Hook 会因为在渲染时创建函数而变慢吗？"),s("OutboundLink")],1),t._v("。）")]),t._v(" "),s("p",[t._v("回归整体， "),s("code",[t._v("commitRootImpl")]),t._v("  函数中共有三次  "),s("code",[t._v("flushPassiveEffects")]),t._v("  的调用：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// [1]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootWithPendingPassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// [2]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NormalSchedulerPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// [3]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includesSomeLane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pendingPassiveEffectsLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SyncLane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("ul",[s("li",[t._v("第一次执行  "),s("code",[t._v("flushPassiveEffects")]),t._v("  是在  "),s("code",[t._v("Commit")]),t._v("  三大步骤未开始之前执行的，目的是判断是否有残留的  "),s("code",[t._v("passiveEffects")]),t._v(" （useEffect 的副作用） 未执行，如果有则调用  "),s("code",[t._v("flushPassiveEffects")]),t._v("  处理之。之所有用  "),s("code",[t._v("while")]),t._v("  循环是因为副作用有可能产生新的副作用（注意：在函数式组件中，应该避免副作用之间相互调用以免造成死循环）。")]),t._v(" "),s("li",[t._v("第二次执行  "),s("code",[t._v("flushPassiveEffects")]),t._v("  是在  "),s("code",[t._v("Commit")]),t._v("  三大步骤未开始之前请求一次  "),s("code",[t._v("flushPassiveEffects")]),t._v("  的调度，从前文中我们已经知道， "),s("code",[t._v("Commit")]),t._v("  步骤中会阻塞  "),s("code",[t._v("Render")]),t._v("  过程，但是并不会阻塞调度过程，因此，此次  "),s("code",[t._v("flushPassiveEffects")]),t._v("  调度能够保证其执行时间能够在本次  "),s("code",[t._v("Commit")]),t._v("  阶段之后，也就是说 "),s("code",[t._v("传给 useEffect 的函数会在浏览器完成布局与绘制之后，在一个延迟事件中被调用")]),t._v(" ，参见"),s("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects",target:"_blank",rel:"noopener noreferrer"}},[t._v(" effect 的执行时机"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("li",[t._v("第三次执行  "),s("code",[t._v("flushPassiveEffects")]),t._v("  是在  "),s("code",[t._v("root.finishedLanes")]),t._v("  中有同步的 lanes 的时机下，这说明本次副作用的处理的优先级较高，需同步执行。 "),s("code",[t._v("从 React 18 开始，当它是离散的用户输入（如点击）的结果时，或者当它是由 flushSync 包装的更新结果时，传递给 useEffect 的函数将在屏幕布局和绘制之前同步执行")]),t._v(" ，参见"),s("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects",target:"_blank",rel:"noopener noreferrer"}},[t._v(" effect 的执行时机"),s("OutboundLink")],1),t._v("。")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("重点提示")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("flushPassiveEffects")]),t._v("  的执行是异步的，是通过调度器的调度完成的，但是可以保证相关的副作用是在当前  "),s("code",[t._v("Commit")]),t._v("  之后，也即视图更新渲染之后执行。")]),t._v(" "),s("li",[s("code",[t._v("useEffect")]),t._v("  中的副作用的执行时机是： "),s("code",[t._v("Commit")]),t._v("  完成之后进入  "),s("code",[t._v("Batch")]),t._v("  阶段中的某一次调度器的回调中，进一步将就是，屏幕视图布局和绘制之后的一个延迟事件中。 "),s("code",[t._v("useEffect")]),t._v("  中副作用的执行是异步的。")]),t._v(" "),s("li",[s("code",[t._v("useEffect")]),t._v("  中的副作用也可以同步的执行（ "),s("code",[t._v("useLayoutEffect")]),t._v("  中副作用执行之后，在  "),s("code",[t._v("Commit")]),t._v("  完成之时），当然这需要特殊的条件。")])])]),t._v(" "),s("h2",{attrs:{id:"问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),s("h3",{attrs:{id:"为什么在-layout-阶段之后需要-requestpaint"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么在-layout-阶段之后需要-requestpaint"}},[t._v("#")]),t._v(" 为什么在  "),s("code",[t._v("layout")]),t._v("  阶段之后需要  "),s("code",[t._v("requestPaint")]),t._v(" ?")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("By default, the browser will wait until the current thread of execution finishes and do one consolidated reflow and repaint (as this is considered more efficient than doing many reflows and repaints). This is not specified in any specification so the browser can implement as it wants to.")]),t._v(" "),s("p",[t._v("But, there are some specific operations that will generally trigger a reflow (and sometimes a corresponding repaint). These operations are operations (requesting certain properties related to the position of elements) which can only be completed when an accurate reflow has been done. So, it is possible to manually trigger a reflow by requesting one of these properties.")]),t._v(" "),s("p",[t._v("参见："),s("a",{attrs:{href:"https://stackoverflow.com/questions/27196753/when-does-the-dom-repaint-during-javascript-routines",target:"_blank",rel:"noopener noreferrer"}},[t._v("html - When does the DOM repaint during Javascript routines? - Stack Overflow"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("默认情况下，浏览器会在当前线程执行完成之后，执行一次合并的  "),s("code",[t._v("reflow")]),t._v("  和  "),s("code",[t._v("repaint")]),t._v(" 。但是也存在一些特殊的情况会触发  "),s("code",[t._v("reflow")]),t._v(" ，这就是执行那些只有在  "),s("code",[t._v("reflow")]),t._v("  之后才能完成的任务。因此，操纵 JavaScript 执行 DOM 操作并不是会立即促使浏览器进行  "),s("code",[t._v("repaint")]),t._v(" ，这其中浏览器有诸多优化措施以保证  "),s("code",[t._v("reflow")]),t._v("  和  "),s("code",[t._v("repaint")]),t._v("  高效的进行。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("本文中最最要的内容是对  "),s("code",[t._v("commitRoot")]),t._v("  函数的分析。 "),s("code",[t._v("commitRoot")]),t._v("  是  "),s("code",[t._v("Commit")]),t._v("  阶段提纲挈领的函数，它将整个  "),s("code",[t._v("Commit")]),t._v("  的过程分成了最要的三个步骤，分别是  "),s("code",[t._v("beforeMutation")]),t._v(" 、 "),s("code",[t._v("mutation")]),t._v("  和  "),s("code",[t._v("layout")]),t._v(" 。这三个步骤分别调用  "),s("code",[t._v("commitBeforeMutationEffects")]),t._v(" 、 "),s("code",[t._v("commitMutationEffects")]),t._v("  和  "),s("code",[t._v("commitLayoutEffects")]),t._v("  函数进行处理，总结其特性分别是  "),s("code",[t._v("commitBeforeMutationEffects")]),t._v("  提供组件更新之前的实例数据， "),s("code",[t._v("commitMutationEffects")]),t._v("  操作原生 JavaScript 更新 DOM 节点，处理组件销毁前的副作用， "),s("code",[t._v("commitLayoutEffects")]),t._v("  处理组件挂载后（更新后）的副作用。")]),t._v(" "),s("p",[t._v("另外一个重点是， "),s("code",[t._v("workInProgress")]),t._v("  树切换为  "),s("code",[t._v("current")]),t._v("  树的过程是在  "),s("code",[t._v("mutation")]),t._v("  之后  "),s("code",[t._v("layout")]),t._v("  之前完成的。三个步骤完成之后需要通知调度器进行 yield （中断  "),s("code",[t._v("Render")]),t._v("  阶段的执行），从而使浏览器有足够的时间对  "),s("code",[t._v("mutation")]),t._v("  阶段造成的 DOM 更新进行重排（reflow）和重绘（repaint）。")]),t._v(" "),s("p",[t._v("上述三个步骤追根究底还是在  "),s("code",[t._v("EffectList")]),t._v(" （沿用旧版本的概念） 的遍历过程中执行的，其总体过程可归纳为 “跳跃式的”（可精准的针对有相关  "),s("code",[t._v("EffectTagMask")]),t._v("  的节点进行操作）“捕获与冒泡” 的过程，其内部逻辑同样可抽象为   "),s("code",[t._v("beginWork")]),t._v("  和  "),s("code",[t._v("completeWork")]),t._v("  的工作。上述三个步骤其实质是要执行  "),s("code",[t._v("commitBeforeMutationEffectsOnFiber")]),t._v(" 、 "),s("code",[t._v("commitMutationEffectsOnFiber")]),t._v("  和  "),s("code",[t._v("commitLayoutEffectOnFiber")]),t._v("  函数。")]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ul",[s("li",[t._v("旧版本："),s("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10255458",target:"_blank",rel:"noopener noreferrer"}},[t._v("React 源碼 commit 階段詳解"),s("OutboundLink")],1)])])],1)}),[],!1,null,null,null);s.default=e.exports}}]);