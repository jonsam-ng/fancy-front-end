<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>30 分钟看懂 React 框架原理 | Fancy Front End</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <meta name="description" content="前端源码阅读栈，精读 React、Vue3 源码">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="前端源码,React源码,Vue源码,Vu3源码,Webpack源码">
    <meta name="theme-color" content="#3CB982">
    
    <link rel="preload" href="/assets/css/0.styles.e2349a00.css" as="style"><link rel="preload" href="/assets/js/app.eb21b6ee.js" as="script"><link rel="preload" href="/assets/js/2.01e091c2.js" as="script"><link rel="preload" href="/assets/js/45.3973ea4b.js" as="script"><link rel="preload" href="/assets/js/4.54e60667.js" as="script"><link rel="preload" href="/assets/js/12.71337abb.js" as="script"><link rel="preload" href="/assets/js/10.ac472f43.js" as="script"><link rel="preload" href="/assets/js/11.c50183f9.js" as="script"><link rel="preload" href="/assets/js/8.7cbef5ec.js" as="script"><link rel="preload" href="/assets/js/5.f620477b.js" as="script"><link rel="prefetch" href="/assets/js/100.8081075e.js"><link rel="prefetch" href="/assets/js/101.943ea683.js"><link rel="prefetch" href="/assets/js/102.11c8554c.js"><link rel="prefetch" href="/assets/js/103.c2780521.js"><link rel="prefetch" href="/assets/js/104.81994794.js"><link rel="prefetch" href="/assets/js/105.f987244b.js"><link rel="prefetch" href="/assets/js/106.235a578e.js"><link rel="prefetch" href="/assets/js/107.94cdbb18.js"><link rel="prefetch" href="/assets/js/108.3a80cb29.js"><link rel="prefetch" href="/assets/js/109.8884be03.js"><link rel="prefetch" href="/assets/js/110.89ab5eb2.js"><link rel="prefetch" href="/assets/js/111.355b1782.js"><link rel="prefetch" href="/assets/js/112.34671c87.js"><link rel="prefetch" href="/assets/js/113.0cca0902.js"><link rel="prefetch" href="/assets/js/114.01616168.js"><link rel="prefetch" href="/assets/js/115.4915c0b5.js"><link rel="prefetch" href="/assets/js/116.ef93855a.js"><link rel="prefetch" href="/assets/js/117.e3526ed0.js"><link rel="prefetch" href="/assets/js/118.7d52a4ea.js"><link rel="prefetch" href="/assets/js/119.a4bb17bb.js"><link rel="prefetch" href="/assets/js/120.135aa6ea.js"><link rel="prefetch" href="/assets/js/121.86c35c15.js"><link rel="prefetch" href="/assets/js/122.1452986d.js"><link rel="prefetch" href="/assets/js/123.0181b553.js"><link rel="prefetch" href="/assets/js/124.edc508f8.js"><link rel="prefetch" href="/assets/js/125.46d932c1.js"><link rel="prefetch" href="/assets/js/126.17e05a12.js"><link rel="prefetch" href="/assets/js/127.98159dfe.js"><link rel="prefetch" href="/assets/js/128.9aaa5bc6.js"><link rel="prefetch" href="/assets/js/129.26bed928.js"><link rel="prefetch" href="/assets/js/13.292db5f6.js"><link rel="prefetch" href="/assets/js/130.9f74c846.js"><link rel="prefetch" href="/assets/js/131.d6ef0885.js"><link rel="prefetch" href="/assets/js/132.1d9ee075.js"><link rel="prefetch" href="/assets/js/133.2b23ed7b.js"><link rel="prefetch" href="/assets/js/134.c47e8a23.js"><link rel="prefetch" href="/assets/js/135.2aeb3426.js"><link rel="prefetch" href="/assets/js/136.0169c47b.js"><link rel="prefetch" href="/assets/js/137.70cdfc24.js"><link rel="prefetch" href="/assets/js/138.e54160ee.js"><link rel="prefetch" href="/assets/js/139.9a6d1932.js"><link rel="prefetch" href="/assets/js/14.54d2636a.js"><link rel="prefetch" href="/assets/js/140.ddabaeca.js"><link rel="prefetch" href="/assets/js/141.35844ecc.js"><link rel="prefetch" href="/assets/js/142.4ccdb5e4.js"><link rel="prefetch" href="/assets/js/143.37a7f36e.js"><link rel="prefetch" href="/assets/js/144.95ff6a63.js"><link rel="prefetch" href="/assets/js/145.9899e545.js"><link rel="prefetch" href="/assets/js/146.6865658b.js"><link rel="prefetch" href="/assets/js/147.2a55d18a.js"><link rel="prefetch" href="/assets/js/148.f3aab640.js"><link rel="prefetch" href="/assets/js/149.57b565a0.js"><link rel="prefetch" href="/assets/js/15.81d908ff.js"><link rel="prefetch" href="/assets/js/150.3f7143ae.js"><link rel="prefetch" href="/assets/js/151.5981cf9e.js"><link rel="prefetch" href="/assets/js/152.a3428a7b.js"><link rel="prefetch" href="/assets/js/153.0f0b339d.js"><link rel="prefetch" href="/assets/js/154.39f3b522.js"><link rel="prefetch" href="/assets/js/155.13c8170a.js"><link rel="prefetch" href="/assets/js/156.ccb66614.js"><link rel="prefetch" href="/assets/js/157.4b8bce50.js"><link rel="prefetch" href="/assets/js/158.6476dd1c.js"><link rel="prefetch" href="/assets/js/159.b261a009.js"><link rel="prefetch" href="/assets/js/16.68d8e787.js"><link rel="prefetch" href="/assets/js/160.e501007d.js"><link rel="prefetch" href="/assets/js/161.d3f56d3d.js"><link rel="prefetch" href="/assets/js/162.f8590797.js"><link rel="prefetch" href="/assets/js/163.91fe4509.js"><link rel="prefetch" href="/assets/js/164.6e92f3f4.js"><link rel="prefetch" href="/assets/js/165.56868a39.js"><link rel="prefetch" href="/assets/js/166.83812a3b.js"><link rel="prefetch" href="/assets/js/167.4b528df4.js"><link rel="prefetch" href="/assets/js/168.f2b151fb.js"><link rel="prefetch" href="/assets/js/169.cb2ee128.js"><link rel="prefetch" href="/assets/js/17.895175dc.js"><link rel="prefetch" href="/assets/js/170.63b574e9.js"><link rel="prefetch" href="/assets/js/171.ad38a311.js"><link rel="prefetch" href="/assets/js/172.b592b97e.js"><link rel="prefetch" href="/assets/js/173.302ef08b.js"><link rel="prefetch" href="/assets/js/174.d71ad1a3.js"><link rel="prefetch" href="/assets/js/175.2617c860.js"><link rel="prefetch" href="/assets/js/176.19a67035.js"><link rel="prefetch" href="/assets/js/177.75aab37d.js"><link rel="prefetch" href="/assets/js/178.b2773712.js"><link rel="prefetch" href="/assets/js/179.6a34b45f.js"><link rel="prefetch" href="/assets/js/18.736b781d.js"><link rel="prefetch" href="/assets/js/180.d447fc48.js"><link rel="prefetch" href="/assets/js/181.d6b96886.js"><link rel="prefetch" href="/assets/js/182.42c2bcd5.js"><link rel="prefetch" href="/assets/js/183.a6256a82.js"><link rel="prefetch" href="/assets/js/184.8a036f5a.js"><link rel="prefetch" href="/assets/js/185.811d5831.js"><link rel="prefetch" href="/assets/js/186.6436a583.js"><link rel="prefetch" href="/assets/js/187.4bcf94a3.js"><link rel="prefetch" href="/assets/js/188.33f39bd6.js"><link rel="prefetch" href="/assets/js/189.c1b90840.js"><link rel="prefetch" href="/assets/js/19.504bd141.js"><link rel="prefetch" href="/assets/js/20.e526fb51.js"><link rel="prefetch" href="/assets/js/21.8375d39e.js"><link rel="prefetch" href="/assets/js/22.0e15b626.js"><link rel="prefetch" href="/assets/js/23.83bcc15c.js"><link rel="prefetch" href="/assets/js/24.3df554ce.js"><link rel="prefetch" href="/assets/js/25.6c56da2b.js"><link rel="prefetch" href="/assets/js/26.76154857.js"><link rel="prefetch" href="/assets/js/27.155dbcb4.js"><link rel="prefetch" href="/assets/js/28.7178e96c.js"><link rel="prefetch" href="/assets/js/29.f7337396.js"><link rel="prefetch" href="/assets/js/3.50570587.js"><link rel="prefetch" href="/assets/js/30.191545d3.js"><link rel="prefetch" href="/assets/js/31.b6a0fe90.js"><link rel="prefetch" href="/assets/js/32.18cebeab.js"><link rel="prefetch" href="/assets/js/33.146782c3.js"><link rel="prefetch" href="/assets/js/34.c08af9cb.js"><link rel="prefetch" href="/assets/js/35.ea730de0.js"><link rel="prefetch" href="/assets/js/36.11aba0b0.js"><link rel="prefetch" href="/assets/js/37.0fd8e20a.js"><link rel="prefetch" href="/assets/js/38.2cde6902.js"><link rel="prefetch" href="/assets/js/39.07c230cc.js"><link rel="prefetch" href="/assets/js/40.e4fcccd0.js"><link rel="prefetch" href="/assets/js/41.5f96c201.js"><link rel="prefetch" href="/assets/js/42.e5023440.js"><link rel="prefetch" href="/assets/js/43.2cfdc8d9.js"><link rel="prefetch" href="/assets/js/44.37f32c52.js"><link rel="prefetch" href="/assets/js/46.87541312.js"><link rel="prefetch" href="/assets/js/47.04f0011f.js"><link rel="prefetch" href="/assets/js/48.1151f311.js"><link rel="prefetch" href="/assets/js/49.6830fb0c.js"><link rel="prefetch" href="/assets/js/50.84b34574.js"><link rel="prefetch" href="/assets/js/51.840f38c4.js"><link rel="prefetch" href="/assets/js/52.3dbda6e7.js"><link rel="prefetch" href="/assets/js/53.7f0a8896.js"><link rel="prefetch" href="/assets/js/54.5d7f6427.js"><link rel="prefetch" href="/assets/js/55.86c7b544.js"><link rel="prefetch" href="/assets/js/56.49a27b9a.js"><link rel="prefetch" href="/assets/js/57.287f9e58.js"><link rel="prefetch" href="/assets/js/58.40a49fdb.js"><link rel="prefetch" href="/assets/js/59.91487422.js"><link rel="prefetch" href="/assets/js/6.8880bb8c.js"><link rel="prefetch" href="/assets/js/60.8dfd58ee.js"><link rel="prefetch" href="/assets/js/61.7b4874b9.js"><link rel="prefetch" href="/assets/js/62.d83f3691.js"><link rel="prefetch" href="/assets/js/63.1237a900.js"><link rel="prefetch" href="/assets/js/64.1f096a25.js"><link rel="prefetch" href="/assets/js/65.809d988d.js"><link rel="prefetch" href="/assets/js/66.43c1e5f9.js"><link rel="prefetch" href="/assets/js/67.24ab137d.js"><link rel="prefetch" href="/assets/js/68.7b0346b5.js"><link rel="prefetch" href="/assets/js/69.2008c989.js"><link rel="prefetch" href="/assets/js/7.0c293177.js"><link rel="prefetch" href="/assets/js/70.e8cf3232.js"><link rel="prefetch" href="/assets/js/71.d661943d.js"><link rel="prefetch" href="/assets/js/72.e67a47a3.js"><link rel="prefetch" href="/assets/js/73.87f1db52.js"><link rel="prefetch" href="/assets/js/74.ac67cd0d.js"><link rel="prefetch" href="/assets/js/75.e25ebf69.js"><link rel="prefetch" href="/assets/js/76.a7222468.js"><link rel="prefetch" href="/assets/js/77.ffb71305.js"><link rel="prefetch" href="/assets/js/78.72c00bee.js"><link rel="prefetch" href="/assets/js/79.66ec368e.js"><link rel="prefetch" href="/assets/js/80.8792d3d7.js"><link rel="prefetch" href="/assets/js/81.49d3731a.js"><link rel="prefetch" href="/assets/js/82.fbe09e61.js"><link rel="prefetch" href="/assets/js/83.220a02bb.js"><link rel="prefetch" href="/assets/js/84.4b722410.js"><link rel="prefetch" href="/assets/js/85.f83d2db9.js"><link rel="prefetch" href="/assets/js/86.17b19d53.js"><link rel="prefetch" href="/assets/js/87.37568307.js"><link rel="prefetch" href="/assets/js/88.d7cc6612.js"><link rel="prefetch" href="/assets/js/89.ffb378d0.js"><link rel="prefetch" href="/assets/js/9.2a7e5bdc.js"><link rel="prefetch" href="/assets/js/90.02c91127.js"><link rel="prefetch" href="/assets/js/91.c22d9224.js"><link rel="prefetch" href="/assets/js/92.c79d457a.js"><link rel="prefetch" href="/assets/js/93.33a03732.js"><link rel="prefetch" href="/assets/js/94.c73ddbbc.js"><link rel="prefetch" href="/assets/js/95.a5151497.js"><link rel="prefetch" href="/assets/js/96.b8f204d2.js"><link rel="prefetch" href="/assets/js/97.d7ddaa6f.js"><link rel="prefetch" href="/assets/js/98.49dbda5e.js"><link rel="prefetch" href="/assets/js/99.d14f43ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2349a00.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Fancy Front End" class="logo"> <span class="site-name can-hide">Fancy Front End</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/react/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/plan/" class="sidebar-link">plan 计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调和（Reconciliation）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调度器（Scheduler）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新器（Updater）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>渲染器（Render）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hooks原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/summary/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/summary/bitOperation/" class="sidebar-link">位运算初探</a></li><li><a href="/react/summary/first-render/" class="sidebar-link">React 首次渲染过程</a></li><li><a href="/react/summary/event-listener/" class="sidebar-link">React 中的事件监听机制</a></li><li><a href="/react/summary/10-min-react/" aria-current="page" class="active sidebar-link">30 分钟看懂 React 框架原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#reactdomhostconfig" class="sidebar-link">ReactDOMHostConfig</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#updatecontainer" class="sidebar-link">updateContainer</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#scheduleupdateonfiber" class="sidebar-link">scheduleUpdateOnFiber</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#ensurerootisscheduled" class="sidebar-link">ensureRootIsScheduled</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#schedulesynccallback-和-schedulecallback" class="sidebar-link">scheduleSyncCallback 和 scheduleCallback</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performsyncworkonroot" class="sidebar-link">performSyncWorkOnRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performconcurrentworkonroot" class="sidebar-link">performConcurrentWorkOnRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#renderrootsync" class="sidebar-link">renderRootSync</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#renderrootconcurrent" class="sidebar-link">renderRootConcurrent</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#workloopsync" class="sidebar-link">workLoopSync</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#workloopconcurrent" class="sidebar-link">workLoopConcurrent</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performunitofwork" class="sidebar-link">performUnitOfWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#beginwork" class="sidebar-link">beginWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#completeunitofwork" class="sidebar-link">completeUnitOfWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#completework" class="sidebar-link">completeWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#commitroot" class="sidebar-link">commitRoot</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React源码漂流记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-e1efabd0><div class="articleInfo" data-v-e1efabd0><ul class="breadcrumbs" data-v-e1efabd0><li data-v-e1efabd0><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-e1efabd0></a></li> <li data-v-e1efabd0><a href="/categories/?category=react" title="分类" data-v-e1efabd0>react</a></li><li data-v-e1efabd0><a href="/categories/?category=%E6%80%BB%E7%BB%93" title="分类" data-v-e1efabd0>总结</a></li></ul> <div class="info" data-v-e1efabd0><div title="作者" class="author iconfont icon-touxiang" data-v-e1efabd0><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-e1efabd0>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-e1efabd0><a href="javascript:;" data-v-e1efabd0>2022-04-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">30 分钟看懂 React 框架原理<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>React17</span><span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>以调和器为核心</span></div> <!----> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <p></p><div class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#reactdomhostconfig">ReactDOMHostConfig</a></li><li><a href="#updatecontainer">updateContainer</a></li><li><a href="#scheduleupdateonfiber">scheduleUpdateOnFiber</a><ul><li><a href="#一个闭环">一个闭环</a></li><li><a href="#更新的来源">更新的来源</a></li></ul></li><li><a href="#ensurerootisscheduled">ensureRootIsScheduled</a><ul><li><a href="#discreteeventpriority-和-continuouseventpriority">DiscreteEventPriority 和 ContinuousEventPriority</a></li><li><a href="#schedulemicrotask-与-queuemicrotask">scheduleMicrotask 与 queueMicrotask</a></li></ul></li><li><a href="#schedulesynccallback-和-schedulecallback">scheduleSyncCallback 和 scheduleCallback</a><ul><li><a href="#schedulesynccallback-和-flushsynccallbacks">scheduleSyncCallback 和 flushSyncCallbacks</a></li><li><a href="#schedulecallback">scheduleCallback</a></li></ul></li><li><a href="#performsyncworkonroot">performSyncWorkOnRoot</a></li><li><a href="#performconcurrentworkonroot">performConcurrentWorkOnRoot</a><ul><li><a href="#finishconcurrentrender">finishConcurrentRender</a></li></ul></li><li><a href="#renderrootsync">renderRootSync</a></li><li><a href="#renderrootconcurrent">renderRootConcurrent</a><ul><li><a href="#handleerror">handleError</a></li></ul></li><li><a href="#workloopsync">workLoopSync</a></li><li><a href="#workloopconcurrent">workLoopConcurrent</a></li><li><a href="#performunitofwork">performUnitOfWork</a></li><li><a href="#beginwork">beginWork</a></li><li><a href="#completeunitofwork">completeUnitOfWork</a></li><li><a href="#completework">completeWork</a></li><li><a href="#commitroot">commitRoot</a></li></ul></div><p></p> <h2 id="reactdomhostconfig"><a href="#reactdomhostconfig" class="header-anchor">#</a> ReactDOMHostConfig</h2> <p>下面我们先探究一下生产更新的来源，主要分析 updateContainer 和 scheduleUpdateOnFiber 两个函数。</p> <h2 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h2> <p>更新是如何开始的？我们首先从 updateContainer 的调用来源开始追溯。</p> <p>调用 updateContainer 的函数包括： legacyRenderSubtreeIntoContainer、ReactDOMRoot.prototype.render、ReactDOMRoot.prototype.unmount、hydrateRoot、scheduleRoot。ReactDOMRoot 由 ReactDOM.createRoot 创建。scheduleRoot 在  <code>src/react/packages/react-reconciler/src/ReactFiberHotReloading.new.js</code>  文件中。</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>// 应用层 API
legacyRenderSubtreeIntoContainer &lt;- ReactDOM.hydrate
                                 &lt;- ReactDOM.render
                                 &lt;- ReactDOM.unmountComponentAtNode
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由上面的分析可以看出，updateContainer 主要来源于应用层 API 的调用，这种调用生产了更新渲染的需求。那么 updateContainer 主要做了什么？</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  <span class="token comment">// 待挂载的组件</span>
  element<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token comment">// 挂载容器</span>
  container<span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">Function</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// 获取 RootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新 container 的 context 信息</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建一个更新</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Caution: React DevTools currently depends on this property</span>
  <span class="token comment">// being called &quot;element&quot;.</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>

  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将新建的更新入栈</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 请求一次调度更新</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">entangleTransitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>updateContainer 关键功能如下：</p> <ul><li>继续完善 FiberRoot 信息：context、pendingContext。</li> <li>初始化创建一个更新对象，添加属性 payload、callback，并且将更新加入更新队列。</li> <li>调用 scheduleUpdateOnFiber，(向调度器) 发出一次调度的请求。</li></ul> <div class="custom-block tip"><p class="custom-block-title">扩展</p> <ol><li>createUpdate 创建更新在组件的生命周期或者用户行为中也会产生，如函数式组件（FC）中的 setState、useContext 的 dispatchAction、类组件的 this.setState 中，两种不同之处在于前者是应用层面的调用，后者则是组件层面的调用。</li> <li>注意，scheduleUpdateOnFiber 的调度请求并不一定经过调度器，同步更新可能会跳过调度器的调度，后面会说明这一点。</li></ol></div> <h2 id="scheduleupdateonfiber"><a href="#scheduleupdateonfiber" class="header-anchor">#</a> scheduleUpdateOnFiber</h2> <p>在 updateContainer 中，调用了 scheduleUpdateOnFiber 以在 fiber（此处指的是 RootFiber） 上调度一次更新，那么调度更新是如何在 fiber 上展开的呢？</p> <p>首先来分析一下代码：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// Lanes that were updated during the render phase (*not* an interleaved event).</span>
<span class="token keyword">let</span> workInProgressRootRenderPhaseUpdatedLanes<span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
<span class="token comment">// Whether to root completed, errored, suspended, etc.</span>
<span class="token keyword">let</span> workInProgressRootExitStatus<span class="token operator">:</span> RootExitStatus <span class="token operator">=</span> RootIncomplete<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">,</span> b<span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">)</span><span class="token operator">:</span> Lanes <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">|</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token comment">//  RootFiber</span>
  fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// 调度优先级</span>
  lane<span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  eventTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查嵌套更新，防止死循环</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 fiber 向上收集 lanes，root：FiberRoot = fiber.stateNode。对于 updateContainer 来说，这里 fiber 就是 RootFiber。</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// FiberRoot 不存在，说明 FiberTree 可能已经被废弃，不用更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Mark that the root has a pending update.</span>
  <span class="token comment">// 标记 root 即将更新，root.pendingLanes |= lane</span>
  <span class="token function">markRootUpdated</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果当前已经是 Render 阶段，且 root 是待处理的 HostRoot，这时跳过渲染的调度请求，并且追踪 lane，加入到 Render 阶段的 lanes，就在在当前调度的回调中参与渲染，或者等待下次渲染。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes <span class="token operator">&amp;&amp;</span>
    root <span class="token operator">===</span> workInProgressRoot
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Track lanes that were updated during the render phase</span>
    <span class="token comment">// 收集当前的 lane 到 workInProgressRootRenderPhaseUpdatedLanes，表示在当前 render 中当前正在渲染的 RootFiber 上的优先级队列。</span>
    workInProgressRootRenderPhaseUpdatedLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
      workInProgressRootRenderPhaseUpdatedLanes<span class="token punctuation">,</span>
      lane<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里是正常的请求渲染调度的流程</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 workInProgressRootExitStatus 为 RootSuspendedWithDelay，则标记 root 为 suspend。这里是处理 suspended 组件。向 root 做标记以在后面的渲染中加以区分。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRootExitStatus <span class="token operator">===</span> RootSuspendedWithDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The root already suspended with a delay, which means this render</span>
        <span class="token comment">// definitely won't finish. Since we have a new update, let's mark it as</span>
        <span class="token comment">// suspended now, right before marking the incoming update. This has the</span>
        <span class="token comment">// effect of interrupting the current render and switching to the update.</span>
        <span class="token comment">// TODO: Make sure this doesn't override pings that happen while we've</span>
        <span class="token comment">// already started rendering.</span>
        <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> workInProgressRootRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 确保 HostRoot （向调度器）发起调度请求，</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      lane <span class="token operator">===</span> SyncLane <span class="token operator">&amp;&amp;</span>
      executionContext <span class="token operator">===</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// Treat `act` as if it's inside `batchedUpdates`, even in legacy mode.</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> ReactCurrentActQueue<span class="token punctuation">.</span>isBatchingLegacy<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是同步更新，context 还是 NoContext 阶段，fiber.mode 不是 ConcurrentMode，且 prd 环境 ReactCurrentActQueue.isBatchingLegacy 为 true</span>
      <span class="token comment">// 在初次加载时重置 workInProgressRootRenderTargetTime 并且 flushSyncCallbacks。</span>
      <span class="token comment">// 只在初始化应用时执行</span>
      <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
      <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
      <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
      <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
      <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
      <span class="token function">resetRenderTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">flushSyncCallbacksOnlyInLegacyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>这个函数的核心功能如下：</p> <ul><li>从 fiber 向父级收集 lanes，并且计算出 HostRoot。</li> <li>调用 ensureRootIsScheduled，确保 HostRoot 发起同步或者异步调度。</li> <li>如果是初次启动应用，执行一些初始化工作。</li></ul> <p>下面我们将以 scheduleUpdateOnFiber 函数作为突破口，一层层的往下追溯，看看 React 的更新具体是怎样的流程，以及更新产生的来源到底是什么？</p> <div class="custom-block warning"><p class="custom-block-title">图注</p> <p>&lt;- 表示代码向下追溯，即前面的函数被后面的函数调用或者使用。&lt;&lt;&lt; 表示省略追溯过程，因为从前面的过程中可以推出。... 表示忽略此过程。</p></div> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>scheduleUpdateOnFiber &lt;- updateDehydratedSuspenseComponent &lt;- updateSuspenseComponent &lt;- attemptEarlyBailoutIfNoScheduledUpdate &lt;- beginWork
                                                                                      &lt;- beginWork
                      &lt;- classComponentUpdater[enqueueSetState、enqueueReplaceState、enqueueForceUpdate] &lt;- adoptClassInstance &lt;- mountIndeterminateComponent &lt;- beginWork
                                                                                                                              &lt;- constructClassInstance &lt;- updateClassComponent &lt;- mountLazyComponent &lt;- beginWork
                                                                                                                                                                                &lt;- beginWork
                                                                                                                                                        &lt;- mountIncompleteClassComponent &lt;- beginWork
                                                                                                        &lt;- callComponentWillMount &lt;- mountClassInstance &lt;- updateClassComponent &lt;- mountLazyComponent &lt;- beginWork
                                                                                                                                                                                &lt;- beginWork
                                                                                                                                                        &lt;- mountIncompleteClassComponent &lt;- beginWork
                                                                                                        &lt;- callComponentWillReceiveProps &lt;- resumeMountClassInstance &lt;- updateClassComponent &lt;&lt;&lt; beginWork
                                                                                                                                         &lt;- updateClassInstance &lt;&lt;&lt; beginWork
                      &lt;- [DEV]forceStoreRerender &lt;- updateStoreInstance &lt;- mountSyncExternalStore ...
                                                                   &lt;- updateSyncExternalStore ...
                                            &lt;- subscribeToStore ...
                      &lt;- [enableCache]refreshCache &lt;- mountRefresh ...
                      &lt;- dispatchReducerAction &lt;- mountReducer &lt;- reducer.dispatch[useReducer]
                      &lt;- dispatchSetState &lt;- useMutableSource &lt;- stateHook.queue.dispatch &lt;- dispatchAction[queue.reducer(state, dispatch)]  &lt;- useState
                                          &lt;- mountState &lt;- HooksDispatcherOnMount.useState &lt;- ReactCurrentDispatcher.current &lt;- useState
                                                        &lt;- mountTransition &lt;- HooksDispatcherOnMount.useTransition &lt;- useTransition
                                                        &lt;- mountDeferredValue &lt;- HooksDispatcherOnMount.useDeferredValue &lt;- useDeferredValue
                      &lt;- updateContainer &lt;&lt;&lt; ReactDOM[hydrate、render、unmountComponentAtNode、createRoot、hydrateRoot、scheduleRoot]
                      &lt;!-- &lt;- attemptSynchronousHydration --&gt;
                      &lt;!-- &lt;- attemptDiscreteHydration --&gt;
                      &lt;!-- &lt;- attemptContinuousHydration --&gt;
                      &lt;!-- &lt;- attemptHydrationAtCurrentPriority --&gt;

beginWork &lt;- workLoopConcurrent &lt;- renderRootConcurrent &lt;- performConcurrentWorkOnRoot &lt;- ensureRootIsScheduled[root.callbackNode] &lt;- scheduleUpdateOnFiber &lt;&lt;&lt; beginWork
          &lt;- performUnitOfWork &lt;- workLoopSync &lt;- renderRootSync &lt;- performConcurrentWorkOnRoot &lt;&lt;&lt; beginWork
                               &lt;- workLoopConcurrent &lt;- renderRootConcurrent &lt;- performConcurrentWorkOnRoot &lt;&lt;&lt; beginWork

commitRoot &lt;- finishConcurrentRender[RootErrored、RootSuspended、RootSuspendedWithDelay、RootCompleted] &lt;- performConcurrentWorkOnRoot
           &lt;- performSyncWorkOnRoot
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>从上面的分析过程，我们可以得出很多重要的信息，总结如下：</p> <h3 id="一个闭环"><a href="#一个闭环" class="header-anchor">#</a> 一个闭环</h3> <p>从上面可以清晰的看出，从 scheduleUpdateOnFiber 往上追溯时，最终追溯到了 beginWork，然后从 beginWork 继续追溯，最终追溯到 scheduleUpdateOnFiber。大致过程如下：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>钩子（生命周期）和事件系统 -&gt; 应用层行为：dispatchSetState、classComponentUpdater、dispatchReducerAction、updateContainer 
-&gt; scheduleUpdateOnFiber -&gt; ensureRootIsScheduled -&gt; performSyncWorkOnRoot、performConcurrentWorkOnRoot 
-&gt; renderRootSync、renderRootConcurrent -&gt; workLoopSync、workLoopConcurrent 
-&gt; performUnitOfWork -&gt; beginWork -&gt; mount、update 组件 -&gt; 调用生命周期函数、响应事件系统 -&gt; commitRoot -&gt; ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>有以下几点需要注意：</p> <ul><li>应用层行为分别可以对应 FC setState、类组件 this.setState、useReducer 的 dispatch 和 ReactDOM 的一系列操作，如 hydrate、render、unmountComponentAtNode、createRoot、hydrateRoot、scheduleRoot。</li> <li>从 ensureRootIsScheduled -&gt; performConcurrentWorkOnRoot 中间还有调度器的调度过程，包括 scheduleSyncCallback 和 scheduleCallback，分别对应同步任务的调度和异步任务的调度。</li> <li>在 performSyncWorkOnRoot、performConcurrentWorkOnRoot 执行之后，有一个 commitRoot 的操作。</li> <li>beginWork -&gt; mount、update 组件 这个过程中涉及的内容较为繁琐，可以参考更新器的部分，本文不在赘述细节。</li> <li>commitRoot 在 performSyncWorkOnRoot（同步渲染）、或者 finishConcurrentRender（异步渲染）中调用。这并不是说在同步渲染中 commitRoot 和后面的 renderRootSync 是同时进行的，而是说 renderRootSync 是同步的，renderRootSync 执行完之后直接就执行了 commitRoot。从只有 finishConcurrentRender，而没有类似于 finishSyncRender 可以印证这一点。</li></ul> <p>一个完整的同步的渲染回调的调用函数栈，可以参考下图：</p> <img src="/assets/img/react-call-stack.png" alt="react-call-stack" data-zoomable=""> <h3 id="更新的来源"><a href="#更新的来源" class="header-anchor">#</a> 更新的来源</h3> <p>更新主要来源于应用层的一些行为：dispatchSetState、classComponentUpdater、dispatchReducerAction、updateContainer 和 ReactDOM 的一系列操作，如 hydrate、render、unmountComponentAtNode、createRoot、hydrateRoot、scheduleRoot。大致包括应用 mount 阶段对 ReactDOM API 调用引起的同步更新，类组件和 FC 状态更新、useReducer 的 dispatch 的调用，以及最新 ConcurrentAPI 如 useTransition、useDeferredValue 等。</p> <p>下面我们从一个更为直接的角度来探究 React 更新的来源。现在我们知道，如果需要更新，则会将更新入栈，我们从这个角度来分析一下，在代码中搜索  <code>enqueueUpdate(</code> ：</p> <p>调用  <code>enqueueUpdate(</code>  主要在如下几个模块：</p> <ul><li>src/react/packages/react-reconciler/src/ReactFiberClassComponent.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberHooks.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberThrow.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</li></ul> <p>然后分析下分别在哪些函数中出现：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>&gt;&gt; ReactFiberClassComponent
classComponentUpdater[enqueueSetState、enqueueReplaceState、enqueueForceUpdate]

&gt;&gt; ReactFiberHooks
dispatchReducerAction
dispatchSetState

&gt;&gt; ReactFiberReconciler
updateContainer

// 以下的 Update 为 ErrorUpdate

&gt;&gt; ReactFiberThrow
markSuspenseBoundaryShouldCapture &lt;- throwException &lt;- handleError &lt;- renderRootSync/renderRootConcurrent

&gt;&gt; ReactFiberWorkLoop
captureCommitPhaseErrorOnRoot &lt;- captureCommitPhaseError &lt;- safelyCallCommitHookLayoutEffectListMount/safelyCallComponentWillUnmount/safelyCallComponentDidMount/safelyAttachRef/safelyDetachRef/safelyCallDestroy/commitBeforeMutationEffects_complete/commitMutationEffects_begin/commitMutationEffects_complete/commitLayoutMountEffects_complete/reappearLayoutEffects_complete/commitPassiveMountEffects_complete
captureCommitPhaseError &lt;&lt;&lt; ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可以看出，与前文的分析基本一致。</p> <p>关于 useTransition、useDeferredValue 可以参考：<a href="https://ithelp.ithome.com.tw/articles/10281124" target="_blank" rel="noopener noreferrer">淺談 React Concurrent Mode &amp; 相關功能 (Fiber、Suspense、useTransition、useDeferredValue)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block tip"><p class="custom-block-title">扩展</p> <ol><li>scheduleUpdateOnFiber 一方面被 updateContainer 这样间接被外部应用层 API 调用，另一方面在组件层面由组件状态更新、context 更新、props 更新等行为在 react 内部调用（可以参考上文 scheduleUpdateOnFiber 调用来源）。</li> <li>checkForNestedUpdates 函数是为了防止行为更新的死循环，因为更新都要经过 scheduleUpdateOnFiber 函数提交调度更新，scheduleUpdateOnFiber 在 react 内部还是外部都会被频繁调用。checkForNestedUpdates 在内部维护变量 nestedUpdateCount 表示在当前的 commit 中 FiberRoot 更新的循环请求次数。</li> <li>关于 react 中常见的位运算，可以参考 <a href="/react/summary/bitOperation">位运算初探</a> 和 <a href="/react/summary/first-render.html#使用位运算提高枚举计算效率">使用位运算提高枚举计算效率</a>。</li> <li>这里判断 root === workInProgressRoot 执行 suspended 组件的一些逻辑是因为，正常情况下这里 workInProgressRoot 应该为 null，只有当前的 FiberRoot 被标记为 workInProgressRoot 再回在这里特殊处理。正常情况下，workInProgressRoot 只有在 prepareFreshStack 函数被赋值为 root 的，而 prepareFreshStack 只有在 renderRootSync、renderRootConcurrent、pingSuspendedRoot 函数中正常执行或者在 performConcurrentWorkOnRoot、performSyncWorkOnRoot 中发生 FatalError 时执行。</li></ol></div> <h2 id="ensurerootisscheduled"><a href="#ensurerootisscheduled" class="header-anchor">#</a> ensureRootIsScheduled</h2> <p>在上面对 scheduleUpdateOnFiber 的分析中，最重要的就是调用 ensureRootIsScheduled，以保证在 fiber 所在的 HostRoot 上调度更新，那么 HostRoot 上是如何继续调度的呢？</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> currentTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>

  <span class="token comment">// Check if any lanes are being starved by other work. If so, mark them as</span>
  <span class="token comment">// expired so we know to work on those next.</span>
  <span class="token comment">// 将饿死的 lanes 标记为超时以一并更新，超时的任务立即执行。</span>
  <span class="token function">markStarvedLanesAsExpired</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine the next lanes to work on, and their priority.</span>
  <span class="token comment">// 计算将要渲染的 lanes</span>
  <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 无需要渲染的 lanes</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Special case: There's nothing to work on.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We use the highest priority lane to represent the priority of the callback.</span>
  <span class="token comment">// 获取 lanes 中优先级最高的 lane 作为 callback 的优先级</span>
  <span class="token keyword">const</span> newCallbackPriority <span class="token operator">=</span> <span class="token function">getHighestPriorityLane</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Check if there's an existing task. We may be able to reuse it.</span>
  <span class="token keyword">const</span> existingCallbackPriority <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackPriority<span class="token punctuation">;</span>
  <span class="token comment">// 由于即将要生成新的 callback，先将现在的 callback 取消掉</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cancel the existing callback. We'll schedule a new one below.</span>
    <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Schedule a new callback.</span>
  <span class="token keyword">let</span> newCallbackNode<span class="token punctuation">;</span>
  <span class="token comment">// 如果是同步更新任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackPriority <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Special case: Sync React callbacks are scheduled on a special</span>
    <span class="token comment">// internal queue</span>
    <span class="token comment">// LegacyRoot 需要单独处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>tag <span class="token operator">===</span> LegacyRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">scheduleLegacySyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 请求同步调度回调 performSyncWorkOnRoot，将该回调加入同步回调队列</span>
      <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsMicrotasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// Flush the queue in a microtask.</span>
     <span class="token comment">//  支持微任务的浏览器不用再请求调度器的回调</span>
     <span class="token function">scheduleMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// In Safari, appending an iframe forces microtasks to run.</span>
       <span class="token comment">// https://github.com/facebook/react/issues/22459</span>
       <span class="token comment">// We don't support running callbacks in the middle of render</span>
       <span class="token comment">// or commit so we need to check against that.</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// It's only safe to do this conditionally because we always</span>
         <span class="token comment">// check for pending work before we exit the task.</span>
         <span class="token comment">// 消费完同步回调队列</span>
         <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Flush the queue in an Immediate task.</span>
      <span class="token comment">// 向调度器请求回调，优先级 ImmediatePriority（立即回调），回调后执行 flushSyncCallbacks 将同步回调队列消费完</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediateSchedulerPriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 同步更新执行完毕，将 newCallbackNode 置为 null，performSyncWorkOnRoot 不会用到此值</span>
    newCallbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> schedulerPriorityLevel<span class="token punctuation">;</span>
    <span class="token comment">// 将 lanes 转化为事件优先级</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 离散事件优先级：ImmediateSchedulerPriority</span>
      <span class="token keyword">case</span> DiscreteEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> ImmediateSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// 连续事件优先级：UserBlockingSchedulerPriority</span>
      <span class="token keyword">case</span> ContinuousEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> UserBlockingSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// 默认事件优先级：NormalSchedulerPriority</span>
      <span class="token keyword">case</span> DefaultEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// Idle 事件优先级：IdleSchedulerPriority</span>
      <span class="token keyword">case</span> IdleEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> IdleSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 向调度器请求相应优先级的异步回调，回调后执行 performConcurrentWorkOnRoot，Scheduler.scheduleCallback 返回调度的 callbackNode(newTask)</span>
    newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>
      schedulerPriorityLevel<span class="token punctuation">,</span>
      <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新 callbackPriority 和 callbackNode 注意，此时异步回调并未执行</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> newCallbackNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p>这个函数有以下几个关键作用：</p> <ul><li>更新 root 的 callbackNode、callbackPriority 属性。</li> <li>同步更新调度：支持微任务的直接在微任务的回调执行 flushSyncCallbacks；调用 scheduleSyncCallback 将同步回调 performSyncWorkOnRoot 推入同步回调队列 syncQueue，并且以 ImmediateSchedulerPriority 的优先级向调度器请求同步回调，回调时执行 flushSyncCallbacks 消费同步队列中所有的同步回调。</li> <li>异步更新调度：根据 nextLanes 计算事件优先级，并且转化为调度优先级，以相应的调度优先级向调度器发起异步回调，回调时执行 performConcurrentWorkOnRoot。</li> <li>注意同步调度中调用了 scheduleSyncCallback、scheduleCallback 两个函数不可混淆，scheduleCallback 只是 Scheduler 提供的一种基于优先级机制的任务（回调）调度手段，performSyncWorkOnRoot 和 performConcurrentWorkOnRoot 才是真正要通过调度执行的任务。同步的任务通过同步回调队列的方式进行了优化处理。scheduleSyncCallback 是将同步的任务加入同步任务队列。调度器不是不可替换的，如果浏览器支持微任务，同步任务的处理就可以交给微任务处理，而不经过调度器。</li></ul> <p>nextLanes 优先级是如何计算的？参见 <a href="/react/reconciliation/lane">Lane 与优先级</a></p> <div class="custom-block tip"><p class="custom-block-title">新知</p> <ul><li>调度更新都是通过 HostRoot 实现的，从 ensureRootIsScheduled 中之传入 root ，而没有传入 fiber 可见 HostRoot 对于 react 中整个调和过程的重要性。</li></ul></div> <h3 id="discreteeventpriority-和-continuouseventpriority"><a href="#discreteeventpriority-和-continuouseventpriority" class="header-anchor">#</a> DiscreteEventPriority 和 ContinuousEventPriority</h3> <ul><li>离散事件：discreteEvent，常见的如：click, keyup, change；</li> <li>用户阻塞事件：userBlocking，常见的如：dragEnter, mouseMove, scroll；</li> <li>连续事件：continuous，常见的如：error, progress, load；</li></ul> <p>更多解析可以参考：<a href="./event-listener">React 中的事件监听机制</a></p> <h3 id="schedulemicrotask-与-queuemicrotask"><a href="#schedulemicrotask-与-queuemicrotask" class="header-anchor">#</a> scheduleMicrotask 与 queueMicrotask</h3> <p>可以看到，如果浏览器支持 queueMicrotask，同步调度就不用经过调度器，而是直接交由微任务处理，这样既减少了 performSyncWorkOnRoot 执行的压力，同时又要比 setTimeout 这样的宏任务更快的执行。queueMicrotask 可以由 Promise 来模拟。queueMicrotask () 方法将微任务排队以调用 callback。</p> <p>什么是 queueMicrotask？</p> <blockquote><p>queueMicrotask adds the function (task) into a queue and each function is executed one by one (<strong>FIFO</strong>) after the current task has completed its work and when there is no other code waiting to be run <strong>before control of the execution context is returned to the browser's event loop</strong>.</p></blockquote> <p>react 中 queueMicrotask 的使用：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> localPromise <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token builtin">Promise</span> <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token builtin">Promise</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> supportsMicrotasks <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> scheduleTimeout<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span>
  <span class="token keyword">typeof</span> setTimeout <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> setTimeout <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> scheduleMicrotask<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span>
  <span class="token keyword">typeof</span> queueMicrotask <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> queueMicrotask
    <span class="token operator">:</span> <span class="token keyword">typeof</span> localPromise <span class="token operator">!==</span> <span class="token string">'undefined'</span>
    <span class="token operator">?</span> callback <span class="token operator">=&gt;</span>
        localPromise
          <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleErrorInNextTick<span class="token punctuation">)</span>
    <span class="token operator">:</span> scheduleTimeout<span class="token punctuation">;</span> <span class="token comment">// TODO: Determine the best fallback here.</span>

<span class="token keyword">function</span> <span class="token function">handleErrorInNextTick</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>了解更多关于微任务可以参考：</p> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide" target="_blank" rel="noopener noreferrer">在 JavaScript 中通过 queueMicrotask () 使用微任务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.freecodecamp.org/news/queuemicrotask/" target="_blank" rel="noopener noreferrer">An Introduction to JavaScript's queueMicrotask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://caniuse.com/?search=queueMicrotask" target="_blank" rel="noopener noreferrer">caniuse: queueMicrotask API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="schedulesynccallback-和-schedulecallback"><a href="#schedulesynccallback-和-schedulecallback" class="header-anchor">#</a> scheduleSyncCallback 和 scheduleCallback</h2> <p>在上面对 ensureRootIsScheduled 的分析中我们知道，ensureRootIsScheduled 对同步任务和异步任务分别进行了同步调度和异步调度，分别调用 scheduleSyncCallback 和 scheduleCallback，那么具体同步调度和异步调度是如何进行的呢？</p> <h3 id="schedulesynccallback-和-flushsynccallbacks"><a href="#schedulesynccallback-和-flushsynccallbacks" class="header-anchor">#</a> scheduleSyncCallback 和 flushSyncCallbacks</h3> <p>scheduleSyncCallback 维护一个同步更新的任务队列，调用 flushSyncCallbacks 可全数消费任务任务中的所有任务。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberSyncTaskQueue.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> SchedulerCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Push this callback into an internal queue. We'll flush these either in</span>
  <span class="token comment">// the next tick, or earlier if something calls `flushSyncCallbackQueue`.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    syncQueue <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Push onto existing queue. Don't need to schedule a callback because</span>
    <span class="token comment">// we already scheduled one when we created the queue.</span>
    syncQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// isFlushingSyncQueue 是 syncQueue 的互斥锁，消费 callbacks 是一个互斥操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushingSyncQueue <span class="token operator">&amp;&amp;</span> syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent re-entrance.</span>
    isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousUpdatePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> queue <span class="token operator">=</span> syncQueue<span class="token punctuation">;</span>
      <span class="token comment">// TODO: Is this necessary anymore? The only user code that runs in this</span>
      <span class="token comment">// queue is in the render or commit phases.</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// flush syncQueue，每个 callback 可以返回一个新的 callback</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> callback <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
          callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>isSync<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 重置 syncQueue</span>
      syncQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      includesLegacySyncCallbacks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If something throws, leave the remaining callbacks on the queue.</span>
      <span class="token comment">// 如果syncQueue 中每个 RootCallback 发生了错误，则跳过此项</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        syncQueue <span class="token operator">=</span> syncQueue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Resume flushing in the next tick</span>
      <span class="token comment">// 调度在下一个同步调度中继续执行</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediatePriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousUpdatePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>这两个函数有如下关键作用：</p> <ul><li>维护同步回调的 syncQueue，以在同步回调到来时 flush syncQueue。</li></ul> <p>更多分析，请参考 <a href="/react/summary/first-render.html#flushsync">React 首次渲染过程</a> 中的 flushSyncCallbacks 函数分析。</p> <h3 id="schedulecallback"><a href="#schedulecallback" class="header-anchor">#</a> scheduleCallback</h3> <p>这部分会与调度器交互，在 react 中，调度器是一个单独的模块，这里不再展开。现在需要知道的是，调度器会根据各种异步任务的优先级选择高优先级的任务进行回调，回调中执行 performSyncWorkOnRoot。</p> <p>调度器详细可以参考<a href="/react/scheduler">调度器</a>章节内容。</p> <h2 id="performsyncworkonroot"><a href="#performsyncworkonroot" class="header-anchor">#</a> performSyncWorkOnRoot</h2> <p>从上面的分析中，我们已经知道了调度器同步调度的回调（可以不通过调度器）是由 performSyncWorkOnRoot 函数来处理的，下面我们来具体探究下这个函数：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// This is the entry point for synchronous tasks that don't go</span>
<span class="token comment">// through Scheduler</span>
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果当前是 Render 阶段或者 Commit 阶段就报错，因为此时应该还在 Batch 阶段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Should not already be working.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 进入 Render 阶段前，先把 effects 和 callbacks 都消费掉。</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取即将渲染的 lanes</span>
  <span class="token keyword">let</span> lanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果 lanes 中不包含 SyncLane，这说明没有同步的任务需要 renderRootSync，返回 ensureRootIsScheduled 重新调度一次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span>lanes<span class="token punctuation">,</span> SyncLane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// There's no remaining sync work left.</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 同步的 render HostRoot，返回 workInProgressRootExitStatus 表示退出时执行的状态，</span>
  <span class="token comment">// 包括 RootIncomplete、RootFatalErrored、RootErrored、RootSuspended、RootSuspendedWithDelay、RootCompleted</span>
  <span class="token keyword">let</span> exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果发生普通错误，重试同步渲染，最多重试 50 次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>tag <span class="token operator">!==</span> LegacyRoot <span class="token operator">&amp;&amp;</span> exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If something threw an error, try rendering one more time. We'll render</span>
    <span class="token comment">// synchronously to block concurrent data mutations, and we'll includes</span>
    <span class="token comment">// all pending updates are included. If it still fails after the second</span>
    <span class="token comment">// attempt, we'll give up and commit the resulting tree.</span>
    <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
      exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果发生了致命错误，重置到非错误的状态，将 HostRoot 标记为 suspend 并且重新调度一次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We now have a consistent tree. Because this is a sync render, we</span>
  <span class="token comment">// will commit it even if something suspended.</span>
  <span class="token comment">// 将渲染后的 RootFiber 和 lanes 更新到 HostRoot 上</span>
  <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  <span class="token comment">// 提交 HostRoot 上的更新，通知调度器在帧尾 yield 一次，浏览器重绘。</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Before exiting, make sure there's a callback scheduled for the next</span>
  <span class="token comment">// pending level.</span>
  <span class="token comment">// 保证每次 renderSync 之后，调度不会闲置</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>分析一下这个函数：</p> <ul><li>flushPassiveEffects 中主要调用 flushSyncCallbacks、commitPassiveUnmountEffects、commitPassiveMountEffects 这三个函数。调用这个函数的目的是什么？我们注意到， performSyncWorkOnRoot 会随着 scheduleSyncCallback 的调用而被执行，因此在 performSyncWorkOnRoot 执行时，很可能又有新的同步任务加入到同步回调队列中，所以为了提高同步渲染的效率，同时满足同步任务今早执行的目的，在 renderRootSync 之前，重新消费 SyncCallbacks。</li> <li>调用 renderRootSync 渲染合同更新。返回一个退出状态，如果发生普通错误，采取重试策略；如果发生了致命错误，则采取重置策略。即使发生了普通的错误，本次 render 仍然被 commit，除非发生了 致命的错误，将抛出一个错误。</li> <li>commitRoot 需要调度器的支持，需要调度器在 raf 的帧的末尾提交浏览器绘制。</li> <li>performSyncWorkOnRoot 中任何情况的退出都要调用 ensureRootIsScheduled，保证调度不会被闲置。</li> <li>performSyncWorkOnRoot 可以不通过 Scheduler 的调度。</li></ul> <p>这个函数的关键作用如下：</p> <ul><li>调用 renderRootSync 同步渲染更新。</li> <li>普通错误和致命错误的处理。</li> <li>调用 commitRoot 提交 HostRoot 上的更新，触发浏览器 paint。</li></ul> <h2 id="performconcurrentworkonroot"><a href="#performconcurrentworkonroot" class="header-anchor">#</a> performConcurrentWorkOnRoot</h2> <p>在上面的分析中，我们知道调度器异步任务调度的回调是由 performConcurrentWorkOnRoot 来处理的，下面我们具体来看下 performConcurrentWorkOnRoot 这个函数，并且与 performSyncWorkOnRoot 进行对比。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// If two updates are scheduled within the same event, we should treat their</span>
<span class="token comment">// event times as simultaneous, even if the actual clock time has advanced</span>
<span class="token comment">// between the first and second call.</span>
<span class="token keyword">let</span> currentEventTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> NoTimestamp<span class="token punctuation">;</span>

<span class="token comment">// This is the entry point for every concurrent task, i.e. anything that</span>
<span class="token comment">// goes through Scheduler.</span>
<span class="token keyword">function</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Since we know we're in a React event, we can clear the current</span>
  <span class="token comment">// event time. The next update will compute a new event time.</span>
  currentEventTime <span class="token operator">=</span> NoTimestamp<span class="token punctuation">;</span>
  currentEventTransitionLane <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token comment">// 如果当前是 Render 阶段或者 Commit 阶段就报错，因为当前应该还在 Batch 阶段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Should not already be working.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Flush any pending passive effects before deciding which lanes to work on,</span>
  <span class="token comment">// in case they schedule additional work.</span>
  <span class="token keyword">const</span> originalCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>
  <span class="token comment">// 在 RenderConcurrent 之前再次消费完 callbacks 和 effects。</span>
  <span class="token keyword">const</span> didFlushPassiveEffects <span class="token operator">=</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>didFlushPassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Something in the passive effect phase may have canceled the current task.</span>
    <span class="token comment">// Check if the task node for this root was changed.</span>
    <span class="token comment">// 检查 flushPassiveEffects 之后 callbackNode 是否改变，如果变化了，舍弃之后的渲染工作，因为新的调度已经来临</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>callbackNode <span class="token operator">!==</span> originalCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The current task was canceled. Exit. We don't need to call</span>
      <span class="token comment">// `ensureRootIsScheduled` because the check above implies either that</span>
      <span class="token comment">// there's a new task, or that there's no remaining work on this root.</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Current task was not canceled. Continue.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Determine the next lanes to work on, using the fields stored</span>
  <span class="token comment">// on the root.</span>
  <span class="token comment">// 计算当前要渲染的 lanes</span>
  <span class="token keyword">let</span> lanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Defensive coding. This is never expected to happen.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We disable time-slicing in some cases: if the work has been CPU-bound</span>
  <span class="token comment">// for too long (&quot;expired&quot; work, to prevent starvation), or we're in</span>
  <span class="token comment">// sync-updates-by-default mode.</span>
  <span class="token comment">// 判断是否要进行时间切片，这决定是改用同步 Render 还是继续异步 Render</span>
  <span class="token comment">// 包含有 Blocking 优先级的 lane 的任务，或者包含有过时 line 的任务要改为同步 Render </span>
  <span class="token keyword">const</span> shouldTimeSlice <span class="token operator">=</span>
    <span class="token operator">!</span><span class="token function">includesBlockingLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">includesExpiredLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>disableSchedulerTimeoutInWorkLoop <span class="token operator">||</span> <span class="token operator">!</span>didTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> exitStatus <span class="token operator">=</span> shouldTimeSlice
    <span class="token operator">?</span> <span class="token function">renderRootConcurrent</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果 Render 的结果不是 RootIncomplete，说明出现了异常情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">!==</span> RootIncomplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If something threw an error, try rendering one more time. We'll</span>
      <span class="token comment">// render synchronously to block concurrent data mutations, and we'll</span>
      <span class="token comment">// includes all pending updates are included. If it still fails after</span>
      <span class="token comment">// the second attempt, we'll give up and commit the resulting tree.</span>
      <span class="token comment">// 如果是普通错误，重试若干次</span>
      <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
        exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
      <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if this render may have yielded to a concurrent event, and if so,</span>
    <span class="token comment">// confirm that any newly rendered stores are consistent.</span>
    <span class="token keyword">const</span> renderWasConcurrent <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">includesBlockingLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      renderWasConcurrent <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">isRenderConsistentWithExternalStores</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// A store was mutated in an interleaved event. Render again,</span>
      <span class="token comment">// synchronously, to block further mutations.</span>
      exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We need to check again if something threw</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
          exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// We assume the tree is now consistent because we didn't yield to any</span>
          <span class="token comment">// concurrent events.</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
        <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We now have a consistent tree. The next step is either to commit it,</span>
    <span class="token comment">// or, if something suspended, wait to commit it after a timeout.</span>
    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
    <span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 完成 Render 之后，重新发起一次调度，以保证调度不会被中断</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果新的新的调度节点将仍然发生在相同的 HostRoot，那就不用等调度器的调度，直接继续 performConcurrentWorkOnRoot</span>
  <span class="token comment">// 注意：ensureRootIsScheduled 会产生一个 newCallbackNode，更新 root.callbackNode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>callbackNode <span class="token operator">===</span> originalCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The task node scheduled for this root is the same one that's</span>
    <span class="token comment">// currently executed. Need to return a continuation.</span>
    <span class="token keyword">return</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><ul><li>currentEventTime 在 scheduleUpdateOnFiber 和 createUpdate 之前生成，即创建更新时生成，到 performConcurrentWorkOnRoot 被重置。每个 update 对象中有 eventTime。 </li> <li>performConcurrentWorkOnRoot 必须通过 Scheduler 的调度才有机会执行。这与 performSyncWorkOnRoot 有所不同。</li> <li>从整体来看，performSyncWorkOnRoot 和 performConcurrentWorkOnRoot 流程是相似的，包括 executionContext 的判断、调用 renderRoot、错误判断等。</li> <li>在 RenderConcurrent 之前再次消费完 callbacks 和 effects，原因是为了节省调度资源，同时保证更新被尽快的处理。当然，这里有一个细节，如果在 消费完 callbacks 和 effects 的过程中，root.callbackNode 发生了变化，则舍弃当前的 RenderRoot 等后续流程，因为新的调度即将来临。之所以舍弃当前的调度是因为，新的任务具有更高的优先级或者当前的调度已经没有任务可执行了。</li> <li>在 RenderRoot 之前，仍然对 lanes 做了判断，如果 lanes 中有 blocking 优先级的任务或者过时的任务（过时的任务具有立即执行的优先级）就会使用同步渲染，没有上述的情况才会使用异步渲染。同步渲染和异步渲染分别调用 renderRootSync 和 renderRootConcurrent 执行。</li> <li>在错误处理方面，对待普通的错误容忍度还是比较高的，recoverFromConcurrentError 将对错误执行之多 50 次的重试，注意，重试时是以 renderRootSync 即同步渲染执行的。</li> <li>在 RenderRoot 之后，无论错误与否，都需要调用 ensureRootIsScheduled 以保证调度不会被闲置。由于异步渲染需要调度器调度的时间相对于同步渲染要长，这里做了一个优化处理，如果预知到新的调度仍然会出现在同一个 HostRoot 上，就可以直接继续调用自身以继续完成 HostRoot 上的渲染任务。</li></ul> <h3 id="finishconcurrentrender"><a href="#finishconcurrentrender" class="header-anchor">#</a> finishConcurrentRender</h3> <p>在这个函数中，会根据 exitStatus 的状态执行不同的处理操作，主要是 commitRoot 操作。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>exitStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这两种情况在 performConcurrentWorkOnRoot 中已经处理了，应该不会被执行到</span>
    <span class="token keyword">case</span> RootIncomplete<span class="token operator">:</span>
    <span class="token keyword">case</span> RootFatalErrored<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Root did not complete. This is a bug in React.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// RootErrored 的情况在 performConcurrentWorkOnRoot 中已经对错误情况重试了，这里将直接 commitRoot</span>
    <span class="token keyword">case</span> RootErrored<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// We should have already attempted to retry this tree. If we reached</span>
      <span class="token comment">// this point, it errored again. Commit it.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果 renderRoot 退出后返回 RootSuspended，则将当前的 HostRoot 标记为 suspended</span>
    <span class="token keyword">case</span> RootSuspended<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We have an acceptable loading state. We need to figure out if we</span>
      <span class="token comment">// should immediately commit it or wait a bit.</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">includesOnlyRetries</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// do not delay if we're inside an act() scope</span>
        <span class="token operator">!</span><span class="token function">shouldForceFlushFallbacksInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This render only included retries, no updates. Throttle committing</span>
        <span class="token comment">// retries so that we don't show too many loading states too quickly.</span>
        <span class="token keyword">const</span> msUntilTimeout <span class="token operator">=</span>
          globalMostRecentFallbackTime <span class="token operator">+</span> <span class="token constant">FALLBACK_THROTTLE_MS</span> <span class="token operator">-</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Don't bother with a very short suspense time.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msUntilTimeout <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// There's additional work on this root.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">const</span> suspendedLanes <span class="token operator">=</span> root<span class="token punctuation">.</span>suspendedLanes<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSubsetOfLanes</span><span class="token punctuation">(</span>suspendedLanes<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We should prefer to render the fallback of at the last</span>
            <span class="token comment">// suspended level. Ping the last suspended level to try</span>
            <span class="token comment">// rendering it again.</span>
            <span class="token comment">// FIXME: What if the suspended lanes are Idle? Should not restart.</span>
            <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">markRootPinged</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> suspendedLanes<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// The render is suspended, it hasn't timed out, and there's no</span>
          <span class="token comment">// lower priority work to do. Instead of committing the fallback</span>
          <span class="token comment">// immediately, wait for more data to arrive.</span>
          <span class="token comment">// 在 root.timeoutHandle 挂载延时器，延迟执行 commitRoot</span>
          root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> <span class="token function">scheduleTimeout</span><span class="token punctuation">(</span>
            <span class="token function">commitRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
            msUntilTimeout<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// The work expired. Commit immediately.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> RootSuspendedWithDelay<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">includesOnlyTransitions</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is a transition, so we should exit without committing a</span>
        <span class="token comment">// placeholder and without scheduling a timeout. Delay indefinitely</span>
        <span class="token comment">// until we receive more data.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldForceFlushFallbacksInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is not a transition, but we did trigger an avoided state.</span>
        <span class="token comment">// Schedule a placeholder to display after a short delay, using the Just</span>
        <span class="token comment">// Noticeable Difference.</span>
        <span class="token comment">// TODO: Is the JND optimization worth the added complexity? If this is</span>
        <span class="token comment">// the only reason we track the event time, then probably not.</span>
        <span class="token comment">// Consider removing.</span>

        <span class="token keyword">const</span> mostRecentEventTime <span class="token operator">=</span> <span class="token function">getMostRecentEventTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> eventTimeMs <span class="token operator">=</span> mostRecentEventTime<span class="token punctuation">;</span>
        <span class="token keyword">const</span> timeElapsedMs <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> eventTimeMs<span class="token punctuation">;</span>
        <span class="token keyword">const</span> msUntilTimeout <span class="token operator">=</span> <span class="token function">jnd</span><span class="token punctuation">(</span>timeElapsedMs<span class="token punctuation">)</span> <span class="token operator">-</span> timeElapsedMs<span class="token punctuation">;</span>

        <span class="token comment">// Don't bother with a very short suspense time.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msUntilTimeout <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Instead of committing the fallback immediately, wait for more data</span>
          <span class="token comment">// to arrive.</span>
          root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> <span class="token function">scheduleTimeout</span><span class="token punctuation">(</span>
            <span class="token function">commitRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
            msUntilTimeout<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Commit the placeholder.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果渲染任务退出状态为 RootCompleted，直接 commitRoot</span>
    <span class="token keyword">case</span> RootCompleted<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// The work completed. Ready to commit.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unknown root exit status.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div> <h2 id="renderrootsync"><a href="#renderrootsync" class="header-anchor">#</a> renderRootSync</h2> <p>在上面的分析中，我们已经知道 performSyncWorkOnRoot 和 performConcurrentWorkOnRoot 将会调用 renderRootSync 以完成同步渲染的任务，那么在 commitRoot 之前，同步渲染任务是如何完成的呢？</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> lanes<span class="token operator">:</span> Lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先缓存下 executionContext，以便于错误恢复</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  <span class="token comment">// 将 RenderContext 加入 executionContext 中</span>
  executionContext <span class="token operator">|=</span> RenderContext<span class="token punctuation">;</span>
  <span class="token comment">// 推出 ReactCurrentDispatcher.current，ReactCurrentDispatcher.current 将被重置为 ContextOnlyDispatcher</span>
  <span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> <span class="token function">pushDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the root or lanes have changed, throw out the existing stack</span>
  <span class="token comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span>
  <span class="token comment">// 如果发现 workInProgressRoot 和 workInProgressRootRenderLanes 已经不要将要渲染的 root 和 lanes 了，将对 root 和 workInProgress 等变量执行清理和重置工作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> root <span class="token operator">||</span> workInProgressRootRenderLanes <span class="token operator">!==</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 开启一个 workLoopSync 循环，handleError 将捕获和处理 workLoopSync 执行中的错误。</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当 workLoopSync 的循环退出后，所有渲染工作就执行完毕，</span>
  <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将 executionContext 恢复至渲染之前的状态，这表明 RenderContext 和 CommitContext（将在后文中加入） 将会被移除，之所以可以这样做，是因为我们刚好需要重置到 BatchedContext</span>
  executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
  <span class="token comment">// 推入 ReactCurrentDispatcher.current，ReactCurrentDispatcher.current 将置为 prevDispatcher</span>
  <span class="token function">popDispatcher</span><span class="token punctuation">(</span>prevDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// workLoopSync 循环执行完之后，workInProgress 应该置空，否则说明可能有工作没有执行完，所以报错</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a sync render, so we should have finished the whole tree.</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'Cannot commit an incomplete root. This error is likely caused by a '</span> <span class="token operator">+</span>
        <span class="token string">'bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 继 workInProgress 置空之后，也重置 workInProgressRoot 和 workInProgressRootRenderLanes，这表明没有任何任务正在被渲染。</span>
  <span class="token comment">// Set this to null to indicate there's no in-progress render.</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token comment">// workInProgressRootExitStatus 是文件中的一个全局变量，表示 HostRoot 渲染之后退出时的状态，workLoopSync 会更新这个值。</span>
  <span class="token keyword">return</span> workInProgressRootExitStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// This is called right before React yields execution, to ensure `readContext`</span>
  <span class="token comment">// cannot be called outside the render phase.</span>
  currentlyRenderingFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  lastContextDependency <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  lastFullyObservedContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div> <ul><li>这里 executionContext 使用很巧妙，这里直接缓存了 executionContext 的值，并在执行完 workLoopSync 之后恢复。这是因为 renderRoot 中会在 executionContext 加入 RenderContext，而在 workLoop 中，则会在 executionContext 加入 CommitContext。因此这里直接将 executionContext 恢复至 BatchContext。</li> <li>在执行 renderRoot 时，ReactCurrentDispatcher.current 将被重置为 ContextOnlyDispatcher，在执行完毕后恢复原值，这以为这什么呢？在 <a href="/react/hooks/useState"> useState 和 useReducer 原理探析</a> 一文中已经套就过 ReactCurrentDispatcher.current 中挂载的不同类型的 dispatcher 将会使用不同实现的 hooks。从下面的代码可以看出，在此阶段，所有的 hook 调用都会由 throwInvalidHookError 报错。
</li> <li>具体的渲染工作 workLoopSync 完成的，这是一个死循环，直到 workLoopSync 正常执行时退出。</li> <li>渲染完毕后会执行一些重置工作，包括 workInProgress、workInProgressRoot、workInProgressRootRenderLanes 等。</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> ContextOnlyDispatcher<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  readContext<span class="token punctuation">,</span>

  useCallback<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useContext<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useImperativeHandle<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useInsertionEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useLayoutEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useDebugValue<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useDeferredValue<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useTransition<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useMutableSource<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useSyncExternalStore<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useId<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>

  unstable_isNewReconciler<span class="token operator">:</span> enableNewReconciler<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="renderrootconcurrent"><a href="#renderrootconcurrent" class="header-anchor">#</a> renderRootConcurrent</h2> <p>在前面的分析中，我们知道 performConcurrentWorkOnRoot 函数会调用 renderRootConcurrent 去完成异步任务的渲染工作。现在我们来看下异步任务是如何完成的？这里与 renderRootSync 类似，将简略分析。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">renderRootConcurrent</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> lanes<span class="token operator">:</span> Lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> RenderContext<span class="token punctuation">;</span>
  <span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> <span class="token function">pushDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the root or lanes have changed, throw out the existing stack</span>
  <span class="token comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> root <span class="token operator">||</span> workInProgressRootRenderLanes <span class="token operator">!==</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resetRenderTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">popDispatcher</span><span class="token punctuation">(</span>prevDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>

  <span class="token comment">// Check if the tree has completed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RootIncomplete<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set this to null to indicate there's no in-progress render.</span>
    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

    <span class="token comment">// Return the final exit status.</span>
    <span class="token keyword">return</span> workInProgressRootExitStatus<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li>这里调用了 workLoopConcurrent 以完成异步渲染任务，同样是死循环的设计，直到 workLoopConcurrent 执行成功。</li> <li>不同的是，在 renderRootConcurrent 中，workLoopConcurrent 循环执行之后，workInProgress 是可以不为 null 的，在 中，workLoopSync 中将直接报错。需要注意的是，异步任务是可以不完成的，这时会返回 exitStatus 为 RootIncomplete。
</li></ul> <h3 id="handleerror"><a href="#handleerror" class="header-anchor">#</a> handleError</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> erroredWork <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Reset module-level state that was set during the render phase.</span>
      <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resetHooksAfterThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// TODO: I found and added this missing line while investigating a</span>
      <span class="token comment">// separate issue. Write a regression test using string refs.</span>
      ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果 workInProgress 不存在，或者 workInProgress.return 不存在则视为致命错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>erroredWork <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> erroredWork<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Expected to be working on a non-root fiber. This is a fatal error</span>
        <span class="token comment">// because there's no ancestor that can handle it; the root is</span>
        <span class="token comment">// supposed to capture all errors that weren't caught by an error</span>
        <span class="token comment">// boundary.</span>
        workInProgressRootExitStatus <span class="token operator">=</span> RootFatalErrored<span class="token punctuation">;</span>
        workInProgressRootFatalError <span class="token operator">=</span> thrownValue<span class="token punctuation">;</span>
        <span class="token comment">// Set `workInProgress` to null. This represents advancing to the next</span>
        <span class="token comment">// sibling, or the parent if there are no siblings. But since the root</span>
        <span class="token comment">// has no siblings nor a parent, we set it to null. Usually this is</span>
        <span class="token comment">// handled by `completeUnitOfWork` or `unwindWork`, but since we're</span>
        <span class="token comment">// intentionally not calling those, we need set it here.</span>
        <span class="token comment">// TODO: Consider calling `unwindWork` to pop the contexts.</span>
        workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 非致命错误将抛出异常、直接跳到完成渲染的回调</span>
      <span class="token function">throwException</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        erroredWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span>
        erroredWork<span class="token punctuation">,</span>
        thrownValue<span class="token punctuation">,</span>
        workInProgressRootRenderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>erroredWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>yetAnotherThrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Something in the return path also threw.</span>
      <span class="token comment">// 如果 workInProgress 上处理错误仍然抛出错误，找到 workInProgress.return 将其设置 erroredWork，错误将抛到父级处理。</span>
      thrownValue <span class="token operator">=</span> yetAnotherThrownValue<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> erroredWork <span class="token operator">&amp;&amp;</span> erroredWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this boundary has already errored, then we had trouble processing</span>
        <span class="token comment">// the error. Bubble it to the next boundary.</span>
        erroredWork <span class="token operator">=</span> erroredWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
        workInProgress <span class="token operator">=</span> erroredWork<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        erroredWork <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 只有没有 yetAnotherThrownValue 时才正常退出到 work loop</span>
    <span class="token comment">// Return to the normal work loop.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ul><li>对于致命错误将直接将 workInProgress 置为 null，exitStatus 将抛出致命错误。</li> <li>对于普通错误，抛出异常并且调用 completeUnitOfWork 执行渲染完毕的逻辑，这里 workInProgress 也会被值为 null。无论是致命错误还是普通错误都会正常跳出 workLoop。</li> <li>对于处理过程中仍然抛出错误的错误，将向父级冒泡处理错误，知道错误被解决。</li></ul> <h2 id="workloopsync"><a href="#workloopsync" class="header-anchor">#</a> workLoopSync</h2> <p>通过上面的分析可以知道，renderRootSync 会调用 workLoopSync 完成同步任务的渲染，现在我们来看下 workLoopSync 函数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// The work loop is an extremely hot path. Tell Closure not to inline it.</span>
<span class="token comment">/** @noinline */</span>
<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Already timed out, so perform work without checking if we need to yield.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>这个函数就是在 workInProgress 还有值的时候执行 performUnitOfWork 消费 workInProgress。同步渲染会完成所有的任务，即处理 HostRoot 上所有 Fiber 上的同步更新。</li> <li>@noinline 是 chrome 浏览器的一种优化标注。 Google Closure Compiler 使用此标注是函数或者标注不被转换成 inline。详见：<a href="https://github.com/google/closure-compiler/wiki/Annotating-JavaScript-for-the-Closure-Compiler#noinline" target="_blank" rel="noopener noreferrer">@noinline<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。浏览器 js 引擎通过 inline 优化提升代码解析效率，这通常对一些常量、不太执行的函数（如工厂函数，我们将在 vue 源码中看到）有效，对执行频率较高的函数和变量反而效率很低。这里 @noinline 标注意思是不要使用 inline 优化，以免降低代码执行效率。</li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>inline 优化是什么？</strong></p> <p>In computing, inline expansion, or inlining, is a manual or compiler optimization that replaces a function call site with the body of the called function. Inline expansion is similar to macro expansion, but occurs during compilation, without changing the source code (the text), while macro expansion occurs prior to compilation, and results in different text that is then processed by the compiler.</p> <ul><li><a href="https://en.wikipedia.org/wiki/Inline_expansion#Effect_on_performance" target="_blank" rel="noopener noreferrer">Inline expansion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h2 id="workloopconcurrent"><a href="#workloopconcurrent" class="header-anchor">#</a> workLoopConcurrent</h2> <p>在 renderRootConcurrent 函数中会调用 workLoopConcurrent 以完成异步渲染任务。workLoopConcurrent 与 workLoopSync 类似，不在赘述。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">/** @noinline */</span>
<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Perform work until Scheduler asks us to yield</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>workInProgress 为 null 是会直接跳出，或者 shouldYield 时也会跳出。因此跳出 workLoopConcurrent 有两种情况，一是所有任务都执行完了，二是调度器即将产生 (yield) 新回调了。</li></ul> <h2 id="performunitofwork"><a href="#performunitofwork" class="header-anchor">#</a> performUnitOfWork</h2> <div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>重要</span></div> <p>从上面的分析中，我们已经知道无论是 workLoopSync 还是 workLoopConcurrent 最终都会调用 performUnitOfWork，这说明同步任务和异步任务的分发，最终都是通过 performUnitOfWork 来真正执行的。也就是说，对于执行渲染任务而言，performUnitOfWork 才是背后默默干活的工人。下面我们着重分析下这个函数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// The current, flushed, state of this fiber is the alternate. Ideally</span>
  <span class="token comment">// nothing should rely on this, but relying on it here means that we don't</span>
  <span class="token comment">// need an additional field on the work in progress.</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">let</span> next<span class="token punctuation">;</span>
 
  next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If this doesn't spawn new work, complete the current work.</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>在 <a href="/react/reconciliation/fiber.html#fiber-的定义">fiber 与 Reconciliation 探析</a>疑问中，我们分析过 Fiber 的结构，其中 fiber.alternate 是 fiber 上的一个版本池，当 fiber 更新以后会更新到 fiber.alternate 上。unitOfWork 本质是一个 fiber，其中 current 代表了 fiber 上一次更新的结果。</li> <li>beginWork 对当前的 workInProgress 进行 render，渲染后返回下一个需要更新的 fiber。在 beginWork 中，我们将具体探讨 fiber 的遍历的方法和结构。</li> <li>当 next 为 null 时，所有 fiber render 完毕，因此执行 completeUnitOfWork。上一次执行 completeUnitOfWork 还是在 renderRootSync 和 renderRootConcurrent 的 handlerError 中遇到普通错误时。如果任务还没有完成，将 next 设置为 workInProgress，下次 performUnitOfWork 就会针对 next 进行 render。</li></ul> <h2 id="beginwork"><a href="#beginwork" class="header-anchor">#</a> beginWork</h2> <div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>重要</span></div> <p>在上面的分析中，我们已经知道 performUnitOfWork 会调用 beginWork 来执行 RootFiber 以及其下每一个 fiber 的渲染工作。那么具体执行了哪些工作呢？FiberTree 的遍历是如何进行呢？下面我们来看下 beginWork：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberBeginWork.new.js</span>

<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token comment">// 上次渲染的 fiber</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 本次要渲染的 fiber</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  renderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 非初次渲染</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span>
      <span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// Force a re-render if the implementation changed due to hot reload:</span>
      <span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> workInProgress<span class="token punctuation">.</span>type <span class="token operator">!==</span> current<span class="token punctuation">.</span>type <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Neither props nor legacy context changes. Check if there's a pending</span>
      <span class="token comment">// update or context change.</span>
      <span class="token keyword">const</span> hasScheduledUpdateOrContext <span class="token operator">=</span> <span class="token function">checkScheduledUpdateOrContext</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>hasScheduledUpdateOrContext <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// If this is the second pass of an error or suspense boundary, there</span>
        <span class="token comment">// may not be work scheduled on `current`, so we check for this flag.</span>
        <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">===</span> NoFlags
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No pending updates or context. Bail out now.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">attemptEarlyBailoutIfNoScheduledUpdate</span><span class="token punctuation">(</span>
          current<span class="token punctuation">,</span>
          workInProgress<span class="token punctuation">,</span>
          renderLanes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ForceUpdateForLegacySuspense<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is a special case that only exists for legacy mode.</span>
        <span class="token comment">// See https://github.com/facebook/react/pull/19216.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// An update was scheduled on this fiber, but there are no new props</span>
        <span class="token comment">// nor legacy context. Set this to false. If an update queue or context</span>
        <span class="token comment">// consumer produces a changed value, it will set this to true. Otherwise,</span>
        <span class="token comment">// the component will assume the children have not changed and bail out.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIsHydrating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isForkedChild</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if this child belongs to a list of muliple children in</span>
      <span class="token comment">// its parent.</span>
      <span class="token comment">//</span>
      <span class="token comment">// In a true multi-threaded implementation, we would render children on</span>
      <span class="token comment">// parallel threads. This would represent the beginning of a new render</span>
      <span class="token comment">// thread for this subtree.</span>
      <span class="token comment">//</span>
      <span class="token comment">// We only use this for id generation during hydration, which is why the</span>
      <span class="token comment">// logic is located in this special branch.</span>
      <span class="token comment">// index 记录了当前 fiber 排在父列表中的下标</span>
      <span class="token keyword">const</span> slotIndex <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token keyword">const</span> numberOfForks <span class="token operator">=</span> <span class="token function">getForksAtLevel</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pushTreeId</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> numberOfForks<span class="token punctuation">,</span> slotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Before entering the begin phase, clear pending update priority.</span>
  <span class="token comment">// TODO: This assumes that we're about to evaluate the component and process</span>
  <span class="token comment">// the update queue. However, there's an exception: SimpleMemoComponent</span>
  <span class="token comment">// sometimes bails out later in the begin phase. This indicates that we should</span>
  <span class="token comment">// move this assignment out of the common path and into each branch.</span>
  <span class="token comment">// 因为如下要真正渲染了，可以将优先级信息清空</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> LazyComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> elementType <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">mountLazyComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        elementType<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostText<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SuspenseComponent<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateSuspenseComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updatePortalComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ForwardRef<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> type
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateForwardRef</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateFragment</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Mode<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateMode</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Profiler<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateProfiler</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextProvider<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextProvider</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextConsumer<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextConsumer</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token comment">// Resolve outer props first, then resolve inner props.</span>
      <span class="token keyword">let</span> resolvedProps <span class="token operator">=</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type <span class="token operator">!==</span> workInProgress<span class="token punctuation">.</span>elementType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> outerPropTypes <span class="token operator">=</span> type<span class="token punctuation">.</span>propTypes<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>outerPropTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkPropTypes</span><span class="token punctuation">(</span>
              outerPropTypes<span class="token punctuation">,</span>
              resolvedProps<span class="token punctuation">,</span> <span class="token comment">// Resolved for outer only</span>
              <span class="token string">'prop'</span><span class="token punctuation">,</span>
              <span class="token function">getComponentNameFromType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      resolvedProps <span class="token operator">=</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>type<span class="token punctuation">,</span> resolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateMemoComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateSimpleMemoComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> IncompleteClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">mountIncompleteClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> SuspenseListComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateSuspenseListComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ScopeComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableScopeAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">updateScopeComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> OffscreenComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateOffscreenComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> LegacyHiddenComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateLegacyHiddenComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> CacheComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">updateCacheComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unknown unit of work tag (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workInProgress<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">). This error is likely caused by a bug in </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token string">'React. Please file an issue.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br></div></div><ul><li>didReceiveUpdate 标记是否有属性或者 context 的更新，因为这两种情况会引发 re-render。</li> <li>重要环境在于根据 workInProgress.tag 类别创建或者更新不同的组件，这里具体过程不在赘述，可以参考 <a href="/react/updater/workloop">workLoop 和 performUnitOfWork 探析</a>一文。</li> <li>需要注意的是，在上面 updateXXXComponent 的之后，会返回  <code>workInProgress.child</code> ，作为 performUnitOfWork 中的 next。根据这个线索，可以知道 react 中 performUnitOfWork 中是根据深度优先搜索（DFS）来进行遍历渲染的，那么这种遍历怎么扩展到兄弟节点呢？</li></ul> <h2 id="completeunitofwork"><a href="#completeunitofwork" class="header-anchor">#</a> completeUnitOfWork</h2> <h2 id="completework"><a href="#completework" class="header-anchor">#</a> completeWork</h2> <h2 id="commitroot"><a href="#commitroot" class="header-anchor">#</a> commitRoot</h2></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-front-end/edit/master/docs/10.react/80.总结/40.10-min-react.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/15, 00:23:56</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/react/summary/event-listener/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">React 中的事件监听机制</div></a> <a href="/react/tour/index/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">开始上手</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react/summary/event-listener/" class="prev">React 中的事件监听机制</a></span> <span class="next"><a href="/react/tour/index/">开始上手</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/solid/render/render-by-jsx/"><div>
            渲染原理之组件结构与 JSX 编译
            <!----></div></a> <span class="date">09-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/solid/plan/"><div>
            计划跟踪
            <!----></div></a> <span class="date">09-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/solid/index/"><div>
            开始上手
            <!----></div></a> <span class="date">09-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://ml.jonsam.site" title="机器学习" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy Front End | Made by <a href="https://www.jonsam.site" target="_blank">Jonsam</a> by ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.eb21b6ee.js" defer></script><script src="/assets/js/2.01e091c2.js" defer></script><script src="/assets/js/45.3973ea4b.js" defer></script><script src="/assets/js/4.54e60667.js" defer></script><script src="/assets/js/12.71337abb.js" defer></script><script src="/assets/js/10.ac472f43.js" defer></script><script src="/assets/js/11.c50183f9.js" defer></script><script src="/assets/js/8.7cbef5ec.js" defer></script><script src="/assets/js/5.f620477b.js" defer></script>
  </body>
</html>
