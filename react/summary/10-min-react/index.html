<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>30 åˆ†é’Ÿçœ‹æ‡‚ React æ¡†æ¶åŸç† | Fancy Front End</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <meta name="description" content="å‰ç«¯æºç é˜…è¯»æ ˆï¼Œç²¾è¯» Reactã€Vue3 æºç ">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="å‰ç«¯æºç ,Reactæºç ,Vueæºç ,Vu3æºç ,Webpackæºç ">
    <meta name="theme-color" content="#3CB982">
    
    <link rel="preload" href="/assets/css/0.styles.e2349a00.css" as="style"><link rel="preload" href="/assets/js/app.eb21b6ee.js" as="script"><link rel="preload" href="/assets/js/2.01e091c2.js" as="script"><link rel="preload" href="/assets/js/45.3973ea4b.js" as="script"><link rel="preload" href="/assets/js/4.54e60667.js" as="script"><link rel="preload" href="/assets/js/12.71337abb.js" as="script"><link rel="preload" href="/assets/js/10.ac472f43.js" as="script"><link rel="preload" href="/assets/js/11.c50183f9.js" as="script"><link rel="preload" href="/assets/js/8.7cbef5ec.js" as="script"><link rel="preload" href="/assets/js/5.f620477b.js" as="script"><link rel="prefetch" href="/assets/js/100.8081075e.js"><link rel="prefetch" href="/assets/js/101.943ea683.js"><link rel="prefetch" href="/assets/js/102.11c8554c.js"><link rel="prefetch" href="/assets/js/103.c2780521.js"><link rel="prefetch" href="/assets/js/104.81994794.js"><link rel="prefetch" href="/assets/js/105.f987244b.js"><link rel="prefetch" href="/assets/js/106.235a578e.js"><link rel="prefetch" href="/assets/js/107.94cdbb18.js"><link rel="prefetch" href="/assets/js/108.3a80cb29.js"><link rel="prefetch" href="/assets/js/109.8884be03.js"><link rel="prefetch" href="/assets/js/110.89ab5eb2.js"><link rel="prefetch" href="/assets/js/111.355b1782.js"><link rel="prefetch" href="/assets/js/112.34671c87.js"><link rel="prefetch" href="/assets/js/113.0cca0902.js"><link rel="prefetch" href="/assets/js/114.01616168.js"><link rel="prefetch" href="/assets/js/115.4915c0b5.js"><link rel="prefetch" href="/assets/js/116.ef93855a.js"><link rel="prefetch" href="/assets/js/117.e3526ed0.js"><link rel="prefetch" href="/assets/js/118.7d52a4ea.js"><link rel="prefetch" href="/assets/js/119.a4bb17bb.js"><link rel="prefetch" href="/assets/js/120.135aa6ea.js"><link rel="prefetch" href="/assets/js/121.86c35c15.js"><link rel="prefetch" href="/assets/js/122.1452986d.js"><link rel="prefetch" href="/assets/js/123.0181b553.js"><link rel="prefetch" href="/assets/js/124.edc508f8.js"><link rel="prefetch" href="/assets/js/125.46d932c1.js"><link rel="prefetch" href="/assets/js/126.17e05a12.js"><link rel="prefetch" href="/assets/js/127.98159dfe.js"><link rel="prefetch" href="/assets/js/128.9aaa5bc6.js"><link rel="prefetch" href="/assets/js/129.26bed928.js"><link rel="prefetch" href="/assets/js/13.292db5f6.js"><link rel="prefetch" href="/assets/js/130.9f74c846.js"><link rel="prefetch" href="/assets/js/131.d6ef0885.js"><link rel="prefetch" href="/assets/js/132.1d9ee075.js"><link rel="prefetch" href="/assets/js/133.2b23ed7b.js"><link rel="prefetch" href="/assets/js/134.c47e8a23.js"><link rel="prefetch" href="/assets/js/135.2aeb3426.js"><link rel="prefetch" href="/assets/js/136.0169c47b.js"><link rel="prefetch" href="/assets/js/137.70cdfc24.js"><link rel="prefetch" href="/assets/js/138.e54160ee.js"><link rel="prefetch" href="/assets/js/139.9a6d1932.js"><link rel="prefetch" href="/assets/js/14.54d2636a.js"><link rel="prefetch" href="/assets/js/140.ddabaeca.js"><link rel="prefetch" href="/assets/js/141.35844ecc.js"><link rel="prefetch" href="/assets/js/142.4ccdb5e4.js"><link rel="prefetch" href="/assets/js/143.37a7f36e.js"><link rel="prefetch" href="/assets/js/144.95ff6a63.js"><link rel="prefetch" href="/assets/js/145.9899e545.js"><link rel="prefetch" href="/assets/js/146.6865658b.js"><link rel="prefetch" href="/assets/js/147.2a55d18a.js"><link rel="prefetch" href="/assets/js/148.f3aab640.js"><link rel="prefetch" href="/assets/js/149.57b565a0.js"><link rel="prefetch" href="/assets/js/15.81d908ff.js"><link rel="prefetch" href="/assets/js/150.3f7143ae.js"><link rel="prefetch" href="/assets/js/151.5981cf9e.js"><link rel="prefetch" href="/assets/js/152.a3428a7b.js"><link rel="prefetch" href="/assets/js/153.0f0b339d.js"><link rel="prefetch" href="/assets/js/154.39f3b522.js"><link rel="prefetch" href="/assets/js/155.13c8170a.js"><link rel="prefetch" href="/assets/js/156.ccb66614.js"><link rel="prefetch" href="/assets/js/157.4b8bce50.js"><link rel="prefetch" href="/assets/js/158.6476dd1c.js"><link rel="prefetch" href="/assets/js/159.b261a009.js"><link rel="prefetch" href="/assets/js/16.68d8e787.js"><link rel="prefetch" href="/assets/js/160.e501007d.js"><link rel="prefetch" href="/assets/js/161.d3f56d3d.js"><link rel="prefetch" href="/assets/js/162.f8590797.js"><link rel="prefetch" href="/assets/js/163.91fe4509.js"><link rel="prefetch" href="/assets/js/164.6e92f3f4.js"><link rel="prefetch" href="/assets/js/165.56868a39.js"><link rel="prefetch" href="/assets/js/166.83812a3b.js"><link rel="prefetch" href="/assets/js/167.4b528df4.js"><link rel="prefetch" href="/assets/js/168.f2b151fb.js"><link rel="prefetch" href="/assets/js/169.cb2ee128.js"><link rel="prefetch" href="/assets/js/17.895175dc.js"><link rel="prefetch" href="/assets/js/170.63b574e9.js"><link rel="prefetch" href="/assets/js/171.ad38a311.js"><link rel="prefetch" href="/assets/js/172.b592b97e.js"><link rel="prefetch" href="/assets/js/173.302ef08b.js"><link rel="prefetch" href="/assets/js/174.d71ad1a3.js"><link rel="prefetch" href="/assets/js/175.2617c860.js"><link rel="prefetch" href="/assets/js/176.19a67035.js"><link rel="prefetch" href="/assets/js/177.75aab37d.js"><link rel="prefetch" href="/assets/js/178.b2773712.js"><link rel="prefetch" href="/assets/js/179.6a34b45f.js"><link rel="prefetch" href="/assets/js/18.736b781d.js"><link rel="prefetch" href="/assets/js/180.d447fc48.js"><link rel="prefetch" href="/assets/js/181.d6b96886.js"><link rel="prefetch" href="/assets/js/182.42c2bcd5.js"><link rel="prefetch" href="/assets/js/183.a6256a82.js"><link rel="prefetch" href="/assets/js/184.8a036f5a.js"><link rel="prefetch" href="/assets/js/185.811d5831.js"><link rel="prefetch" href="/assets/js/186.6436a583.js"><link rel="prefetch" href="/assets/js/187.4bcf94a3.js"><link rel="prefetch" href="/assets/js/188.33f39bd6.js"><link rel="prefetch" href="/assets/js/189.c1b90840.js"><link rel="prefetch" href="/assets/js/19.504bd141.js"><link rel="prefetch" href="/assets/js/20.e526fb51.js"><link rel="prefetch" href="/assets/js/21.8375d39e.js"><link rel="prefetch" href="/assets/js/22.0e15b626.js"><link rel="prefetch" href="/assets/js/23.83bcc15c.js"><link rel="prefetch" href="/assets/js/24.3df554ce.js"><link rel="prefetch" href="/assets/js/25.6c56da2b.js"><link rel="prefetch" href="/assets/js/26.76154857.js"><link rel="prefetch" href="/assets/js/27.155dbcb4.js"><link rel="prefetch" href="/assets/js/28.7178e96c.js"><link rel="prefetch" href="/assets/js/29.f7337396.js"><link rel="prefetch" href="/assets/js/3.50570587.js"><link rel="prefetch" href="/assets/js/30.191545d3.js"><link rel="prefetch" href="/assets/js/31.b6a0fe90.js"><link rel="prefetch" href="/assets/js/32.18cebeab.js"><link rel="prefetch" href="/assets/js/33.146782c3.js"><link rel="prefetch" href="/assets/js/34.c08af9cb.js"><link rel="prefetch" href="/assets/js/35.ea730de0.js"><link rel="prefetch" href="/assets/js/36.11aba0b0.js"><link rel="prefetch" href="/assets/js/37.0fd8e20a.js"><link rel="prefetch" href="/assets/js/38.2cde6902.js"><link rel="prefetch" href="/assets/js/39.07c230cc.js"><link rel="prefetch" href="/assets/js/40.e4fcccd0.js"><link rel="prefetch" href="/assets/js/41.5f96c201.js"><link rel="prefetch" href="/assets/js/42.e5023440.js"><link rel="prefetch" href="/assets/js/43.2cfdc8d9.js"><link rel="prefetch" href="/assets/js/44.37f32c52.js"><link rel="prefetch" href="/assets/js/46.87541312.js"><link rel="prefetch" href="/assets/js/47.04f0011f.js"><link rel="prefetch" href="/assets/js/48.1151f311.js"><link rel="prefetch" href="/assets/js/49.6830fb0c.js"><link rel="prefetch" href="/assets/js/50.84b34574.js"><link rel="prefetch" href="/assets/js/51.840f38c4.js"><link rel="prefetch" href="/assets/js/52.3dbda6e7.js"><link rel="prefetch" href="/assets/js/53.7f0a8896.js"><link rel="prefetch" href="/assets/js/54.5d7f6427.js"><link rel="prefetch" href="/assets/js/55.86c7b544.js"><link rel="prefetch" href="/assets/js/56.49a27b9a.js"><link rel="prefetch" href="/assets/js/57.287f9e58.js"><link rel="prefetch" href="/assets/js/58.40a49fdb.js"><link rel="prefetch" href="/assets/js/59.91487422.js"><link rel="prefetch" href="/assets/js/6.8880bb8c.js"><link rel="prefetch" href="/assets/js/60.8dfd58ee.js"><link rel="prefetch" href="/assets/js/61.7b4874b9.js"><link rel="prefetch" href="/assets/js/62.d83f3691.js"><link rel="prefetch" href="/assets/js/63.1237a900.js"><link rel="prefetch" href="/assets/js/64.1f096a25.js"><link rel="prefetch" href="/assets/js/65.809d988d.js"><link rel="prefetch" href="/assets/js/66.43c1e5f9.js"><link rel="prefetch" href="/assets/js/67.24ab137d.js"><link rel="prefetch" href="/assets/js/68.7b0346b5.js"><link rel="prefetch" href="/assets/js/69.2008c989.js"><link rel="prefetch" href="/assets/js/7.0c293177.js"><link rel="prefetch" href="/assets/js/70.e8cf3232.js"><link rel="prefetch" href="/assets/js/71.d661943d.js"><link rel="prefetch" href="/assets/js/72.e67a47a3.js"><link rel="prefetch" href="/assets/js/73.87f1db52.js"><link rel="prefetch" href="/assets/js/74.ac67cd0d.js"><link rel="prefetch" href="/assets/js/75.e25ebf69.js"><link rel="prefetch" href="/assets/js/76.a7222468.js"><link rel="prefetch" href="/assets/js/77.ffb71305.js"><link rel="prefetch" href="/assets/js/78.72c00bee.js"><link rel="prefetch" href="/assets/js/79.66ec368e.js"><link rel="prefetch" href="/assets/js/80.8792d3d7.js"><link rel="prefetch" href="/assets/js/81.49d3731a.js"><link rel="prefetch" href="/assets/js/82.fbe09e61.js"><link rel="prefetch" href="/assets/js/83.220a02bb.js"><link rel="prefetch" href="/assets/js/84.4b722410.js"><link rel="prefetch" href="/assets/js/85.f83d2db9.js"><link rel="prefetch" href="/assets/js/86.17b19d53.js"><link rel="prefetch" href="/assets/js/87.37568307.js"><link rel="prefetch" href="/assets/js/88.d7cc6612.js"><link rel="prefetch" href="/assets/js/89.ffb378d0.js"><link rel="prefetch" href="/assets/js/9.2a7e5bdc.js"><link rel="prefetch" href="/assets/js/90.02c91127.js"><link rel="prefetch" href="/assets/js/91.c22d9224.js"><link rel="prefetch" href="/assets/js/92.c79d457a.js"><link rel="prefetch" href="/assets/js/93.33a03732.js"><link rel="prefetch" href="/assets/js/94.c73ddbbc.js"><link rel="prefetch" href="/assets/js/95.a5151497.js"><link rel="prefetch" href="/assets/js/96.b8f204d2.js"><link rel="prefetch" href="/assets/js/97.d7ddaa6f.js"><link rel="prefetch" href="/assets/js/98.49dbda5e.js"><link rel="prefetch" href="/assets/js/99.d14f43ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2349a00.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Fancy Front End" class="logo"> <span class="site-name can-hide">Fancy Front End</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Reactæºç " class="dropdown-title"><a href="/react/index/" class="link-title">Reactæºç </a> <span class="title" style="display:none;">Reactæºç </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">å¼€å§‹ä¸Šæ‰‹</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">åŸºç¡€</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">æ›´æ–°å™¨ï¼ˆUpdaterï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">æ¸²æŸ“å™¨ï¼ˆRenderï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">æ›´æ–°å‘¨æœŸ</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks åŸç†</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">æ€»ç»“</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">ğŸ“™ Reactæºç æ¼‚æµè®°</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3æºç " class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3æºç </a> <span class="title" style="display:none;">Vue3æºç </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">å¼€å§‹ä¸Šæ‰‹</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">åŸºç¡€</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è¿›é˜¶" class="dropdown-title"><a href="/web/" class="link-title">è¿›é˜¶</a> <span class="title" style="display:none;">è¿›é˜¶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">è¯é¢˜</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ›´å¤š" class="dropdown-title"><a href="/nav/" class="link-title">æ›´å¤š</a> <span class="title" style="display:none;">æ›´å¤š</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">å¯¼èˆª</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">å¹»ç¯ç‰‡</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">å…³äº</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>è®©æœ‰æ„ä¹‰çš„äº‹å˜å¾—æœ‰æ„æ€ï¼Œè®©æœ‰æ„æ€çš„äº‹å˜å¾—æœ‰æ„ä¹‰</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Reactæºç " class="dropdown-title"><a href="/react/index/" class="link-title">Reactæºç </a> <span class="title" style="display:none;">Reactæºç </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">å¼€å§‹ä¸Šæ‰‹</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">åŸºç¡€</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">æ›´æ–°å™¨ï¼ˆUpdaterï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">æ¸²æŸ“å™¨ï¼ˆRenderï¼‰</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">æ›´æ–°å‘¨æœŸ</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks åŸç†</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">æ€»ç»“</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">ğŸ“™ Reactæºç æ¼‚æµè®°</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3æºç " class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3æºç </a> <span class="title" style="display:none;">Vue3æºç </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">å¼€å§‹ä¸Šæ‰‹</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">åŸºç¡€</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è¿›é˜¶" class="dropdown-title"><a href="/web/" class="link-title">è¿›é˜¶</a> <span class="title" style="display:none;">è¿›é˜¶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">è¯é¢˜</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ›´å¤š" class="dropdown-title"><a href="/nav/" class="link-title">æ›´å¤š</a> <span class="title" style="display:none;">æ›´å¤š</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">å¯¼èˆª</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">å¹»ç¯ç‰‡</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">å…³äº</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/react/index/" class="sidebar-link">å¼€å§‹ä¸Šæ‰‹</a></li><li><a href="/react/plan/" class="sidebar-link">plan è®¡åˆ’</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>åŸºç¡€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>è°ƒå’Œï¼ˆReconciliationï¼‰</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ›´æ–°å™¨ï¼ˆUpdaterï¼‰</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ¸²æŸ“å™¨ï¼ˆRenderï¼‰</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hooksåŸç†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>æ€»ç»“</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/summary/index/" class="sidebar-link">å¼€å§‹ä¸Šæ‰‹</a></li><li><a href="/react/summary/bitOperation/" class="sidebar-link">ä½è¿ç®—åˆæ¢</a></li><li><a href="/react/summary/first-render/" class="sidebar-link">React é¦–æ¬¡æ¸²æŸ“è¿‡ç¨‹</a></li><li><a href="/react/summary/event-listener/" class="sidebar-link">React ä¸­çš„äº‹ä»¶ç›‘å¬æœºåˆ¶</a></li><li><a href="/react/summary/10-min-react/" aria-current="page" class="active sidebar-link">30 åˆ†é’Ÿçœ‹æ‡‚ React æ¡†æ¶åŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#ç›®å½•" class="sidebar-link">ç›®å½•</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#reactdomhostconfig" class="sidebar-link">ReactDOMHostConfig</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#updatecontainer" class="sidebar-link">updateContainer</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#scheduleupdateonfiber" class="sidebar-link">scheduleUpdateOnFiber</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#ensurerootisscheduled" class="sidebar-link">ensureRootIsScheduled</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#schedulesynccallback-å’Œ-schedulecallback" class="sidebar-link">scheduleSyncCallback å’Œ scheduleCallback</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performsyncworkonroot" class="sidebar-link">performSyncWorkOnRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performconcurrentworkonroot" class="sidebar-link">performConcurrentWorkOnRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#renderrootsync" class="sidebar-link">renderRootSync</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#renderrootconcurrent" class="sidebar-link">renderRootConcurrent</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#workloopsync" class="sidebar-link">workLoopSync</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#workloopconcurrent" class="sidebar-link">workLoopConcurrent</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#performunitofwork" class="sidebar-link">performUnitOfWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#beginwork" class="sidebar-link">beginWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#completeunitofwork" class="sidebar-link">completeUnitOfWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#completework" class="sidebar-link">completeWork</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/10-min-react/#commitroot" class="sidebar-link">commitRoot</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reactæºç æ¼‚æµè®°</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-e1efabd0><div class="articleInfo" data-v-e1efabd0><ul class="breadcrumbs" data-v-e1efabd0><li data-v-e1efabd0><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-e1efabd0></a></li> <li data-v-e1efabd0><a href="/categories/?category=react" title="åˆ†ç±»" data-v-e1efabd0>react</a></li><li data-v-e1efabd0><a href="/categories/?category=%E6%80%BB%E7%BB%93" title="åˆ†ç±»" data-v-e1efabd0>æ€»ç»“</a></li></ul> <div class="info" data-v-e1efabd0><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-e1efabd0><a href="https://github.com/jonsam-ng" target="_blank" title="ä½œè€…" class="beLink" data-v-e1efabd0>jonsam</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-e1efabd0><a href="javascript:;" data-v-e1efabd0>2022-04-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">30 åˆ†é’Ÿçœ‹æ‡‚ React æ¡†æ¶åŸç†<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>æ ‡ç­¾ï¼š</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>React17</span><span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>ä»¥è°ƒå’Œå™¨ä¸ºæ ¸å¿ƒ</span></div> <!----> <h2 id="ç›®å½•"><a href="#ç›®å½•" class="header-anchor">#</a> ç›®å½•</h2> <p></p><div class="table-of-contents"><ul><li><a href="#ç›®å½•">ç›®å½•</a></li><li><a href="#reactdomhostconfig">ReactDOMHostConfig</a></li><li><a href="#updatecontainer">updateContainer</a></li><li><a href="#scheduleupdateonfiber">scheduleUpdateOnFiber</a><ul><li><a href="#ä¸€ä¸ªé—­ç¯">ä¸€ä¸ªé—­ç¯</a></li><li><a href="#æ›´æ–°çš„æ¥æº">æ›´æ–°çš„æ¥æº</a></li></ul></li><li><a href="#ensurerootisscheduled">ensureRootIsScheduled</a><ul><li><a href="#discreteeventpriority-å’Œ-continuouseventpriority">DiscreteEventPriority å’Œ ContinuousEventPriority</a></li><li><a href="#schedulemicrotask-ä¸-queuemicrotask">scheduleMicrotask ä¸ queueMicrotask</a></li></ul></li><li><a href="#schedulesynccallback-å’Œ-schedulecallback">scheduleSyncCallback å’Œ scheduleCallback</a><ul><li><a href="#schedulesynccallback-å’Œ-flushsynccallbacks">scheduleSyncCallback å’Œ flushSyncCallbacks</a></li><li><a href="#schedulecallback">scheduleCallback</a></li></ul></li><li><a href="#performsyncworkonroot">performSyncWorkOnRoot</a></li><li><a href="#performconcurrentworkonroot">performConcurrentWorkOnRoot</a><ul><li><a href="#finishconcurrentrender">finishConcurrentRender</a></li></ul></li><li><a href="#renderrootsync">renderRootSync</a></li><li><a href="#renderrootconcurrent">renderRootConcurrent</a><ul><li><a href="#handleerror">handleError</a></li></ul></li><li><a href="#workloopsync">workLoopSync</a></li><li><a href="#workloopconcurrent">workLoopConcurrent</a></li><li><a href="#performunitofwork">performUnitOfWork</a></li><li><a href="#beginwork">beginWork</a></li><li><a href="#completeunitofwork">completeUnitOfWork</a></li><li><a href="#completework">completeWork</a></li><li><a href="#commitroot">commitRoot</a></li></ul></div><p></p> <h2 id="reactdomhostconfig"><a href="#reactdomhostconfig" class="header-anchor">#</a> ReactDOMHostConfig</h2> <p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¢ç©¶ä¸€ä¸‹ç”Ÿäº§æ›´æ–°çš„æ¥æºï¼Œä¸»è¦åˆ†æ updateContainer å’Œ scheduleUpdateOnFiber ä¸¤ä¸ªå‡½æ•°ã€‚</p> <h2 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h2> <p>æ›´æ–°æ˜¯å¦‚ä½•å¼€å§‹çš„ï¼Ÿæˆ‘ä»¬é¦–å…ˆä» updateContainer çš„è°ƒç”¨æ¥æºå¼€å§‹è¿½æº¯ã€‚</p> <p>è°ƒç”¨ updateContainer çš„å‡½æ•°åŒ…æ‹¬ï¼š legacyRenderSubtreeIntoContainerã€ReactDOMRoot.prototype.renderã€ReactDOMRoot.prototype.unmountã€hydrateRootã€scheduleRootã€‚ReactDOMRoot ç”± ReactDOM.createRoot åˆ›å»ºã€‚scheduleRoot åœ¨  <code>src/react/packages/react-reconciler/src/ReactFiberHotReloading.new.js</code>  æ–‡ä»¶ä¸­ã€‚</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>// åº”ç”¨å±‚ API
legacyRenderSubtreeIntoContainer &lt;- ReactDOM.hydrate
                                 &lt;- ReactDOM.render
                                 &lt;- ReactDOM.unmountComponentAtNode
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ç”±ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼ŒupdateContainer ä¸»è¦æ¥æºäºåº”ç”¨å±‚ API çš„è°ƒç”¨ï¼Œè¿™ç§è°ƒç”¨ç”Ÿäº§äº†æ›´æ–°æ¸²æŸ“çš„éœ€æ±‚ã€‚é‚£ä¹ˆ updateContainer ä¸»è¦åšäº†ä»€ä¹ˆï¼Ÿ</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  <span class="token comment">// å¾…æŒ‚è½½çš„ç»„ä»¶</span>
  element<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token comment">// æŒ‚è½½å®¹å™¨</span>
  container<span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">Function</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// è·å– RootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ›´æ–° container çš„ context ä¿¡æ¯</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ›´æ–°</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Caution: React DevTools currently depends on this property</span>
  <span class="token comment">// being called &quot;element&quot;.</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>

  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å°†æ–°å»ºçš„æ›´æ–°å…¥æ ˆ</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¯·æ±‚ä¸€æ¬¡è°ƒåº¦æ›´æ–°</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">entangleTransitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>updateContainer å…³é”®åŠŸèƒ½å¦‚ä¸‹ï¼š</p> <ul><li>ç»§ç»­å®Œå–„ FiberRoot ä¿¡æ¯ï¼šcontextã€pendingContextã€‚</li> <li>åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ªæ›´æ–°å¯¹è±¡ï¼Œæ·»åŠ å±æ€§ payloadã€callbackï¼Œå¹¶ä¸”å°†æ›´æ–°åŠ å…¥æ›´æ–°é˜Ÿåˆ—ã€‚</li> <li>è°ƒç”¨ scheduleUpdateOnFiberï¼Œ(å‘è°ƒåº¦å™¨) å‘å‡ºä¸€æ¬¡è°ƒåº¦çš„è¯·æ±‚ã€‚</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ‰©å±•</p> <ol><li>createUpdate åˆ›å»ºæ›´æ–°åœ¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæˆ–è€…ç”¨æˆ·è¡Œä¸ºä¸­ä¹Ÿä¼šäº§ç”Ÿï¼Œå¦‚å‡½æ•°å¼ç»„ä»¶ï¼ˆFCï¼‰ä¸­çš„ setStateã€useContext çš„ dispatchActionã€ç±»ç»„ä»¶çš„ this.setState ä¸­ï¼Œä¸¤ç§ä¸åŒä¹‹å¤„åœ¨äºå‰è€…æ˜¯åº”ç”¨å±‚é¢çš„è°ƒç”¨ï¼Œåè€…åˆ™æ˜¯ç»„ä»¶å±‚é¢çš„è°ƒç”¨ã€‚</li> <li>æ³¨æ„ï¼ŒscheduleUpdateOnFiber çš„è°ƒåº¦è¯·æ±‚å¹¶ä¸ä¸€å®šç»è¿‡è°ƒåº¦å™¨ï¼ŒåŒæ­¥æ›´æ–°å¯èƒ½ä¼šè·³è¿‡è°ƒåº¦å™¨çš„è°ƒåº¦ï¼Œåé¢ä¼šè¯´æ˜è¿™ä¸€ç‚¹ã€‚</li></ol></div> <h2 id="scheduleupdateonfiber"><a href="#scheduleupdateonfiber" class="header-anchor">#</a> scheduleUpdateOnFiber</h2> <p>åœ¨ updateContainer ä¸­ï¼Œè°ƒç”¨äº† scheduleUpdateOnFiber ä»¥åœ¨ fiberï¼ˆæ­¤å¤„æŒ‡çš„æ˜¯ RootFiberï¼‰ ä¸Šè°ƒåº¦ä¸€æ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆè°ƒåº¦æ›´æ–°æ˜¯å¦‚ä½•åœ¨ fiber ä¸Šå±•å¼€çš„å‘¢ï¼Ÿ</p> <p>é¦–å…ˆæ¥åˆ†æä¸€ä¸‹ä»£ç ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// Lanes that were updated during the render phase (*not* an interleaved event).</span>
<span class="token keyword">let</span> workInProgressRootRenderPhaseUpdatedLanes<span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
<span class="token comment">// Whether to root completed, errored, suspended, etc.</span>
<span class="token keyword">let</span> workInProgressRootExitStatus<span class="token operator">:</span> RootExitStatus <span class="token operator">=</span> RootIncomplete<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">,</span> b<span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">)</span><span class="token operator">:</span> Lanes <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">|</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token comment">//  RootFiber</span>
  fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// è°ƒåº¦ä¼˜å…ˆçº§</span>
  lane<span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  eventTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ£€æŸ¥åµŒå¥—æ›´æ–°ï¼Œé˜²æ­¢æ­»å¾ªç¯</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä» fiber å‘ä¸Šæ”¶é›† lanesï¼Œrootï¼šFiberRoot = fiber.stateNodeã€‚å¯¹äº updateContainer æ¥è¯´ï¼Œè¿™é‡Œ fiber å°±æ˜¯ RootFiberã€‚</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// FiberRoot ä¸å­˜åœ¨ï¼Œè¯´æ˜ FiberTree å¯èƒ½å·²ç»è¢«åºŸå¼ƒï¼Œä¸ç”¨æ›´æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Mark that the root has a pending update.</span>
  <span class="token comment">// æ ‡è®° root å³å°†æ›´æ–°ï¼Œroot.pendingLanes |= lane</span>
  <span class="token function">markRootUpdated</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå½“å‰å·²ç»æ˜¯ Render é˜¶æ®µï¼Œä¸” root æ˜¯å¾…å¤„ç†çš„ HostRootï¼Œè¿™æ—¶è·³è¿‡æ¸²æŸ“çš„è°ƒåº¦è¯·æ±‚ï¼Œå¹¶ä¸”è¿½è¸ª laneï¼ŒåŠ å…¥åˆ° Render é˜¶æ®µçš„ lanesï¼Œå°±åœ¨åœ¨å½“å‰è°ƒåº¦çš„å›è°ƒä¸­å‚ä¸æ¸²æŸ“ï¼Œæˆ–è€…ç­‰å¾…ä¸‹æ¬¡æ¸²æŸ“ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes <span class="token operator">&amp;&amp;</span>
    root <span class="token operator">===</span> workInProgressRoot
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Track lanes that were updated during the render phase</span>
    <span class="token comment">// æ”¶é›†å½“å‰çš„ lane åˆ° workInProgressRootRenderPhaseUpdatedLanesï¼Œè¡¨ç¤ºåœ¨å½“å‰ render ä¸­å½“å‰æ­£åœ¨æ¸²æŸ“çš„ RootFiber ä¸Šçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚</span>
    workInProgressRootRenderPhaseUpdatedLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
      workInProgressRootRenderPhaseUpdatedLanes<span class="token punctuation">,</span>
      lane<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™é‡Œæ˜¯æ­£å¸¸çš„è¯·æ±‚æ¸²æŸ“è°ƒåº¦çš„æµç¨‹</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ workInProgressRootExitStatus ä¸º RootSuspendedWithDelayï¼Œåˆ™æ ‡è®° root ä¸º suspendã€‚è¿™é‡Œæ˜¯å¤„ç† suspended ç»„ä»¶ã€‚å‘ root åšæ ‡è®°ä»¥åœ¨åé¢çš„æ¸²æŸ“ä¸­åŠ ä»¥åŒºåˆ†ã€‚</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRootExitStatus <span class="token operator">===</span> RootSuspendedWithDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The root already suspended with a delay, which means this render</span>
        <span class="token comment">// definitely won't finish. Since we have a new update, let's mark it as</span>
        <span class="token comment">// suspended now, right before marking the incoming update. This has the</span>
        <span class="token comment">// effect of interrupting the current render and switching to the update.</span>
        <span class="token comment">// TODO: Make sure this doesn't override pings that happen while we've</span>
        <span class="token comment">// already started rendering.</span>
        <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> workInProgressRootRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç¡®ä¿ HostRoot ï¼ˆå‘è°ƒåº¦å™¨ï¼‰å‘èµ·è°ƒåº¦è¯·æ±‚ï¼Œ</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      lane <span class="token operator">===</span> SyncLane <span class="token operator">&amp;&amp;</span>
      executionContext <span class="token operator">===</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// Treat `act` as if it's inside `batchedUpdates`, even in legacy mode.</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> ReactCurrentActQueue<span class="token punctuation">.</span>isBatchingLegacy<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ˜¯åŒæ­¥æ›´æ–°ï¼Œcontext è¿˜æ˜¯ NoContext é˜¶æ®µï¼Œfiber.mode ä¸æ˜¯ ConcurrentModeï¼Œä¸” prd ç¯å¢ƒ ReactCurrentActQueue.isBatchingLegacy ä¸º true</span>
      <span class="token comment">// åœ¨åˆæ¬¡åŠ è½½æ—¶é‡ç½® workInProgressRootRenderTargetTime å¹¶ä¸” flushSyncCallbacksã€‚</span>
      <span class="token comment">// åªåœ¨åˆå§‹åŒ–åº”ç”¨æ—¶æ‰§è¡Œ</span>
      <span class="token comment">// Flush the synchronous work now, unless we're already working or inside</span>
      <span class="token comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
      <span class="token comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
      <span class="token comment">// without immediately flushing it. We only do this for user-initiated</span>
      <span class="token comment">// updates, to preserve historical behavior of legacy mode.</span>
      <span class="token function">resetRenderTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">flushSyncCallbacksOnlyInLegacyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒåŠŸèƒ½å¦‚ä¸‹ï¼š</p> <ul><li>ä» fiber å‘çˆ¶çº§æ”¶é›† lanesï¼Œå¹¶ä¸”è®¡ç®—å‡º HostRootã€‚</li> <li>è°ƒç”¨ ensureRootIsScheduledï¼Œç¡®ä¿ HostRoot å‘èµ·åŒæ­¥æˆ–è€…å¼‚æ­¥è°ƒåº¦ã€‚</li> <li>å¦‚æœæ˜¯åˆæ¬¡å¯åŠ¨åº”ç”¨ï¼Œæ‰§è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚</li></ul> <p>ä¸‹é¢æˆ‘ä»¬å°†ä»¥ scheduleUpdateOnFiber å‡½æ•°ä½œä¸ºçªç ´å£ï¼Œä¸€å±‚å±‚çš„å¾€ä¸‹è¿½æº¯ï¼Œçœ‹çœ‹ React çš„æ›´æ–°å…·ä½“æ˜¯æ€æ ·çš„æµç¨‹ï¼Œä»¥åŠæ›´æ–°äº§ç”Ÿçš„æ¥æºåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p> <div class="custom-block warning"><p class="custom-block-title">å›¾æ³¨</p> <p>&lt;- è¡¨ç¤ºä»£ç å‘ä¸‹è¿½æº¯ï¼Œå³å‰é¢çš„å‡½æ•°è¢«åé¢çš„å‡½æ•°è°ƒç”¨æˆ–è€…ä½¿ç”¨ã€‚&lt;&lt;&lt; è¡¨ç¤ºçœç•¥è¿½æº¯è¿‡ç¨‹ï¼Œå› ä¸ºä»å‰é¢çš„è¿‡ç¨‹ä¸­å¯ä»¥æ¨å‡ºã€‚... è¡¨ç¤ºå¿½ç•¥æ­¤è¿‡ç¨‹ã€‚</p></div> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>scheduleUpdateOnFiber &lt;- updateDehydratedSuspenseComponent &lt;- updateSuspenseComponent &lt;- attemptEarlyBailoutIfNoScheduledUpdate &lt;- beginWork
                                                                                      &lt;- beginWork
                      &lt;- classComponentUpdater[enqueueSetStateã€enqueueReplaceStateã€enqueueForceUpdate] &lt;- adoptClassInstance &lt;- mountIndeterminateComponent &lt;- beginWork
                                                                                                                              &lt;- constructClassInstance &lt;- updateClassComponent &lt;- mountLazyComponent &lt;- beginWork
                                                                                                                                                                                &lt;- beginWork
                                                                                                                                                        &lt;- mountIncompleteClassComponent &lt;- beginWork
                                                                                                        &lt;- callComponentWillMount &lt;- mountClassInstance &lt;- updateClassComponent &lt;- mountLazyComponent &lt;- beginWork
                                                                                                                                                                                &lt;- beginWork
                                                                                                                                                        &lt;- mountIncompleteClassComponent &lt;- beginWork
                                                                                                        &lt;- callComponentWillReceiveProps &lt;- resumeMountClassInstance &lt;- updateClassComponent &lt;&lt;&lt; beginWork
                                                                                                                                         &lt;- updateClassInstance &lt;&lt;&lt; beginWork
                      &lt;- [DEV]forceStoreRerender &lt;- updateStoreInstance &lt;- mountSyncExternalStore ...
                                                                   &lt;- updateSyncExternalStore ...
                                            &lt;- subscribeToStore ...
                      &lt;- [enableCache]refreshCache &lt;- mountRefresh ...
                      &lt;- dispatchReducerAction &lt;- mountReducer &lt;- reducer.dispatch[useReducer]
                      &lt;- dispatchSetState &lt;- useMutableSource &lt;- stateHook.queue.dispatch &lt;- dispatchAction[queue.reducer(state, dispatch)]  &lt;- useState
                                          &lt;- mountState &lt;- HooksDispatcherOnMount.useState &lt;- ReactCurrentDispatcher.current &lt;- useState
                                                        &lt;- mountTransition &lt;- HooksDispatcherOnMount.useTransition &lt;- useTransition
                                                        &lt;- mountDeferredValue &lt;- HooksDispatcherOnMount.useDeferredValue &lt;- useDeferredValue
                      &lt;- updateContainer &lt;&lt;&lt; ReactDOM[hydrateã€renderã€unmountComponentAtNodeã€createRootã€hydrateRootã€scheduleRoot]
                      &lt;!-- &lt;- attemptSynchronousHydration --&gt;
                      &lt;!-- &lt;- attemptDiscreteHydration --&gt;
                      &lt;!-- &lt;- attemptContinuousHydration --&gt;
                      &lt;!-- &lt;- attemptHydrationAtCurrentPriority --&gt;

beginWork &lt;- workLoopConcurrent &lt;- renderRootConcurrent &lt;- performConcurrentWorkOnRoot &lt;- ensureRootIsScheduled[root.callbackNode] &lt;- scheduleUpdateOnFiber &lt;&lt;&lt; beginWork
          &lt;- performUnitOfWork &lt;- workLoopSync &lt;- renderRootSync &lt;- performConcurrentWorkOnRoot &lt;&lt;&lt; beginWork
                               &lt;- workLoopConcurrent &lt;- renderRootConcurrent &lt;- performConcurrentWorkOnRoot &lt;&lt;&lt; beginWork

commitRoot &lt;- finishConcurrentRender[RootErroredã€RootSuspendedã€RootSuspendedWithDelayã€RootCompleted] &lt;- performConcurrentWorkOnRoot
           &lt;- performSyncWorkOnRoot
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>ä»ä¸Šé¢çš„åˆ†æè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¾ˆå¤šé‡è¦çš„ä¿¡æ¯ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p> <h3 id="ä¸€ä¸ªé—­ç¯"><a href="#ä¸€ä¸ªé—­ç¯" class="header-anchor">#</a> ä¸€ä¸ªé—­ç¯</h3> <p>ä»ä¸Šé¢å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºï¼Œä» scheduleUpdateOnFiber å¾€ä¸Šè¿½æº¯æ—¶ï¼Œæœ€ç»ˆè¿½æº¯åˆ°äº† beginWorkï¼Œç„¶åä» beginWork ç»§ç»­è¿½æº¯ï¼Œæœ€ç»ˆè¿½æº¯åˆ° scheduleUpdateOnFiberã€‚å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>é’©å­ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰å’Œäº‹ä»¶ç³»ç»Ÿ -&gt; åº”ç”¨å±‚è¡Œä¸ºï¼šdispatchSetStateã€classComponentUpdaterã€dispatchReducerActionã€updateContainer 
-&gt; scheduleUpdateOnFiber -&gt; ensureRootIsScheduled -&gt; performSyncWorkOnRootã€performConcurrentWorkOnRoot 
-&gt; renderRootSyncã€renderRootConcurrent -&gt; workLoopSyncã€workLoopConcurrent 
-&gt; performUnitOfWork -&gt; beginWork -&gt; mountã€update ç»„ä»¶ -&gt; è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€å“åº”äº‹ä»¶ç³»ç»Ÿ -&gt; commitRoot -&gt; ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p> <ul><li>åº”ç”¨å±‚è¡Œä¸ºåˆ†åˆ«å¯ä»¥å¯¹åº” FC setStateã€ç±»ç»„ä»¶ this.setStateã€useReducer çš„ dispatch å’Œ ReactDOM çš„ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚ hydrateã€renderã€unmountComponentAtNodeã€createRootã€hydrateRootã€scheduleRootã€‚</li> <li>ä» ensureRootIsScheduled -&gt; performConcurrentWorkOnRoot ä¸­é—´è¿˜æœ‰è°ƒåº¦å™¨çš„è°ƒåº¦è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ scheduleSyncCallback å’Œ scheduleCallbackï¼Œåˆ†åˆ«å¯¹åº”åŒæ­¥ä»»åŠ¡çš„è°ƒåº¦å’Œå¼‚æ­¥ä»»åŠ¡çš„è°ƒåº¦ã€‚</li> <li>åœ¨ performSyncWorkOnRootã€performConcurrentWorkOnRoot æ‰§è¡Œä¹‹åï¼Œæœ‰ä¸€ä¸ª commitRoot çš„æ“ä½œã€‚</li> <li>beginWork -&gt; mountã€update ç»„ä»¶ è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠçš„å†…å®¹è¾ƒä¸ºç¹çï¼Œå¯ä»¥å‚è€ƒæ›´æ–°å™¨çš„éƒ¨åˆ†ï¼Œæœ¬æ–‡ä¸åœ¨èµ˜è¿°ç»†èŠ‚ã€‚</li> <li>commitRoot åœ¨ performSyncWorkOnRootï¼ˆåŒæ­¥æ¸²æŸ“ï¼‰ã€æˆ–è€… finishConcurrentRenderï¼ˆå¼‚æ­¥æ¸²æŸ“ï¼‰ä¸­è°ƒç”¨ã€‚è¿™å¹¶ä¸æ˜¯è¯´åœ¨åŒæ­¥æ¸²æŸ“ä¸­ commitRoot å’Œåé¢çš„ renderRootSync æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œè€Œæ˜¯è¯´ renderRootSync æ˜¯åŒæ­¥çš„ï¼ŒrenderRootSync æ‰§è¡Œå®Œä¹‹åç›´æ¥å°±æ‰§è¡Œäº† commitRootã€‚ä»åªæœ‰ finishConcurrentRenderï¼Œè€Œæ²¡æœ‰ç±»ä¼¼äº finishSyncRender å¯ä»¥å°è¯è¿™ä¸€ç‚¹ã€‚</li></ul> <p>ä¸€ä¸ªå®Œæ•´çš„åŒæ­¥çš„æ¸²æŸ“å›è°ƒçš„è°ƒç”¨å‡½æ•°æ ˆï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p> <img src="/assets/img/react-call-stack.png" alt="react-call-stack" data-zoomable=""> <h3 id="æ›´æ–°çš„æ¥æº"><a href="#æ›´æ–°çš„æ¥æº" class="header-anchor">#</a> æ›´æ–°çš„æ¥æº</h3> <p>æ›´æ–°ä¸»è¦æ¥æºäºåº”ç”¨å±‚çš„ä¸€äº›è¡Œä¸ºï¼šdispatchSetStateã€classComponentUpdaterã€dispatchReducerActionã€updateContainer å’Œ ReactDOM çš„ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚ hydrateã€renderã€unmountComponentAtNodeã€createRootã€hydrateRootã€scheduleRootã€‚å¤§è‡´åŒ…æ‹¬åº”ç”¨ mount é˜¶æ®µå¯¹ ReactDOM API è°ƒç”¨å¼•èµ·çš„åŒæ­¥æ›´æ–°ï¼Œç±»ç»„ä»¶å’Œ FC çŠ¶æ€æ›´æ–°ã€useReducer çš„ dispatch çš„è°ƒç”¨ï¼Œä»¥åŠæœ€æ–° ConcurrentAPI å¦‚ useTransitionã€useDeferredValue ç­‰ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬ä»ä¸€ä¸ªæ›´ä¸ºç›´æ¥çš„è§’åº¦æ¥æ¢ç©¶ React æ›´æ–°çš„æ¥æºã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœéœ€è¦æ›´æ–°ï¼Œåˆ™ä¼šå°†æ›´æ–°å…¥æ ˆï¼Œæˆ‘ä»¬ä»è¿™ä¸ªè§’åº¦æ¥åˆ†æä¸€ä¸‹ï¼Œåœ¨ä»£ç ä¸­æœç´¢  <code>enqueueUpdate(</code> ï¼š</p> <p>è°ƒç”¨  <code>enqueueUpdate(</code>  ä¸»è¦åœ¨å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p> <ul><li>src/react/packages/react-reconciler/src/ReactFiberClassComponent.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberHooks.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberThrow.new.js</li> <li>src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</li></ul> <p>ç„¶ååˆ†æä¸‹åˆ†åˆ«åœ¨å“ªäº›å‡½æ•°ä¸­å‡ºç°ï¼š</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>&gt;&gt; ReactFiberClassComponent
classComponentUpdater[enqueueSetStateã€enqueueReplaceStateã€enqueueForceUpdate]

&gt;&gt; ReactFiberHooks
dispatchReducerAction
dispatchSetState

&gt;&gt; ReactFiberReconciler
updateContainer

// ä»¥ä¸‹çš„ Update ä¸º ErrorUpdate

&gt;&gt; ReactFiberThrow
markSuspenseBoundaryShouldCapture &lt;- throwException &lt;- handleError &lt;- renderRootSync/renderRootConcurrent

&gt;&gt; ReactFiberWorkLoop
captureCommitPhaseErrorOnRoot &lt;- captureCommitPhaseError &lt;- safelyCallCommitHookLayoutEffectListMount/safelyCallComponentWillUnmount/safelyCallComponentDidMount/safelyAttachRef/safelyDetachRef/safelyCallDestroy/commitBeforeMutationEffects_complete/commitMutationEffects_begin/commitMutationEffects_complete/commitLayoutMountEffects_complete/reappearLayoutEffects_complete/commitPassiveMountEffects_complete
captureCommitPhaseError &lt;&lt;&lt; ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>å¯ä»¥çœ‹å‡ºï¼Œä¸å‰æ–‡çš„åˆ†æåŸºæœ¬ä¸€è‡´ã€‚</p> <p>å…³äº useTransitionã€useDeferredValue å¯ä»¥å‚è€ƒï¼š<a href="https://ithelp.ithome.com.tw/articles/10281124" target="_blank" rel="noopener noreferrer">æ·ºè«‡ React Concurrent Mode &amp; ç›¸é—œåŠŸèƒ½ (Fiberã€Suspenseã€useTransitionã€useDeferredValue)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block tip"><p class="custom-block-title">æ‰©å±•</p> <ol><li>scheduleUpdateOnFiber ä¸€æ–¹é¢è¢« updateContainer è¿™æ ·é—´æ¥è¢«å¤–éƒ¨åº”ç”¨å±‚ API è°ƒç”¨ï¼Œå¦ä¸€æ–¹é¢åœ¨ç»„ä»¶å±‚é¢ç”±ç»„ä»¶çŠ¶æ€æ›´æ–°ã€context æ›´æ–°ã€props æ›´æ–°ç­‰è¡Œä¸ºåœ¨ react å†…éƒ¨è°ƒç”¨ï¼ˆå¯ä»¥å‚è€ƒä¸Šæ–‡ scheduleUpdateOnFiber è°ƒç”¨æ¥æºï¼‰ã€‚</li> <li>checkForNestedUpdates å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢è¡Œä¸ºæ›´æ–°çš„æ­»å¾ªç¯ï¼Œå› ä¸ºæ›´æ–°éƒ½è¦ç»è¿‡ scheduleUpdateOnFiber å‡½æ•°æäº¤è°ƒåº¦æ›´æ–°ï¼ŒscheduleUpdateOnFiber åœ¨ react å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨éƒ½ä¼šè¢«é¢‘ç¹è°ƒç”¨ã€‚checkForNestedUpdates åœ¨å†…éƒ¨ç»´æŠ¤å˜é‡ nestedUpdateCount è¡¨ç¤ºåœ¨å½“å‰çš„ commit ä¸­ FiberRoot æ›´æ–°çš„å¾ªç¯è¯·æ±‚æ¬¡æ•°ã€‚</li> <li>å…³äº react ä¸­å¸¸è§çš„ä½è¿ç®—ï¼Œå¯ä»¥å‚è€ƒ <a href="/react/summary/bitOperation">ä½è¿ç®—åˆæ¢</a> å’Œ <a href="/react/summary/first-render.html#ä½¿ç”¨ä½è¿ç®—æé«˜æšä¸¾è®¡ç®—æ•ˆç‡">ä½¿ç”¨ä½è¿ç®—æé«˜æšä¸¾è®¡ç®—æ•ˆç‡</a>ã€‚</li> <li>è¿™é‡Œåˆ¤æ–­ root === workInProgressRoot æ‰§è¡Œ suspended ç»„ä»¶çš„ä¸€äº›é€»è¾‘æ˜¯å› ä¸ºï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œ workInProgressRoot åº”è¯¥ä¸º nullï¼Œåªæœ‰å½“å‰çš„ FiberRoot è¢«æ ‡è®°ä¸º workInProgressRoot å†å›åœ¨è¿™é‡Œç‰¹æ®Šå¤„ç†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒworkInProgressRoot åªæœ‰åœ¨ prepareFreshStack å‡½æ•°è¢«èµ‹å€¼ä¸º root çš„ï¼Œè€Œ prepareFreshStack åªæœ‰åœ¨ renderRootSyncã€renderRootConcurrentã€pingSuspendedRoot å‡½æ•°ä¸­æ­£å¸¸æ‰§è¡Œæˆ–è€…åœ¨ performConcurrentWorkOnRootã€performSyncWorkOnRoot ä¸­å‘ç”Ÿ FatalError æ—¶æ‰§è¡Œã€‚</li></ol></div> <h2 id="ensurerootisscheduled"><a href="#ensurerootisscheduled" class="header-anchor">#</a> ensureRootIsScheduled</h2> <p>åœ¨ä¸Šé¢å¯¹ scheduleUpdateOnFiber çš„åˆ†æä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯è°ƒç”¨ ensureRootIsScheduledï¼Œä»¥ä¿è¯åœ¨ fiber æ‰€åœ¨çš„ HostRoot ä¸Šè°ƒåº¦æ›´æ–°ï¼Œé‚£ä¹ˆ HostRoot ä¸Šæ˜¯å¦‚ä½•ç»§ç»­è°ƒåº¦çš„å‘¢ï¼Ÿ</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> currentTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>

  <span class="token comment">// Check if any lanes are being starved by other work. If so, mark them as</span>
  <span class="token comment">// expired so we know to work on those next.</span>
  <span class="token comment">// å°†é¥¿æ­»çš„ lanes æ ‡è®°ä¸ºè¶…æ—¶ä»¥ä¸€å¹¶æ›´æ–°ï¼Œè¶…æ—¶çš„ä»»åŠ¡ç«‹å³æ‰§è¡Œã€‚</span>
  <span class="token function">markStarvedLanesAsExpired</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine the next lanes to work on, and their priority.</span>
  <span class="token comment">// è®¡ç®—å°†è¦æ¸²æŸ“çš„ lanes</span>
  <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ— éœ€è¦æ¸²æŸ“çš„ lanes</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Special case: There's nothing to work on.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We use the highest priority lane to represent the priority of the callback.</span>
  <span class="token comment">// è·å– lanes ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ lane ä½œä¸º callback çš„ä¼˜å…ˆçº§</span>
  <span class="token keyword">const</span> newCallbackPriority <span class="token operator">=</span> <span class="token function">getHighestPriorityLane</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Check if there's an existing task. We may be able to reuse it.</span>
  <span class="token keyword">const</span> existingCallbackPriority <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackPriority<span class="token punctuation">;</span>
  <span class="token comment">// ç”±äºå³å°†è¦ç”Ÿæˆæ–°çš„ callbackï¼Œå…ˆå°†ç°åœ¨çš„ callback å–æ¶ˆæ‰</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cancel the existing callback. We'll schedule a new one below.</span>
    <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Schedule a new callback.</span>
  <span class="token keyword">let</span> newCallbackNode<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœæ˜¯åŒæ­¥æ›´æ–°ä»»åŠ¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackPriority <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Special case: Sync React callbacks are scheduled on a special</span>
    <span class="token comment">// internal queue</span>
    <span class="token comment">// LegacyRoot éœ€è¦å•ç‹¬å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>tag <span class="token operator">===</span> LegacyRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">scheduleLegacySyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¯·æ±‚åŒæ­¥è°ƒåº¦å›è°ƒ performSyncWorkOnRootï¼Œå°†è¯¥å›è°ƒåŠ å…¥åŒæ­¥å›è°ƒé˜Ÿåˆ—</span>
      <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsMicrotasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// Flush the queue in a microtask.</span>
     <span class="token comment">//  æ”¯æŒå¾®ä»»åŠ¡çš„æµè§ˆå™¨ä¸ç”¨å†è¯·æ±‚è°ƒåº¦å™¨çš„å›è°ƒ</span>
     <span class="token function">scheduleMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// In Safari, appending an iframe forces microtasks to run.</span>
       <span class="token comment">// https://github.com/facebook/react/issues/22459</span>
       <span class="token comment">// We don't support running callbacks in the middle of render</span>
       <span class="token comment">// or commit so we need to check against that.</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// It's only safe to do this conditionally because we always</span>
         <span class="token comment">// check for pending work before we exit the task.</span>
         <span class="token comment">// æ¶ˆè´¹å®ŒåŒæ­¥å›è°ƒé˜Ÿåˆ—</span>
         <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Flush the queue in an Immediate task.</span>
      <span class="token comment">// å‘è°ƒåº¦å™¨è¯·æ±‚å›è°ƒï¼Œä¼˜å…ˆçº§ ImmediatePriorityï¼ˆç«‹å³å›è°ƒï¼‰ï¼Œå›è°ƒåæ‰§è¡Œ flushSyncCallbacks å°†åŒæ­¥å›è°ƒé˜Ÿåˆ—æ¶ˆè´¹å®Œ</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediateSchedulerPriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åŒæ­¥æ›´æ–°æ‰§è¡Œå®Œæ¯•ï¼Œå°† newCallbackNode ç½®ä¸º nullï¼ŒperformSyncWorkOnRoot ä¸ä¼šç”¨åˆ°æ­¤å€¼</span>
    newCallbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> schedulerPriorityLevel<span class="token punctuation">;</span>
    <span class="token comment">// å°† lanes è½¬åŒ–ä¸ºäº‹ä»¶ä¼˜å…ˆçº§</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç¦»æ•£äº‹ä»¶ä¼˜å…ˆçº§ï¼šImmediateSchedulerPriority</span>
      <span class="token keyword">case</span> DiscreteEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> ImmediateSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// è¿ç»­äº‹ä»¶ä¼˜å…ˆçº§ï¼šUserBlockingSchedulerPriority</span>
      <span class="token keyword">case</span> ContinuousEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> UserBlockingSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// é»˜è®¤äº‹ä»¶ä¼˜å…ˆçº§ï¼šNormalSchedulerPriority</span>
      <span class="token keyword">case</span> DefaultEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// Idle äº‹ä»¶ä¼˜å…ˆçº§ï¼šIdleSchedulerPriority</span>
      <span class="token keyword">case</span> IdleEventPriority<span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> IdleSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‘è°ƒåº¦å™¨è¯·æ±‚ç›¸åº”ä¼˜å…ˆçº§çš„å¼‚æ­¥å›è°ƒï¼Œå›è°ƒåæ‰§è¡Œ performConcurrentWorkOnRootï¼ŒScheduler.scheduleCallback è¿”å›è°ƒåº¦çš„ callbackNode(newTask)</span>
    newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>
      schedulerPriorityLevel<span class="token punctuation">,</span>
      <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ›´æ–° callbackPriority å’Œ callbackNode æ³¨æ„ï¼Œæ­¤æ—¶å¼‚æ­¥å›è°ƒå¹¶æœªæ‰§è¡Œ</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> newCallbackNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p>è¿™ä¸ªå‡½æ•°æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ä½œç”¨ï¼š</p> <ul><li>æ›´æ–° root çš„ callbackNodeã€callbackPriority å±æ€§ã€‚</li> <li>åŒæ­¥æ›´æ–°è°ƒåº¦ï¼šæ”¯æŒå¾®ä»»åŠ¡çš„ç›´æ¥åœ¨å¾®ä»»åŠ¡çš„å›è°ƒæ‰§è¡Œ flushSyncCallbacksï¼›è°ƒç”¨ scheduleSyncCallback å°†åŒæ­¥å›è°ƒ performSyncWorkOnRoot æ¨å…¥åŒæ­¥å›è°ƒé˜Ÿåˆ— syncQueueï¼Œå¹¶ä¸”ä»¥ ImmediateSchedulerPriority çš„ä¼˜å…ˆçº§å‘è°ƒåº¦å™¨è¯·æ±‚åŒæ­¥å›è°ƒï¼Œå›è°ƒæ—¶æ‰§è¡Œ flushSyncCallbacks æ¶ˆè´¹åŒæ­¥é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„åŒæ­¥å›è°ƒã€‚</li> <li>å¼‚æ­¥æ›´æ–°è°ƒåº¦ï¼šæ ¹æ® nextLanes è®¡ç®—äº‹ä»¶ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”è½¬åŒ–ä¸ºè°ƒåº¦ä¼˜å…ˆçº§ï¼Œä»¥ç›¸åº”çš„è°ƒåº¦ä¼˜å…ˆçº§å‘è°ƒåº¦å™¨å‘èµ·å¼‚æ­¥å›è°ƒï¼Œå›è°ƒæ—¶æ‰§è¡Œ performConcurrentWorkOnRootã€‚</li> <li>æ³¨æ„åŒæ­¥è°ƒåº¦ä¸­è°ƒç”¨äº† scheduleSyncCallbackã€scheduleCallback ä¸¤ä¸ªå‡½æ•°ä¸å¯æ··æ·†ï¼ŒscheduleCallback åªæ˜¯ Scheduler æä¾›çš„ä¸€ç§åŸºäºä¼˜å…ˆçº§æœºåˆ¶çš„ä»»åŠ¡ï¼ˆå›è°ƒï¼‰è°ƒåº¦æ‰‹æ®µï¼ŒperformSyncWorkOnRoot å’Œ performConcurrentWorkOnRoot æ‰æ˜¯çœŸæ­£è¦é€šè¿‡è°ƒåº¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚åŒæ­¥çš„ä»»åŠ¡é€šè¿‡åŒæ­¥å›è°ƒé˜Ÿåˆ—çš„æ–¹å¼è¿›è¡Œäº†ä¼˜åŒ–å¤„ç†ã€‚scheduleSyncCallback æ˜¯å°†åŒæ­¥çš„ä»»åŠ¡åŠ å…¥åŒæ­¥ä»»åŠ¡é˜Ÿåˆ—ã€‚è°ƒåº¦å™¨ä¸æ˜¯ä¸å¯æ›¿æ¢çš„ï¼Œå¦‚æœæµè§ˆå™¨æ”¯æŒå¾®ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡çš„å¤„ç†å°±å¯ä»¥äº¤ç»™å¾®ä»»åŠ¡å¤„ç†ï¼Œè€Œä¸ç»è¿‡è°ƒåº¦å™¨ã€‚</li></ul> <p>nextLanes ä¼˜å…ˆçº§æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿå‚è§ <a href="/react/reconciliation/lane">Lane ä¸ä¼˜å…ˆçº§</a></p> <div class="custom-block tip"><p class="custom-block-title">æ–°çŸ¥</p> <ul><li>è°ƒåº¦æ›´æ–°éƒ½æ˜¯é€šè¿‡ HostRoot å®ç°çš„ï¼Œä» ensureRootIsScheduled ä¸­ä¹‹ä¼ å…¥ root ï¼Œè€Œæ²¡æœ‰ä¼ å…¥ fiber å¯è§ HostRoot å¯¹äº react ä¸­æ•´ä¸ªè°ƒå’Œè¿‡ç¨‹çš„é‡è¦æ€§ã€‚</li></ul></div> <h3 id="discreteeventpriority-å’Œ-continuouseventpriority"><a href="#discreteeventpriority-å’Œ-continuouseventpriority" class="header-anchor">#</a> DiscreteEventPriority å’Œ ContinuousEventPriority</h3> <ul><li>ç¦»æ•£äº‹ä»¶ï¼šdiscreteEventï¼Œå¸¸è§çš„å¦‚ï¼šclick, keyup, changeï¼›</li> <li>ç”¨æˆ·é˜»å¡äº‹ä»¶ï¼šuserBlockingï¼Œå¸¸è§çš„å¦‚ï¼šdragEnter, mouseMove, scrollï¼›</li> <li>è¿ç»­äº‹ä»¶ï¼šcontinuousï¼Œå¸¸è§çš„å¦‚ï¼šerror, progress, loadï¼›</li></ul> <p>æ›´å¤šè§£æå¯ä»¥å‚è€ƒï¼š<a href="./event-listener">React ä¸­çš„äº‹ä»¶ç›‘å¬æœºåˆ¶</a></p> <h3 id="schedulemicrotask-ä¸-queuemicrotask"><a href="#schedulemicrotask-ä¸-queuemicrotask" class="header-anchor">#</a> scheduleMicrotask ä¸ queueMicrotask</h3> <p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæµè§ˆå™¨æ”¯æŒ queueMicrotaskï¼ŒåŒæ­¥è°ƒåº¦å°±ä¸ç”¨ç»è¿‡è°ƒåº¦å™¨ï¼Œè€Œæ˜¯ç›´æ¥äº¤ç”±å¾®ä»»åŠ¡å¤„ç†ï¼Œè¿™æ ·æ—¢å‡å°‘äº† performSyncWorkOnRoot æ‰§è¡Œçš„å‹åŠ›ï¼ŒåŒæ—¶åˆè¦æ¯” setTimeout è¿™æ ·çš„å®ä»»åŠ¡æ›´å¿«çš„æ‰§è¡Œã€‚queueMicrotask å¯ä»¥ç”± Promise æ¥æ¨¡æ‹Ÿã€‚queueMicrotask () æ–¹æ³•å°†å¾®ä»»åŠ¡æ’é˜Ÿä»¥è°ƒç”¨ callbackã€‚</p> <p>ä»€ä¹ˆæ˜¯ queueMicrotaskï¼Ÿ</p> <blockquote><p>queueMicrotask adds the function (task) into a queue and each function is executed one by one (<strong>FIFO</strong>) after the current task has completed its work and when there is no other code waiting to be run <strong>before control of the execution context is returned to the browser's event loop</strong>.</p></blockquote> <p>react ä¸­ queueMicrotask çš„ä½¿ç”¨ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> localPromise <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token builtin">Promise</span> <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token builtin">Promise</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> supportsMicrotasks <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> scheduleTimeout<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span>
  <span class="token keyword">typeof</span> setTimeout <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> setTimeout <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> scheduleMicrotask<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span>
  <span class="token keyword">typeof</span> queueMicrotask <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> queueMicrotask
    <span class="token operator">:</span> <span class="token keyword">typeof</span> localPromise <span class="token operator">!==</span> <span class="token string">'undefined'</span>
    <span class="token operator">?</span> callback <span class="token operator">=&gt;</span>
        localPromise
          <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleErrorInNextTick<span class="token punctuation">)</span>
    <span class="token operator">:</span> scheduleTimeout<span class="token punctuation">;</span> <span class="token comment">// TODO: Determine the best fallback here.</span>

<span class="token keyword">function</span> <span class="token function">handleErrorInNextTick</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>äº†è§£æ›´å¤šå…³äºå¾®ä»»åŠ¡å¯ä»¥å‚è€ƒï¼š</p> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide" target="_blank" rel="noopener noreferrer">åœ¨ JavaScript ä¸­é€šè¿‡ queueMicrotask () ä½¿ç”¨å¾®ä»»åŠ¡<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.freecodecamp.org/news/queuemicrotask/" target="_blank" rel="noopener noreferrer">An Introduction to JavaScript's queueMicrotask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://caniuse.com/?search=queueMicrotask" target="_blank" rel="noopener noreferrer">caniuse: queueMicrotask API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="schedulesynccallback-å’Œ-schedulecallback"><a href="#schedulesynccallback-å’Œ-schedulecallback" class="header-anchor">#</a> scheduleSyncCallback å’Œ scheduleCallback</h2> <p>åœ¨ä¸Šé¢å¯¹ ensureRootIsScheduled çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼ŒensureRootIsScheduled å¯¹åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡åˆ†åˆ«è¿›è¡Œäº†åŒæ­¥è°ƒåº¦å’Œå¼‚æ­¥è°ƒåº¦ï¼Œåˆ†åˆ«è°ƒç”¨ scheduleSyncCallback å’Œ scheduleCallbackï¼Œé‚£ä¹ˆå…·ä½“åŒæ­¥è°ƒåº¦å’Œå¼‚æ­¥è°ƒåº¦æ˜¯å¦‚ä½•è¿›è¡Œçš„å‘¢ï¼Ÿ</p> <h3 id="schedulesynccallback-å’Œ-flushsynccallbacks"><a href="#schedulesynccallback-å’Œ-flushsynccallbacks" class="header-anchor">#</a> scheduleSyncCallback å’Œ flushSyncCallbacks</h3> <p>scheduleSyncCallback ç»´æŠ¤ä¸€ä¸ªåŒæ­¥æ›´æ–°çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œè°ƒç”¨ flushSyncCallbacks å¯å…¨æ•°æ¶ˆè´¹ä»»åŠ¡ä»»åŠ¡ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberSyncTaskQueue.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> SchedulerCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Push this callback into an internal queue. We'll flush these either in</span>
  <span class="token comment">// the next tick, or earlier if something calls `flushSyncCallbackQueue`.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    syncQueue <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Push onto existing queue. Don't need to schedule a callback because</span>
    <span class="token comment">// we already scheduled one when we created the queue.</span>
    syncQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// isFlushingSyncQueue æ˜¯ syncQueue çš„äº’æ–¥é”ï¼Œæ¶ˆè´¹ callbacks æ˜¯ä¸€ä¸ªäº’æ–¥æ“ä½œ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushingSyncQueue <span class="token operator">&amp;&amp;</span> syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent re-entrance.</span>
    isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousUpdatePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> queue <span class="token operator">=</span> syncQueue<span class="token punctuation">;</span>
      <span class="token comment">// TODO: Is this necessary anymore? The only user code that runs in this</span>
      <span class="token comment">// queue is in the render or commit phases.</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// flush syncQueueï¼Œæ¯ä¸ª callback å¯ä»¥è¿”å›ä¸€ä¸ªæ–°çš„ callback</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> callback <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
          callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>isSync<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// é‡ç½® syncQueue</span>
      syncQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      includesLegacySyncCallbacks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If something throws, leave the remaining callbacks on the queue.</span>
      <span class="token comment">// å¦‚æœsyncQueue ä¸­æ¯ä¸ª RootCallback å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è·³è¿‡æ­¤é¡¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        syncQueue <span class="token operator">=</span> syncQueue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Resume flushing in the next tick</span>
      <span class="token comment">// è°ƒåº¦åœ¨ä¸‹ä¸€ä¸ªåŒæ­¥è°ƒåº¦ä¸­ç»§ç»­æ‰§è¡Œ</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediatePriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousUpdatePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>è¿™ä¸¤ä¸ªå‡½æ•°æœ‰å¦‚ä¸‹å…³é”®ä½œç”¨ï¼š</p> <ul><li>ç»´æŠ¤åŒæ­¥å›è°ƒçš„ syncQueueï¼Œä»¥åœ¨åŒæ­¥å›è°ƒåˆ°æ¥æ—¶ flush syncQueueã€‚</li></ul> <p>æ›´å¤šåˆ†æï¼Œè¯·å‚è€ƒ <a href="/react/summary/first-render.html#flushsync">React é¦–æ¬¡æ¸²æŸ“è¿‡ç¨‹</a> ä¸­çš„ flushSyncCallbacks å‡½æ•°åˆ†æã€‚</p> <h3 id="schedulecallback"><a href="#schedulecallback" class="header-anchor">#</a> scheduleCallback</h3> <p>è¿™éƒ¨åˆ†ä¼šä¸è°ƒåº¦å™¨äº¤äº’ï¼Œåœ¨ react ä¸­ï¼Œè°ƒåº¦å™¨æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚ç°åœ¨éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®å„ç§å¼‚æ­¥ä»»åŠ¡çš„ä¼˜å…ˆçº§é€‰æ‹©é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¿›è¡Œå›è°ƒï¼Œå›è°ƒä¸­æ‰§è¡Œ performSyncWorkOnRootã€‚</p> <p>è°ƒåº¦å™¨è¯¦ç»†å¯ä»¥å‚è€ƒ<a href="/react/scheduler">è°ƒåº¦å™¨</a>ç« èŠ‚å†…å®¹ã€‚</p> <h2 id="performsyncworkonroot"><a href="#performsyncworkonroot" class="header-anchor">#</a> performSyncWorkOnRoot</h2> <p>ä»ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è°ƒåº¦å™¨åŒæ­¥è°ƒåº¦çš„å›è°ƒï¼ˆå¯ä»¥ä¸é€šè¿‡è°ƒåº¦å™¨ï¼‰æ˜¯ç”± performSyncWorkOnRoot å‡½æ•°æ¥å¤„ç†çš„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“æ¢ç©¶ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// This is the entry point for synchronous tasks that don't go</span>
<span class="token comment">// through Scheduler</span>
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœå½“å‰æ˜¯ Render é˜¶æ®µæˆ–è€… Commit é˜¶æ®µå°±æŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶åº”è¯¥è¿˜åœ¨ Batch é˜¶æ®µ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Should not already be working.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è¿›å…¥ Render é˜¶æ®µå‰ï¼Œå…ˆæŠŠ effects å’Œ callbacks éƒ½æ¶ˆè´¹æ‰ã€‚</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å–å³å°†æ¸²æŸ“çš„ lanes</span>
  <span class="token keyword">let</span> lanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ lanes ä¸­ä¸åŒ…å« SyncLaneï¼Œè¿™è¯´æ˜æ²¡æœ‰åŒæ­¥çš„ä»»åŠ¡éœ€è¦ renderRootSyncï¼Œè¿”å› ensureRootIsScheduled é‡æ–°è°ƒåº¦ä¸€æ¬¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span>lanes<span class="token punctuation">,</span> SyncLane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// There's no remaining sync work left.</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åŒæ­¥çš„ render HostRootï¼Œè¿”å› workInProgressRootExitStatus è¡¨ç¤ºé€€å‡ºæ—¶æ‰§è¡Œçš„çŠ¶æ€ï¼Œ</span>
  <span class="token comment">// åŒ…æ‹¬ RootIncompleteã€RootFatalErroredã€RootErroredã€RootSuspendedã€RootSuspendedWithDelayã€RootCompleted</span>
  <span class="token keyword">let</span> exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå‘ç”Ÿæ™®é€šé”™è¯¯ï¼Œé‡è¯•åŒæ­¥æ¸²æŸ“ï¼Œæœ€å¤šé‡è¯• 50 æ¬¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>tag <span class="token operator">!==</span> LegacyRoot <span class="token operator">&amp;&amp;</span> exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If something threw an error, try rendering one more time. We'll render</span>
    <span class="token comment">// synchronously to block concurrent data mutations, and we'll includes</span>
    <span class="token comment">// all pending updates are included. If it still fails after the second</span>
    <span class="token comment">// attempt, we'll give up and commit the resulting tree.</span>
    <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
      exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœå‘ç”Ÿäº†è‡´å‘½é”™è¯¯ï¼Œé‡ç½®åˆ°éé”™è¯¯çš„çŠ¶æ€ï¼Œå°† HostRoot æ ‡è®°ä¸º suspend å¹¶ä¸”é‡æ–°è°ƒåº¦ä¸€æ¬¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We now have a consistent tree. Because this is a sync render, we</span>
  <span class="token comment">// will commit it even if something suspended.</span>
  <span class="token comment">// å°†æ¸²æŸ“åçš„ RootFiber å’Œ lanes æ›´æ–°åˆ° HostRoot ä¸Š</span>
  <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  <span class="token comment">// æäº¤ HostRoot ä¸Šçš„æ›´æ–°ï¼Œé€šçŸ¥è°ƒåº¦å™¨åœ¨å¸§å°¾ yield ä¸€æ¬¡ï¼Œæµè§ˆå™¨é‡ç»˜ã€‚</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Before exiting, make sure there's a callback scheduled for the next</span>
  <span class="token comment">// pending level.</span>
  <span class="token comment">// ä¿è¯æ¯æ¬¡ renderSync ä¹‹åï¼Œè°ƒåº¦ä¸ä¼šé—²ç½®</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p> <ul><li>flushPassiveEffects ä¸­ä¸»è¦è°ƒç”¨ flushSyncCallbacksã€commitPassiveUnmountEffectsã€commitPassiveMountEffects è¿™ä¸‰ä¸ªå‡½æ•°ã€‚è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œ performSyncWorkOnRoot ä¼šéšç€ scheduleSyncCallback çš„è°ƒç”¨è€Œè¢«æ‰§è¡Œï¼Œå› æ­¤åœ¨ performSyncWorkOnRoot æ‰§è¡Œæ—¶ï¼Œå¾ˆå¯èƒ½åˆæœ‰æ–°çš„åŒæ­¥ä»»åŠ¡åŠ å…¥åˆ°åŒæ­¥å›è°ƒé˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜åŒæ­¥æ¸²æŸ“çš„æ•ˆç‡ï¼ŒåŒæ—¶æ»¡è¶³åŒæ­¥ä»»åŠ¡ä»Šæ—©æ‰§è¡Œçš„ç›®çš„ï¼Œåœ¨ renderRootSync ä¹‹å‰ï¼Œé‡æ–°æ¶ˆè´¹ SyncCallbacksã€‚</li> <li>è°ƒç”¨ renderRootSync æ¸²æŸ“åˆåŒæ›´æ–°ã€‚è¿”å›ä¸€ä¸ªé€€å‡ºçŠ¶æ€ï¼Œå¦‚æœå‘ç”Ÿæ™®é€šé”™è¯¯ï¼Œé‡‡å–é‡è¯•ç­–ç•¥ï¼›å¦‚æœå‘ç”Ÿäº†è‡´å‘½é”™è¯¯ï¼Œåˆ™é‡‡å–é‡ç½®ç­–ç•¥ã€‚å³ä½¿å‘ç”Ÿäº†æ™®é€šçš„é”™è¯¯ï¼Œæœ¬æ¬¡ render ä»ç„¶è¢« commitï¼Œé™¤éå‘ç”Ÿäº† è‡´å‘½çš„é”™è¯¯ï¼Œå°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</li> <li>commitRoot éœ€è¦è°ƒåº¦å™¨çš„æ”¯æŒï¼Œéœ€è¦è°ƒåº¦å™¨åœ¨ raf çš„å¸§çš„æœ«å°¾æäº¤æµè§ˆå™¨ç»˜åˆ¶ã€‚</li> <li>performSyncWorkOnRoot ä¸­ä»»ä½•æƒ…å†µçš„é€€å‡ºéƒ½è¦è°ƒç”¨ ensureRootIsScheduledï¼Œä¿è¯è°ƒåº¦ä¸ä¼šè¢«é—²ç½®ã€‚</li> <li>performSyncWorkOnRoot å¯ä»¥ä¸é€šè¿‡ Scheduler çš„è°ƒåº¦ã€‚</li></ul> <p>è¿™ä¸ªå‡½æ•°çš„å…³é”®ä½œç”¨å¦‚ä¸‹ï¼š</p> <ul><li>è°ƒç”¨ renderRootSync åŒæ­¥æ¸²æŸ“æ›´æ–°ã€‚</li> <li>æ™®é€šé”™è¯¯å’Œè‡´å‘½é”™è¯¯çš„å¤„ç†ã€‚</li> <li>è°ƒç”¨ commitRoot æäº¤ HostRoot ä¸Šçš„æ›´æ–°ï¼Œè§¦å‘æµè§ˆå™¨ paintã€‚</li></ul> <h2 id="performconcurrentworkonroot"><a href="#performconcurrentworkonroot" class="header-anchor">#</a> performConcurrentWorkOnRoot</h2> <p>åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“è°ƒåº¦å™¨å¼‚æ­¥ä»»åŠ¡è°ƒåº¦çš„å›è°ƒæ˜¯ç”± performConcurrentWorkOnRoot æ¥å¤„ç†çš„ï¼Œä¸‹é¢æˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸‹ performConcurrentWorkOnRoot è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”ä¸ performSyncWorkOnRoot è¿›è¡Œå¯¹æ¯”ã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// If two updates are scheduled within the same event, we should treat their</span>
<span class="token comment">// event times as simultaneous, even if the actual clock time has advanced</span>
<span class="token comment">// between the first and second call.</span>
<span class="token keyword">let</span> currentEventTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> NoTimestamp<span class="token punctuation">;</span>

<span class="token comment">// This is the entry point for every concurrent task, i.e. anything that</span>
<span class="token comment">// goes through Scheduler.</span>
<span class="token keyword">function</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Since we know we're in a React event, we can clear the current</span>
  <span class="token comment">// event time. The next update will compute a new event time.</span>
  currentEventTime <span class="token operator">=</span> NoTimestamp<span class="token punctuation">;</span>
  currentEventTransitionLane <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå½“å‰æ˜¯ Render é˜¶æ®µæˆ–è€… Commit é˜¶æ®µå°±æŠ¥é”™ï¼Œå› ä¸ºå½“å‰åº”è¯¥è¿˜åœ¨ Batch é˜¶æ®µ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Should not already be working.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Flush any pending passive effects before deciding which lanes to work on,</span>
  <span class="token comment">// in case they schedule additional work.</span>
  <span class="token keyword">const</span> originalCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>
  <span class="token comment">// åœ¨ RenderConcurrent ä¹‹å‰å†æ¬¡æ¶ˆè´¹å®Œ callbacks å’Œ effectsã€‚</span>
  <span class="token keyword">const</span> didFlushPassiveEffects <span class="token operator">=</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>didFlushPassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Something in the passive effect phase may have canceled the current task.</span>
    <span class="token comment">// Check if the task node for this root was changed.</span>
    <span class="token comment">// æ£€æŸ¥ flushPassiveEffects ä¹‹å callbackNode æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœå˜åŒ–äº†ï¼Œèˆå¼ƒä¹‹åçš„æ¸²æŸ“å·¥ä½œï¼Œå› ä¸ºæ–°çš„è°ƒåº¦å·²ç»æ¥ä¸´</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>callbackNode <span class="token operator">!==</span> originalCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The current task was canceled. Exit. We don't need to call</span>
      <span class="token comment">// `ensureRootIsScheduled` because the check above implies either that</span>
      <span class="token comment">// there's a new task, or that there's no remaining work on this root.</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Current task was not canceled. Continue.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Determine the next lanes to work on, using the fields stored</span>
  <span class="token comment">// on the root.</span>
  <span class="token comment">// è®¡ç®—å½“å‰è¦æ¸²æŸ“çš„ lanes</span>
  <span class="token keyword">let</span> lanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Defensive coding. This is never expected to happen.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We disable time-slicing in some cases: if the work has been CPU-bound</span>
  <span class="token comment">// for too long (&quot;expired&quot; work, to prevent starvation), or we're in</span>
  <span class="token comment">// sync-updates-by-default mode.</span>
  <span class="token comment">// åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ—¶é—´åˆ‡ç‰‡ï¼Œè¿™å†³å®šæ˜¯æ”¹ç”¨åŒæ­¥ Render è¿˜æ˜¯ç»§ç»­å¼‚æ­¥ Render</span>
  <span class="token comment">// åŒ…å«æœ‰ Blocking ä¼˜å…ˆçº§çš„ lane çš„ä»»åŠ¡ï¼Œæˆ–è€…åŒ…å«æœ‰è¿‡æ—¶ line çš„ä»»åŠ¡è¦æ”¹ä¸ºåŒæ­¥ Render </span>
  <span class="token keyword">const</span> shouldTimeSlice <span class="token operator">=</span>
    <span class="token operator">!</span><span class="token function">includesBlockingLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">includesExpiredLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>disableSchedulerTimeoutInWorkLoop <span class="token operator">||</span> <span class="token operator">!</span>didTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> exitStatus <span class="token operator">=</span> shouldTimeSlice
    <span class="token operator">?</span> <span class="token function">renderRootConcurrent</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ Render çš„ç»“æœä¸æ˜¯ RootIncompleteï¼Œè¯´æ˜å‡ºç°äº†å¼‚å¸¸æƒ…å†µ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">!==</span> RootIncomplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If something threw an error, try rendering one more time. We'll</span>
      <span class="token comment">// render synchronously to block concurrent data mutations, and we'll</span>
      <span class="token comment">// includes all pending updates are included. If it still fails after</span>
      <span class="token comment">// the second attempt, we'll give up and commit the resulting tree.</span>
      <span class="token comment">// å¦‚æœæ˜¯æ™®é€šé”™è¯¯ï¼Œé‡è¯•è‹¥å¹²æ¬¡</span>
      <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
        exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
      <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if this render may have yielded to a concurrent event, and if so,</span>
    <span class="token comment">// confirm that any newly rendered stores are consistent.</span>
    <span class="token keyword">const</span> renderWasConcurrent <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">includesBlockingLane</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      renderWasConcurrent <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">isRenderConsistentWithExternalStores</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// A store was mutated in an interleaved event. Render again,</span>
      <span class="token comment">// synchronously, to block further mutations.</span>
      exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We need to check again if something threw</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> errorRetryLanes <span class="token operator">=</span> <span class="token function">getLanesToRetrySynchronouslyOnError</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRetryLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          lanes <span class="token operator">=</span> errorRetryLanes<span class="token punctuation">;</span>
          exitStatus <span class="token operator">=</span> <span class="token function">recoverFromConcurrentError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> errorRetryLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// We assume the tree is now consistent because we didn't yield to any</span>
          <span class="token comment">// concurrent events.</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exitStatus <span class="token operator">===</span> RootFatalErrored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fatalError <span class="token operator">=</span> workInProgressRootFatalError<span class="token punctuation">;</span>
        <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> fatalError<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We now have a consistent tree. The next step is either to commit it,</span>
    <span class="token comment">// or, if something suspended, wait to commit it after a timeout.</span>
    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
    <span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å®Œæˆ Render ä¹‹åï¼Œé‡æ–°å‘èµ·ä¸€æ¬¡è°ƒåº¦ï¼Œä»¥ä¿è¯è°ƒåº¦ä¸ä¼šè¢«ä¸­æ–­</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœæ–°çš„æ–°çš„è°ƒåº¦èŠ‚ç‚¹å°†ä»ç„¶å‘ç”Ÿåœ¨ç›¸åŒçš„ HostRootï¼Œé‚£å°±ä¸ç”¨ç­‰è°ƒåº¦å™¨çš„è°ƒåº¦ï¼Œç›´æ¥ç»§ç»­ performConcurrentWorkOnRoot</span>
  <span class="token comment">// æ³¨æ„ï¼šensureRootIsScheduled ä¼šäº§ç”Ÿä¸€ä¸ª newCallbackNodeï¼Œæ›´æ–° root.callbackNode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>callbackNode <span class="token operator">===</span> originalCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The task node scheduled for this root is the same one that's</span>
    <span class="token comment">// currently executed. Need to return a continuation.</span>
    <span class="token keyword">return</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><ul><li>currentEventTime åœ¨ scheduleUpdateOnFiber å’Œ createUpdate ä¹‹å‰ç”Ÿæˆï¼Œå³åˆ›å»ºæ›´æ–°æ—¶ç”Ÿæˆï¼Œåˆ° performConcurrentWorkOnRoot è¢«é‡ç½®ã€‚æ¯ä¸ª update å¯¹è±¡ä¸­æœ‰ eventTimeã€‚ </li> <li>performConcurrentWorkOnRoot å¿…é¡»é€šè¿‡ Scheduler çš„è°ƒåº¦æ‰æœ‰æœºä¼šæ‰§è¡Œã€‚è¿™ä¸ performSyncWorkOnRoot æœ‰æ‰€ä¸åŒã€‚</li> <li>ä»æ•´ä½“æ¥çœ‹ï¼ŒperformSyncWorkOnRoot å’Œ performConcurrentWorkOnRoot æµç¨‹æ˜¯ç›¸ä¼¼çš„ï¼ŒåŒ…æ‹¬ executionContext çš„åˆ¤æ–­ã€è°ƒç”¨ renderRootã€é”™è¯¯åˆ¤æ–­ç­‰ã€‚</li> <li>åœ¨ RenderConcurrent ä¹‹å‰å†æ¬¡æ¶ˆè´¹å®Œ callbacks å’Œ effectsï¼ŒåŸå› æ˜¯ä¸ºäº†èŠ‚çœè°ƒåº¦èµ„æºï¼ŒåŒæ—¶ä¿è¯æ›´æ–°è¢«å°½å¿«çš„å¤„ç†ã€‚å½“ç„¶ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå¦‚æœåœ¨ æ¶ˆè´¹å®Œ callbacks å’Œ effects çš„è¿‡ç¨‹ä¸­ï¼Œroot.callbackNode å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™èˆå¼ƒå½“å‰çš„ RenderRoot ç­‰åç»­æµç¨‹ï¼Œå› ä¸ºæ–°çš„è°ƒåº¦å³å°†æ¥ä¸´ã€‚ä¹‹æ‰€ä»¥èˆå¼ƒå½“å‰çš„è°ƒåº¦æ˜¯å› ä¸ºï¼Œæ–°çš„ä»»åŠ¡å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§æˆ–è€…å½“å‰çš„è°ƒåº¦å·²ç»æ²¡æœ‰ä»»åŠ¡å¯æ‰§è¡Œäº†ã€‚</li> <li>åœ¨ RenderRoot ä¹‹å‰ï¼Œä»ç„¶å¯¹ lanes åšäº†åˆ¤æ–­ï¼Œå¦‚æœ lanes ä¸­æœ‰ blocking ä¼˜å…ˆçº§çš„ä»»åŠ¡æˆ–è€…è¿‡æ—¶çš„ä»»åŠ¡ï¼ˆè¿‡æ—¶çš„ä»»åŠ¡å…·æœ‰ç«‹å³æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼‰å°±ä¼šä½¿ç”¨åŒæ­¥æ¸²æŸ“ï¼Œæ²¡æœ‰ä¸Šè¿°çš„æƒ…å†µæ‰ä¼šä½¿ç”¨å¼‚æ­¥æ¸²æŸ“ã€‚åŒæ­¥æ¸²æŸ“å’Œå¼‚æ­¥æ¸²æŸ“åˆ†åˆ«è°ƒç”¨ renderRootSync å’Œ renderRootConcurrent æ‰§è¡Œã€‚</li> <li>åœ¨é”™è¯¯å¤„ç†æ–¹é¢ï¼Œå¯¹å¾…æ™®é€šçš„é”™è¯¯å®¹å¿åº¦è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒrecoverFromConcurrentError å°†å¯¹é”™è¯¯æ‰§è¡Œä¹‹å¤š 50 æ¬¡çš„é‡è¯•ï¼Œæ³¨æ„ï¼Œé‡è¯•æ—¶æ˜¯ä»¥ renderRootSync å³åŒæ­¥æ¸²æŸ“æ‰§è¡Œçš„ã€‚</li> <li>åœ¨ RenderRoot ä¹‹åï¼Œæ— è®ºé”™è¯¯ä¸å¦ï¼Œéƒ½éœ€è¦è°ƒç”¨ ensureRootIsScheduled ä»¥ä¿è¯è°ƒåº¦ä¸ä¼šè¢«é—²ç½®ã€‚ç”±äºå¼‚æ­¥æ¸²æŸ“éœ€è¦è°ƒåº¦å™¨è°ƒåº¦çš„æ—¶é—´ç›¸å¯¹äºåŒæ­¥æ¸²æŸ“è¦é•¿ï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªä¼˜åŒ–å¤„ç†ï¼Œå¦‚æœé¢„çŸ¥åˆ°æ–°çš„è°ƒåº¦ä»ç„¶ä¼šå‡ºç°åœ¨åŒä¸€ä¸ª HostRoot ä¸Šï¼Œå°±å¯ä»¥ç›´æ¥ç»§ç»­è°ƒç”¨è‡ªèº«ä»¥ç»§ç»­å®Œæˆ HostRoot ä¸Šçš„æ¸²æŸ“ä»»åŠ¡ã€‚</li></ul> <h3 id="finishconcurrentrender"><a href="#finishconcurrentrender" class="header-anchor">#</a> finishConcurrentRender</h3> <p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šæ ¹æ® exitStatus çš„çŠ¶æ€æ‰§è¡Œä¸åŒçš„å¤„ç†æ“ä½œï¼Œä¸»è¦æ˜¯ commitRoot æ“ä½œã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>exitStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™ä¸¤ç§æƒ…å†µåœ¨ performConcurrentWorkOnRoot ä¸­å·²ç»å¤„ç†äº†ï¼Œåº”è¯¥ä¸ä¼šè¢«æ‰§è¡Œåˆ°</span>
    <span class="token keyword">case</span> RootIncomplete<span class="token operator">:</span>
    <span class="token keyword">case</span> RootFatalErrored<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Root did not complete. This is a bug in React.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// RootErrored çš„æƒ…å†µåœ¨ performConcurrentWorkOnRoot ä¸­å·²ç»å¯¹é”™è¯¯æƒ…å†µé‡è¯•äº†ï¼Œè¿™é‡Œå°†ç›´æ¥ commitRoot</span>
    <span class="token keyword">case</span> RootErrored<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// We should have already attempted to retry this tree. If we reached</span>
      <span class="token comment">// this point, it errored again. Commit it.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœ renderRoot é€€å‡ºåè¿”å› RootSuspendedï¼Œåˆ™å°†å½“å‰çš„ HostRoot æ ‡è®°ä¸º suspended</span>
    <span class="token keyword">case</span> RootSuspended<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// We have an acceptable loading state. We need to figure out if we</span>
      <span class="token comment">// should immediately commit it or wait a bit.</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">includesOnlyRetries</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// do not delay if we're inside an act() scope</span>
        <span class="token operator">!</span><span class="token function">shouldForceFlushFallbacksInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This render only included retries, no updates. Throttle committing</span>
        <span class="token comment">// retries so that we don't show too many loading states too quickly.</span>
        <span class="token keyword">const</span> msUntilTimeout <span class="token operator">=</span>
          globalMostRecentFallbackTime <span class="token operator">+</span> <span class="token constant">FALLBACK_THROTTLE_MS</span> <span class="token operator">-</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Don't bother with a very short suspense time.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msUntilTimeout <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// There's additional work on this root.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">const</span> suspendedLanes <span class="token operator">=</span> root<span class="token punctuation">.</span>suspendedLanes<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSubsetOfLanes</span><span class="token punctuation">(</span>suspendedLanes<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We should prefer to render the fallback of at the last</span>
            <span class="token comment">// suspended level. Ping the last suspended level to try</span>
            <span class="token comment">// rendering it again.</span>
            <span class="token comment">// FIXME: What if the suspended lanes are Idle? Should not restart.</span>
            <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">markRootPinged</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> suspendedLanes<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// The render is suspended, it hasn't timed out, and there's no</span>
          <span class="token comment">// lower priority work to do. Instead of committing the fallback</span>
          <span class="token comment">// immediately, wait for more data to arrive.</span>
          <span class="token comment">// åœ¨ root.timeoutHandle æŒ‚è½½å»¶æ—¶å™¨ï¼Œå»¶è¿Ÿæ‰§è¡Œ commitRoot</span>
          root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> <span class="token function">scheduleTimeout</span><span class="token punctuation">(</span>
            <span class="token function">commitRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
            msUntilTimeout<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// The work expired. Commit immediately.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> RootSuspendedWithDelay<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">includesOnlyTransitions</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is a transition, so we should exit without committing a</span>
        <span class="token comment">// placeholder and without scheduling a timeout. Delay indefinitely</span>
        <span class="token comment">// until we receive more data.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldForceFlushFallbacksInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is not a transition, but we did trigger an avoided state.</span>
        <span class="token comment">// Schedule a placeholder to display after a short delay, using the Just</span>
        <span class="token comment">// Noticeable Difference.</span>
        <span class="token comment">// TODO: Is the JND optimization worth the added complexity? If this is</span>
        <span class="token comment">// the only reason we track the event time, then probably not.</span>
        <span class="token comment">// Consider removing.</span>

        <span class="token keyword">const</span> mostRecentEventTime <span class="token operator">=</span> <span class="token function">getMostRecentEventTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> eventTimeMs <span class="token operator">=</span> mostRecentEventTime<span class="token punctuation">;</span>
        <span class="token keyword">const</span> timeElapsedMs <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> eventTimeMs<span class="token punctuation">;</span>
        <span class="token keyword">const</span> msUntilTimeout <span class="token operator">=</span> <span class="token function">jnd</span><span class="token punctuation">(</span>timeElapsedMs<span class="token punctuation">)</span> <span class="token operator">-</span> timeElapsedMs<span class="token punctuation">;</span>

        <span class="token comment">// Don't bother with a very short suspense time.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msUntilTimeout <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Instead of committing the fallback immediately, wait for more data</span>
          <span class="token comment">// to arrive.</span>
          root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> <span class="token function">scheduleTimeout</span><span class="token punctuation">(</span>
            <span class="token function">commitRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
            msUntilTimeout<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Commit the placeholder.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ¸²æŸ“ä»»åŠ¡é€€å‡ºçŠ¶æ€ä¸º RootCompletedï¼Œç›´æ¥ commitRoot</span>
    <span class="token keyword">case</span> RootCompleted<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// The work completed. Ready to commit.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unknown root exit status.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div> <h2 id="renderrootsync"><a href="#renderrootsync" class="header-anchor">#</a> renderRootSync</h2> <p>åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ performSyncWorkOnRoot å’Œ performConcurrentWorkOnRoot å°†ä¼šè°ƒç”¨ renderRootSync ä»¥å®ŒæˆåŒæ­¥æ¸²æŸ“çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆåœ¨ commitRoot ä¹‹å‰ï¼ŒåŒæ­¥æ¸²æŸ“ä»»åŠ¡æ˜¯å¦‚ä½•å®Œæˆçš„å‘¢ï¼Ÿ</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> lanes<span class="token operator">:</span> Lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å…ˆç¼“å­˜ä¸‹ executionContextï¼Œä»¥ä¾¿äºé”™è¯¯æ¢å¤</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  <span class="token comment">// å°† RenderContext åŠ å…¥ executionContext ä¸­</span>
  executionContext <span class="token operator">|=</span> RenderContext<span class="token punctuation">;</span>
  <span class="token comment">// æ¨å‡º ReactCurrentDispatcher.currentï¼ŒReactCurrentDispatcher.current å°†è¢«é‡ç½®ä¸º ContextOnlyDispatcher</span>
  <span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> <span class="token function">pushDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the root or lanes have changed, throw out the existing stack</span>
  <span class="token comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span>
  <span class="token comment">// å¦‚æœå‘ç° workInProgressRoot å’Œ workInProgressRootRenderLanes å·²ç»ä¸è¦å°†è¦æ¸²æŸ“çš„ root å’Œ lanes äº†ï¼Œå°†å¯¹ root å’Œ workInProgress ç­‰å˜é‡æ‰§è¡Œæ¸…ç†å’Œé‡ç½®å·¥ä½œ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> root <span class="token operator">||</span> workInProgressRootRenderLanes <span class="token operator">!==</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¼€å¯ä¸€ä¸ª workLoopSync å¾ªç¯ï¼ŒhandleError å°†æ•è·å’Œå¤„ç† workLoopSync æ‰§è¡Œä¸­çš„é”™è¯¯ã€‚</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å½“ workLoopSync çš„å¾ªç¯é€€å‡ºåï¼Œæ‰€æœ‰æ¸²æŸ“å·¥ä½œå°±æ‰§è¡Œå®Œæ¯•ï¼Œ</span>
  <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å°† executionContext æ¢å¤è‡³æ¸²æŸ“ä¹‹å‰çš„çŠ¶æ€ï¼Œè¿™è¡¨æ˜ RenderContext å’Œ CommitContextï¼ˆå°†åœ¨åæ–‡ä¸­åŠ å…¥ï¼‰ å°†ä¼šè¢«ç§»é™¤ï¼Œä¹‹æ‰€ä»¥å¯ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬åˆšå¥½éœ€è¦é‡ç½®åˆ° BatchedContext</span>
  executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
  <span class="token comment">// æ¨å…¥ ReactCurrentDispatcher.currentï¼ŒReactCurrentDispatcher.current å°†ç½®ä¸º prevDispatcher</span>
  <span class="token function">popDispatcher</span><span class="token punctuation">(</span>prevDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// workLoopSync å¾ªç¯æ‰§è¡Œå®Œä¹‹åï¼ŒworkInProgress åº”è¯¥ç½®ç©ºï¼Œå¦åˆ™è¯´æ˜å¯èƒ½æœ‰å·¥ä½œæ²¡æœ‰æ‰§è¡Œå®Œï¼Œæ‰€ä»¥æŠ¥é”™</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a sync render, so we should have finished the whole tree.</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'Cannot commit an incomplete root. This error is likely caused by a '</span> <span class="token operator">+</span>
        <span class="token string">'bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç»§ workInProgress ç½®ç©ºä¹‹åï¼Œä¹Ÿé‡ç½® workInProgressRoot å’Œ workInProgressRootRenderLanesï¼Œè¿™è¡¨æ˜æ²¡æœ‰ä»»ä½•ä»»åŠ¡æ­£åœ¨è¢«æ¸²æŸ“ã€‚</span>
  <span class="token comment">// Set this to null to indicate there's no in-progress render.</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token comment">// workInProgressRootExitStatus æ˜¯æ–‡ä»¶ä¸­çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè¡¨ç¤º HostRoot æ¸²æŸ“ä¹‹åé€€å‡ºæ—¶çš„çŠ¶æ€ï¼ŒworkLoopSync ä¼šæ›´æ–°è¿™ä¸ªå€¼ã€‚</span>
  <span class="token keyword">return</span> workInProgressRootExitStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// This is called right before React yields execution, to ensure `readContext`</span>
  <span class="token comment">// cannot be called outside the render phase.</span>
  currentlyRenderingFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  lastContextDependency <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  lastFullyObservedContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div> <ul><li>è¿™é‡Œ executionContext ä½¿ç”¨å¾ˆå·§å¦™ï¼Œè¿™é‡Œç›´æ¥ç¼“å­˜äº† executionContext çš„å€¼ï¼Œå¹¶åœ¨æ‰§è¡Œå®Œ workLoopSync ä¹‹åæ¢å¤ã€‚è¿™æ˜¯å› ä¸º renderRoot ä¸­ä¼šåœ¨ executionContext åŠ å…¥ RenderContextï¼Œè€Œåœ¨ workLoop ä¸­ï¼Œåˆ™ä¼šåœ¨ executionContext åŠ å…¥ CommitContextã€‚å› æ­¤è¿™é‡Œç›´æ¥å°† executionContext æ¢å¤è‡³ BatchContextã€‚</li> <li>åœ¨æ‰§è¡Œ renderRoot æ—¶ï¼ŒReactCurrentDispatcher.current å°†è¢«é‡ç½®ä¸º ContextOnlyDispatcherï¼Œåœ¨æ‰§è¡Œå®Œæ¯•åæ¢å¤åŸå€¼ï¼Œè¿™ä»¥ä¸ºè¿™ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ <a href="/react/hooks/useState"> useState å’Œ useReducer åŸç†æ¢æ</a> ä¸€æ–‡ä¸­å·²ç»å¥—å°±è¿‡ ReactCurrentDispatcher.current ä¸­æŒ‚è½½çš„ä¸åŒç±»å‹çš„ dispatcher å°†ä¼šä½¿ç”¨ä¸åŒå®ç°çš„ hooksã€‚ä»ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ­¤é˜¶æ®µï¼Œæ‰€æœ‰çš„ hook è°ƒç”¨éƒ½ä¼šç”± throwInvalidHookError æŠ¥é”™ã€‚
</li> <li>å…·ä½“çš„æ¸²æŸ“å·¥ä½œ workLoopSync å®Œæˆçš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç›´åˆ° workLoopSync æ­£å¸¸æ‰§è¡Œæ—¶é€€å‡ºã€‚</li> <li>æ¸²æŸ“å®Œæ¯•åä¼šæ‰§è¡Œä¸€äº›é‡ç½®å·¥ä½œï¼ŒåŒ…æ‹¬ workInProgressã€workInProgressRootã€workInProgressRootRenderLanes ç­‰ã€‚</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> ContextOnlyDispatcher<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  readContext<span class="token punctuation">,</span>

  useCallback<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useContext<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useImperativeHandle<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useInsertionEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useLayoutEffect<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useDebugValue<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useDeferredValue<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useTransition<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useMutableSource<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useSyncExternalStore<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useId<span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>

  unstable_isNewReconciler<span class="token operator">:</span> enableNewReconciler<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="renderrootconcurrent"><a href="#renderrootconcurrent" class="header-anchor">#</a> renderRootConcurrent</h2> <p>åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ performConcurrentWorkOnRoot å‡½æ•°ä¼šè°ƒç”¨ renderRootConcurrent å»å®Œæˆå¼‚æ­¥ä»»åŠ¡çš„æ¸²æŸ“å·¥ä½œã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹å¼‚æ­¥ä»»åŠ¡æ˜¯å¦‚ä½•å®Œæˆçš„ï¼Ÿè¿™é‡Œä¸ renderRootSync ç±»ä¼¼ï¼Œå°†ç®€ç•¥åˆ†æã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">renderRootConcurrent</span><span class="token punctuation">(</span>root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> lanes<span class="token operator">:</span> Lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> RenderContext<span class="token punctuation">;</span>
  <span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> <span class="token function">pushDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the root or lanes have changed, throw out the existing stack</span>
  <span class="token comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> root <span class="token operator">||</span> workInProgressRootRenderLanes <span class="token operator">!==</span> lanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resetRenderTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">popDispatcher</span><span class="token punctuation">(</span>prevDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>

  <span class="token comment">// Check if the tree has completed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RootIncomplete<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set this to null to indicate there's no in-progress render.</span>
    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

    <span class="token comment">// Return the final exit status.</span>
    <span class="token keyword">return</span> workInProgressRootExitStatus<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li>è¿™é‡Œè°ƒç”¨äº† workLoopConcurrent ä»¥å®Œæˆå¼‚æ­¥æ¸²æŸ“ä»»åŠ¡ï¼ŒåŒæ ·æ˜¯æ­»å¾ªç¯çš„è®¾è®¡ï¼Œç›´åˆ° workLoopConcurrent æ‰§è¡ŒæˆåŠŸã€‚</li> <li>ä¸åŒçš„æ˜¯ï¼Œåœ¨ renderRootConcurrent ä¸­ï¼ŒworkLoopConcurrent å¾ªç¯æ‰§è¡Œä¹‹åï¼ŒworkInProgress æ˜¯å¯ä»¥ä¸ä¸º null çš„ï¼Œåœ¨ ä¸­ï¼ŒworkLoopSync ä¸­å°†ç›´æ¥æŠ¥é”™ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¼‚æ­¥ä»»åŠ¡æ˜¯å¯ä»¥ä¸å®Œæˆçš„ï¼Œè¿™æ—¶ä¼šè¿”å› exitStatus ä¸º RootIncompleteã€‚
</li></ul> <h3 id="handleerror"><a href="#handleerror" class="header-anchor">#</a> handleError</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> erroredWork <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Reset module-level state that was set during the render phase.</span>
      <span class="token function">resetContextDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resetHooksAfterThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// TODO: I found and added this missing line while investigating a</span>
      <span class="token comment">// separate issue. Write a regression test using string refs.</span>
      ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// å¦‚æœ workInProgress ä¸å­˜åœ¨ï¼Œæˆ–è€… workInProgress.return ä¸å­˜åœ¨åˆ™è§†ä¸ºè‡´å‘½é”™è¯¯</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>erroredWork <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> erroredWork<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Expected to be working on a non-root fiber. This is a fatal error</span>
        <span class="token comment">// because there's no ancestor that can handle it; the root is</span>
        <span class="token comment">// supposed to capture all errors that weren't caught by an error</span>
        <span class="token comment">// boundary.</span>
        workInProgressRootExitStatus <span class="token operator">=</span> RootFatalErrored<span class="token punctuation">;</span>
        workInProgressRootFatalError <span class="token operator">=</span> thrownValue<span class="token punctuation">;</span>
        <span class="token comment">// Set `workInProgress` to null. This represents advancing to the next</span>
        <span class="token comment">// sibling, or the parent if there are no siblings. But since the root</span>
        <span class="token comment">// has no siblings nor a parent, we set it to null. Usually this is</span>
        <span class="token comment">// handled by `completeUnitOfWork` or `unwindWork`, but since we're</span>
        <span class="token comment">// intentionally not calling those, we need set it here.</span>
        <span class="token comment">// TODO: Consider calling `unwindWork` to pop the contexts.</span>
        workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// éè‡´å‘½é”™è¯¯å°†æŠ›å‡ºå¼‚å¸¸ã€ç›´æ¥è·³åˆ°å®Œæˆæ¸²æŸ“çš„å›è°ƒ</span>
      <span class="token function">throwException</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        erroredWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span>
        erroredWork<span class="token punctuation">,</span>
        thrownValue<span class="token punctuation">,</span>
        workInProgressRootRenderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>erroredWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>yetAnotherThrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Something in the return path also threw.</span>
      <span class="token comment">// å¦‚æœ workInProgress ä¸Šå¤„ç†é”™è¯¯ä»ç„¶æŠ›å‡ºé”™è¯¯ï¼Œæ‰¾åˆ° workInProgress.return å°†å…¶è®¾ç½® erroredWorkï¼Œé”™è¯¯å°†æŠ›åˆ°çˆ¶çº§å¤„ç†ã€‚</span>
      thrownValue <span class="token operator">=</span> yetAnotherThrownValue<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> erroredWork <span class="token operator">&amp;&amp;</span> erroredWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this boundary has already errored, then we had trouble processing</span>
        <span class="token comment">// the error. Bubble it to the next boundary.</span>
        erroredWork <span class="token operator">=</span> erroredWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
        workInProgress <span class="token operator">=</span> erroredWork<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        erroredWork <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åªæœ‰æ²¡æœ‰ yetAnotherThrownValue æ—¶æ‰æ­£å¸¸é€€å‡ºåˆ° work loop</span>
    <span class="token comment">// Return to the normal work loop.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ul><li>å¯¹äºè‡´å‘½é”™è¯¯å°†ç›´æ¥å°† workInProgress ç½®ä¸º nullï¼ŒexitStatus å°†æŠ›å‡ºè‡´å‘½é”™è¯¯ã€‚</li> <li>å¯¹äºæ™®é€šé”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸å¹¶ä¸”è°ƒç”¨ completeUnitOfWork æ‰§è¡Œæ¸²æŸ“å®Œæ¯•çš„é€»è¾‘ï¼Œè¿™é‡Œ workInProgress ä¹Ÿä¼šè¢«å€¼ä¸º nullã€‚æ— è®ºæ˜¯è‡´å‘½é”™è¯¯è¿˜æ˜¯æ™®é€šé”™è¯¯éƒ½ä¼šæ­£å¸¸è·³å‡º workLoopã€‚</li> <li>å¯¹äºå¤„ç†è¿‡ç¨‹ä¸­ä»ç„¶æŠ›å‡ºé”™è¯¯çš„é”™è¯¯ï¼Œå°†å‘çˆ¶çº§å†’æ³¡å¤„ç†é”™è¯¯ï¼ŒçŸ¥é“é”™è¯¯è¢«è§£å†³ã€‚</li></ul> <h2 id="workloopsync"><a href="#workloopsync" class="header-anchor">#</a> workLoopSync</h2> <p>é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒrenderRootSync ä¼šè°ƒç”¨ workLoopSync å®ŒæˆåŒæ­¥ä»»åŠ¡çš„æ¸²æŸ“ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹ workLoopSync å‡½æ•°ã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">// The work loop is an extremely hot path. Tell Closure not to inline it.</span>
<span class="token comment">/** @noinline */</span>
<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Already timed out, so perform work without checking if we need to yield.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>è¿™ä¸ªå‡½æ•°å°±æ˜¯åœ¨ workInProgress è¿˜æœ‰å€¼çš„æ—¶å€™æ‰§è¡Œ performUnitOfWork æ¶ˆè´¹ workInProgressã€‚åŒæ­¥æ¸²æŸ“ä¼šå®Œæˆæ‰€æœ‰çš„ä»»åŠ¡ï¼Œå³å¤„ç† HostRoot ä¸Šæ‰€æœ‰ Fiber ä¸Šçš„åŒæ­¥æ›´æ–°ã€‚</li> <li>@noinline æ˜¯ chrome æµè§ˆå™¨çš„ä¸€ç§ä¼˜åŒ–æ ‡æ³¨ã€‚ Google Closure Compiler ä½¿ç”¨æ­¤æ ‡æ³¨æ˜¯å‡½æ•°æˆ–è€…æ ‡æ³¨ä¸è¢«è½¬æ¢æˆ inlineã€‚è¯¦è§ï¼š<a href="https://github.com/google/closure-compiler/wiki/Annotating-JavaScript-for-the-Closure-Compiler#noinline" target="_blank" rel="noopener noreferrer">@noinline<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚æµè§ˆå™¨ js å¼•æ“é€šè¿‡ inline ä¼˜åŒ–æå‡ä»£ç è§£ææ•ˆç‡ï¼Œè¿™é€šå¸¸å¯¹ä¸€äº›å¸¸é‡ã€ä¸å¤ªæ‰§è¡Œçš„å‡½æ•°ï¼ˆå¦‚å·¥å‚å‡½æ•°ï¼Œæˆ‘ä»¬å°†åœ¨ vue æºç ä¸­çœ‹åˆ°ï¼‰æœ‰æ•ˆï¼Œå¯¹æ‰§è¡Œé¢‘ç‡è¾ƒé«˜çš„å‡½æ•°å’Œå˜é‡åè€Œæ•ˆç‡å¾ˆä½ã€‚è¿™é‡Œ @noinline æ ‡æ³¨æ„æ€æ˜¯ä¸è¦ä½¿ç”¨ inline ä¼˜åŒ–ï¼Œä»¥å…é™ä½ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚</li></ul> <div class="custom-block tip"><p class="custom-block-title">æç¤º</p> <p><strong>inline ä¼˜åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p> <p>In computing, inline expansion, or inlining, is a manual or compiler optimization that replaces a function call site with the body of the called function. Inline expansion is similar to macro expansion, but occurs during compilation, without changing the source code (the text), while macro expansion occurs prior to compilation, and results in different text that is then processed by the compiler.</p> <ul><li><a href="https://en.wikipedia.org/wiki/Inline_expansion#Effect_on_performance" target="_blank" rel="noopener noreferrer">Inline expansion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h2 id="workloopconcurrent"><a href="#workloopconcurrent" class="header-anchor">#</a> workLoopConcurrent</h2> <p>åœ¨ renderRootConcurrent å‡½æ•°ä¸­ä¼šè°ƒç”¨ workLoopConcurrent ä»¥å®Œæˆå¼‚æ­¥æ¸²æŸ“ä»»åŠ¡ã€‚workLoopConcurrent ä¸ workLoopSync ç±»ä¼¼ï¼Œä¸åœ¨èµ˜è¿°ã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token comment">/** @noinline */</span>
<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Perform work until Scheduler asks us to yield</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>workInProgress ä¸º null æ˜¯ä¼šç›´æ¥è·³å‡ºï¼Œæˆ–è€… shouldYield æ—¶ä¹Ÿä¼šè·³å‡ºã€‚å› æ­¤è·³å‡º workLoopConcurrent æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼ŒäºŒæ˜¯è°ƒåº¦å™¨å³å°†äº§ç”Ÿ (yield) æ–°å›è°ƒäº†ã€‚</li></ul> <h2 id="performunitofwork"><a href="#performunitofwork" class="header-anchor">#</a> performUnitOfWork</h2> <div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>æ ‡ç­¾ï¼š</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>é‡è¦</span></div> <p>ä»ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“æ— è®ºæ˜¯ workLoopSync è¿˜æ˜¯ workLoopConcurrent æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ performUnitOfWorkï¼Œè¿™è¯´æ˜åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡çš„åˆ†å‘ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ performUnitOfWork æ¥çœŸæ­£æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ‰§è¡Œæ¸²æŸ“ä»»åŠ¡è€Œè¨€ï¼ŒperformUnitOfWork æ‰æ˜¯èƒŒåé»˜é»˜å¹²æ´»çš„å·¥äººã€‚ä¸‹é¢æˆ‘ä»¬ç€é‡åˆ†æä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// The current, flushed, state of this fiber is the alternate. Ideally</span>
  <span class="token comment">// nothing should rely on this, but relying on it here means that we don't</span>
  <span class="token comment">// need an additional field on the work in progress.</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">let</span> next<span class="token punctuation">;</span>
 
  next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If this doesn't spawn new work, complete the current work.</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>åœ¨ <a href="/react/reconciliation/fiber.html#fiber-çš„å®šä¹‰">fiber ä¸ Reconciliation æ¢æ</a>ç–‘é—®ä¸­ï¼Œæˆ‘ä»¬åˆ†æè¿‡ Fiber çš„ç»“æ„ï¼Œå…¶ä¸­ fiber.alternate æ˜¯ fiber ä¸Šçš„ä¸€ä¸ªç‰ˆæœ¬æ± ï¼Œå½“ fiber æ›´æ–°ä»¥åä¼šæ›´æ–°åˆ° fiber.alternate ä¸Šã€‚unitOfWork æœ¬è´¨æ˜¯ä¸€ä¸ª fiberï¼Œå…¶ä¸­ current ä»£è¡¨äº† fiber ä¸Šä¸€æ¬¡æ›´æ–°çš„ç»“æœã€‚</li> <li>beginWork å¯¹å½“å‰çš„ workInProgress è¿›è¡Œ renderï¼Œæ¸²æŸ“åè¿”å›ä¸‹ä¸€ä¸ªéœ€è¦æ›´æ–°çš„ fiberã€‚åœ¨ beginWork ä¸­ï¼Œæˆ‘ä»¬å°†å…·ä½“æ¢è®¨ fiber çš„éå†çš„æ–¹æ³•å’Œç»“æ„ã€‚</li> <li>å½“ next ä¸º null æ—¶ï¼Œæ‰€æœ‰ fiber render å®Œæ¯•ï¼Œå› æ­¤æ‰§è¡Œ completeUnitOfWorkã€‚ä¸Šä¸€æ¬¡æ‰§è¡Œ completeUnitOfWork è¿˜æ˜¯åœ¨ renderRootSync å’Œ renderRootConcurrent çš„ handlerError ä¸­é‡åˆ°æ™®é€šé”™è¯¯æ—¶ã€‚å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œå°† next è®¾ç½®ä¸º workInProgressï¼Œä¸‹æ¬¡ performUnitOfWork å°±ä¼šé’ˆå¯¹ next è¿›è¡Œ renderã€‚</li></ul> <h2 id="beginwork"><a href="#beginwork" class="header-anchor">#</a> beginWork</h2> <div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>æ ‡ç­¾ï¼š</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>é‡è¦</span></div> <p>åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ performUnitOfWork ä¼šè°ƒç”¨ beginWork æ¥æ‰§è¡Œ RootFiber ä»¥åŠå…¶ä¸‹æ¯ä¸€ä¸ª fiber çš„æ¸²æŸ“å·¥ä½œã€‚é‚£ä¹ˆå…·ä½“æ‰§è¡Œäº†å“ªäº›å·¥ä½œå‘¢ï¼ŸFiberTree çš„éå†æ˜¯å¦‚ä½•è¿›è¡Œå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ beginWorkï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberBeginWork.new.js</span>

<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token comment">// ä¸Šæ¬¡æ¸²æŸ“çš„ fiber</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// æœ¬æ¬¡è¦æ¸²æŸ“çš„ fiber</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  renderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// éåˆæ¬¡æ¸²æŸ“</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span>
      <span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// Force a re-render if the implementation changed due to hot reload:</span>
      <span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> workInProgress<span class="token punctuation">.</span>type <span class="token operator">!==</span> current<span class="token punctuation">.</span>type <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Neither props nor legacy context changes. Check if there's a pending</span>
      <span class="token comment">// update or context change.</span>
      <span class="token keyword">const</span> hasScheduledUpdateOrContext <span class="token operator">=</span> <span class="token function">checkScheduledUpdateOrContext</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>hasScheduledUpdateOrContext <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// If this is the second pass of an error or suspense boundary, there</span>
        <span class="token comment">// may not be work scheduled on `current`, so we check for this flag.</span>
        <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">===</span> NoFlags
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No pending updates or context. Bail out now.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">attemptEarlyBailoutIfNoScheduledUpdate</span><span class="token punctuation">(</span>
          current<span class="token punctuation">,</span>
          workInProgress<span class="token punctuation">,</span>
          renderLanes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ForceUpdateForLegacySuspense<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is a special case that only exists for legacy mode.</span>
        <span class="token comment">// See https://github.com/facebook/react/pull/19216.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// An update was scheduled on this fiber, but there are no new props</span>
        <span class="token comment">// nor legacy context. Set this to false. If an update queue or context</span>
        <span class="token comment">// consumer produces a changed value, it will set this to true. Otherwise,</span>
        <span class="token comment">// the component will assume the children have not changed and bail out.</span>
        didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIsHydrating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isForkedChild</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if this child belongs to a list of muliple children in</span>
      <span class="token comment">// its parent.</span>
      <span class="token comment">//</span>
      <span class="token comment">// In a true multi-threaded implementation, we would render children on</span>
      <span class="token comment">// parallel threads. This would represent the beginning of a new render</span>
      <span class="token comment">// thread for this subtree.</span>
      <span class="token comment">//</span>
      <span class="token comment">// We only use this for id generation during hydration, which is why the</span>
      <span class="token comment">// logic is located in this special branch.</span>
      <span class="token comment">// index è®°å½•äº†å½“å‰ fiber æ’åœ¨çˆ¶åˆ—è¡¨ä¸­çš„ä¸‹æ ‡</span>
      <span class="token keyword">const</span> slotIndex <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token keyword">const</span> numberOfForks <span class="token operator">=</span> <span class="token function">getForksAtLevel</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pushTreeId</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> numberOfForks<span class="token punctuation">,</span> slotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Before entering the begin phase, clear pending update priority.</span>
  <span class="token comment">// TODO: This assumes that we're about to evaluate the component and process</span>
  <span class="token comment">// the update queue. However, there's an exception: SimpleMemoComponent</span>
  <span class="token comment">// sometimes bails out later in the begin phase. This indicates that we should</span>
  <span class="token comment">// move this assignment out of the common path and into each branch.</span>
  <span class="token comment">// å› ä¸ºå¦‚ä¸‹è¦çœŸæ­£æ¸²æŸ“äº†ï¼Œå¯ä»¥å°†ä¼˜å…ˆçº§ä¿¡æ¯æ¸…ç©º</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> LazyComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> elementType <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">mountLazyComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        elementType<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostText<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SuspenseComponent<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateSuspenseComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updatePortalComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ForwardRef<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> type
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateForwardRef</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateFragment</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Mode<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateMode</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Profiler<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateProfiler</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextProvider<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextProvider</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextConsumer<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextConsumer</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token comment">// Resolve outer props first, then resolve inner props.</span>
      <span class="token keyword">let</span> resolvedProps <span class="token operator">=</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type <span class="token operator">!==</span> workInProgress<span class="token punctuation">.</span>elementType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> outerPropTypes <span class="token operator">=</span> type<span class="token punctuation">.</span>propTypes<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>outerPropTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkPropTypes</span><span class="token punctuation">(</span>
              outerPropTypes<span class="token punctuation">,</span>
              resolvedProps<span class="token punctuation">,</span> <span class="token comment">// Resolved for outer only</span>
              <span class="token string">'prop'</span><span class="token punctuation">,</span>
              <span class="token function">getComponentNameFromType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      resolvedProps <span class="token operator">=</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>type<span class="token punctuation">,</span> resolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateMemoComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateSimpleMemoComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> IncompleteClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">mountIncompleteClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> SuspenseListComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateSuspenseListComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ScopeComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableScopeAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">updateScopeComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> OffscreenComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateOffscreenComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> LegacyHiddenComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">updateLegacyHiddenComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> CacheComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">updateCacheComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unknown unit of work tag (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workInProgress<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">). This error is likely caused by a bug in </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token string">'React. Please file an issue.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br></div></div><ul><li>didReceiveUpdate æ ‡è®°æ˜¯å¦æœ‰å±æ€§æˆ–è€… context çš„æ›´æ–°ï¼Œå› ä¸ºè¿™ä¸¤ç§æƒ…å†µä¼šå¼•å‘ re-renderã€‚</li> <li>é‡è¦ç¯å¢ƒåœ¨äºæ ¹æ® workInProgress.tag ç±»åˆ«åˆ›å»ºæˆ–è€…æ›´æ–°ä¸åŒçš„ç»„ä»¶ï¼Œè¿™é‡Œå…·ä½“è¿‡ç¨‹ä¸åœ¨èµ˜è¿°ï¼Œå¯ä»¥å‚è€ƒ <a href="/react/updater/workloop">workLoop å’Œ performUnitOfWork æ¢æ</a>ä¸€æ–‡ã€‚</li> <li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šé¢ updateXXXComponent çš„ä¹‹åï¼Œä¼šè¿”å›  <code>workInProgress.child</code> ï¼Œä½œä¸º performUnitOfWork ä¸­çš„ nextã€‚æ ¹æ®è¿™ä¸ªçº¿ç´¢ï¼Œå¯ä»¥çŸ¥é“ react ä¸­ performUnitOfWork ä¸­æ˜¯æ ¹æ®æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰æ¥è¿›è¡Œéå†æ¸²æŸ“çš„ï¼Œé‚£ä¹ˆè¿™ç§éå†æ€ä¹ˆæ‰©å±•åˆ°å…„å¼ŸèŠ‚ç‚¹å‘¢ï¼Ÿ</li></ul> <h2 id="completeunitofwork"><a href="#completeunitofwork" class="header-anchor">#</a> completeUnitOfWork</h2> <h2 id="completework"><a href="#completework" class="header-anchor">#</a> completeWork</h2> <h2 id="commitroot"><a href="#commitroot" class="header-anchor">#</a> commitRoot</h2></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-front-end/edit/master/docs/10.react/80.æ€»ç»“/40.10-min-react.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2022/04/15, 00:23:56</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/react/summary/event-listener/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">React ä¸­çš„äº‹ä»¶ç›‘å¬æœºåˆ¶</div></a> <a href="/react/tour/index/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">å¼€å§‹ä¸Šæ‰‹</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/react/summary/event-listener/" class="prev">React ä¸­çš„äº‹ä»¶ç›‘å¬æœºåˆ¶</a></span> <span class="next"><a href="/react/tour/index/">å¼€å§‹ä¸Šæ‰‹</a>â†’
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/solid/render/render-by-jsx/"><div>
            æ¸²æŸ“åŸç†ä¹‹ç»„ä»¶ç»“æ„ä¸ JSX ç¼–è¯‘
            <!----></div></a> <span class="date">09-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/solid/plan/"><div>
            è®¡åˆ’è·Ÿè¸ª
            <!----></div></a> <span class="date">09-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/solid/index/"><div>
            å¼€å§‹ä¸Šæ‰‹
            <!----></div></a> <span class="date">09-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="åšå®¢" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="æ–‡æ¡£" target="_blank" class="iconfont icon-shuben"></a><a href="https://ml.jonsam.site" title="æœºå™¨å­¦ä¹ " target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2022-2022
    <span>Fancy Front End | Made by <a href="https://www.jonsam.site" target="_blank">Jonsam</a> by â¤</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.eb21b6ee.js" defer></script><script src="/assets/js/2.01e091c2.js" defer></script><script src="/assets/js/45.3973ea4b.js" defer></script><script src="/assets/js/4.54e60667.js" defer></script><script src="/assets/js/12.71337abb.js" defer></script><script src="/assets/js/10.ac472f43.js" defer></script><script src="/assets/js/11.c50183f9.js" defer></script><script src="/assets/js/8.7cbef5ec.js" defer></script><script src="/assets/js/5.f620477b.js" defer></script>
  </body>
</html>
