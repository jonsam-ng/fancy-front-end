<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 首次渲染过程 | Fancy Front End</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <meta name="description" content="前端源码阅读栈，精读 React、Vue3 源码">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="前端源码,React源码,Vue源码,Vu3源码,Webpack源码">
    <meta name="theme-color" content="#3CB982">
    
    <link rel="preload" href="/assets/css/0.styles.e2349a00.css" as="style"><link rel="preload" href="/assets/js/app.eb21b6ee.js" as="script"><link rel="preload" href="/assets/js/2.01e091c2.js" as="script"><link rel="preload" href="/assets/js/43.2cfdc8d9.js" as="script"><link rel="preload" href="/assets/js/4.54e60667.js" as="script"><link rel="preload" href="/assets/js/12.71337abb.js" as="script"><link rel="preload" href="/assets/js/10.ac472f43.js" as="script"><link rel="preload" href="/assets/js/11.c50183f9.js" as="script"><link rel="preload" href="/assets/js/8.7cbef5ec.js" as="script"><link rel="preload" href="/assets/js/5.f620477b.js" as="script"><link rel="prefetch" href="/assets/js/100.8081075e.js"><link rel="prefetch" href="/assets/js/101.943ea683.js"><link rel="prefetch" href="/assets/js/102.11c8554c.js"><link rel="prefetch" href="/assets/js/103.c2780521.js"><link rel="prefetch" href="/assets/js/104.81994794.js"><link rel="prefetch" href="/assets/js/105.f987244b.js"><link rel="prefetch" href="/assets/js/106.235a578e.js"><link rel="prefetch" href="/assets/js/107.94cdbb18.js"><link rel="prefetch" href="/assets/js/108.3a80cb29.js"><link rel="prefetch" href="/assets/js/109.8884be03.js"><link rel="prefetch" href="/assets/js/110.89ab5eb2.js"><link rel="prefetch" href="/assets/js/111.355b1782.js"><link rel="prefetch" href="/assets/js/112.34671c87.js"><link rel="prefetch" href="/assets/js/113.0cca0902.js"><link rel="prefetch" href="/assets/js/114.01616168.js"><link rel="prefetch" href="/assets/js/115.4915c0b5.js"><link rel="prefetch" href="/assets/js/116.ef93855a.js"><link rel="prefetch" href="/assets/js/117.e3526ed0.js"><link rel="prefetch" href="/assets/js/118.7d52a4ea.js"><link rel="prefetch" href="/assets/js/119.a4bb17bb.js"><link rel="prefetch" href="/assets/js/120.135aa6ea.js"><link rel="prefetch" href="/assets/js/121.86c35c15.js"><link rel="prefetch" href="/assets/js/122.1452986d.js"><link rel="prefetch" href="/assets/js/123.0181b553.js"><link rel="prefetch" href="/assets/js/124.edc508f8.js"><link rel="prefetch" href="/assets/js/125.46d932c1.js"><link rel="prefetch" href="/assets/js/126.17e05a12.js"><link rel="prefetch" href="/assets/js/127.98159dfe.js"><link rel="prefetch" href="/assets/js/128.9aaa5bc6.js"><link rel="prefetch" href="/assets/js/129.26bed928.js"><link rel="prefetch" href="/assets/js/13.292db5f6.js"><link rel="prefetch" href="/assets/js/130.9f74c846.js"><link rel="prefetch" href="/assets/js/131.d6ef0885.js"><link rel="prefetch" href="/assets/js/132.1d9ee075.js"><link rel="prefetch" href="/assets/js/133.2b23ed7b.js"><link rel="prefetch" href="/assets/js/134.c47e8a23.js"><link rel="prefetch" href="/assets/js/135.2aeb3426.js"><link rel="prefetch" href="/assets/js/136.0169c47b.js"><link rel="prefetch" href="/assets/js/137.70cdfc24.js"><link rel="prefetch" href="/assets/js/138.e54160ee.js"><link rel="prefetch" href="/assets/js/139.9a6d1932.js"><link rel="prefetch" href="/assets/js/14.54d2636a.js"><link rel="prefetch" href="/assets/js/140.ddabaeca.js"><link rel="prefetch" href="/assets/js/141.35844ecc.js"><link rel="prefetch" href="/assets/js/142.4ccdb5e4.js"><link rel="prefetch" href="/assets/js/143.37a7f36e.js"><link rel="prefetch" href="/assets/js/144.95ff6a63.js"><link rel="prefetch" href="/assets/js/145.9899e545.js"><link rel="prefetch" href="/assets/js/146.6865658b.js"><link rel="prefetch" href="/assets/js/147.2a55d18a.js"><link rel="prefetch" href="/assets/js/148.f3aab640.js"><link rel="prefetch" href="/assets/js/149.57b565a0.js"><link rel="prefetch" href="/assets/js/15.81d908ff.js"><link rel="prefetch" href="/assets/js/150.3f7143ae.js"><link rel="prefetch" href="/assets/js/151.5981cf9e.js"><link rel="prefetch" href="/assets/js/152.a3428a7b.js"><link rel="prefetch" href="/assets/js/153.0f0b339d.js"><link rel="prefetch" href="/assets/js/154.39f3b522.js"><link rel="prefetch" href="/assets/js/155.13c8170a.js"><link rel="prefetch" href="/assets/js/156.ccb66614.js"><link rel="prefetch" href="/assets/js/157.4b8bce50.js"><link rel="prefetch" href="/assets/js/158.6476dd1c.js"><link rel="prefetch" href="/assets/js/159.b261a009.js"><link rel="prefetch" href="/assets/js/16.68d8e787.js"><link rel="prefetch" href="/assets/js/160.e501007d.js"><link rel="prefetch" href="/assets/js/161.d3f56d3d.js"><link rel="prefetch" href="/assets/js/162.f8590797.js"><link rel="prefetch" href="/assets/js/163.91fe4509.js"><link rel="prefetch" href="/assets/js/164.6e92f3f4.js"><link rel="prefetch" href="/assets/js/165.56868a39.js"><link rel="prefetch" href="/assets/js/166.83812a3b.js"><link rel="prefetch" href="/assets/js/167.4b528df4.js"><link rel="prefetch" href="/assets/js/168.f2b151fb.js"><link rel="prefetch" href="/assets/js/169.cb2ee128.js"><link rel="prefetch" href="/assets/js/17.895175dc.js"><link rel="prefetch" href="/assets/js/170.63b574e9.js"><link rel="prefetch" href="/assets/js/171.ad38a311.js"><link rel="prefetch" href="/assets/js/172.b592b97e.js"><link rel="prefetch" href="/assets/js/173.302ef08b.js"><link rel="prefetch" href="/assets/js/174.d71ad1a3.js"><link rel="prefetch" href="/assets/js/175.2617c860.js"><link rel="prefetch" href="/assets/js/176.19a67035.js"><link rel="prefetch" href="/assets/js/177.75aab37d.js"><link rel="prefetch" href="/assets/js/178.b2773712.js"><link rel="prefetch" href="/assets/js/179.6a34b45f.js"><link rel="prefetch" href="/assets/js/18.736b781d.js"><link rel="prefetch" href="/assets/js/180.d447fc48.js"><link rel="prefetch" href="/assets/js/181.d6b96886.js"><link rel="prefetch" href="/assets/js/182.42c2bcd5.js"><link rel="prefetch" href="/assets/js/183.a6256a82.js"><link rel="prefetch" href="/assets/js/184.8a036f5a.js"><link rel="prefetch" href="/assets/js/185.811d5831.js"><link rel="prefetch" href="/assets/js/186.6436a583.js"><link rel="prefetch" href="/assets/js/187.4bcf94a3.js"><link rel="prefetch" href="/assets/js/188.33f39bd6.js"><link rel="prefetch" href="/assets/js/189.c1b90840.js"><link rel="prefetch" href="/assets/js/19.504bd141.js"><link rel="prefetch" href="/assets/js/20.e526fb51.js"><link rel="prefetch" href="/assets/js/21.8375d39e.js"><link rel="prefetch" href="/assets/js/22.0e15b626.js"><link rel="prefetch" href="/assets/js/23.83bcc15c.js"><link rel="prefetch" href="/assets/js/24.3df554ce.js"><link rel="prefetch" href="/assets/js/25.6c56da2b.js"><link rel="prefetch" href="/assets/js/26.76154857.js"><link rel="prefetch" href="/assets/js/27.155dbcb4.js"><link rel="prefetch" href="/assets/js/28.7178e96c.js"><link rel="prefetch" href="/assets/js/29.f7337396.js"><link rel="prefetch" href="/assets/js/3.50570587.js"><link rel="prefetch" href="/assets/js/30.191545d3.js"><link rel="prefetch" href="/assets/js/31.b6a0fe90.js"><link rel="prefetch" href="/assets/js/32.18cebeab.js"><link rel="prefetch" href="/assets/js/33.146782c3.js"><link rel="prefetch" href="/assets/js/34.c08af9cb.js"><link rel="prefetch" href="/assets/js/35.ea730de0.js"><link rel="prefetch" href="/assets/js/36.11aba0b0.js"><link rel="prefetch" href="/assets/js/37.0fd8e20a.js"><link rel="prefetch" href="/assets/js/38.2cde6902.js"><link rel="prefetch" href="/assets/js/39.07c230cc.js"><link rel="prefetch" href="/assets/js/40.e4fcccd0.js"><link rel="prefetch" href="/assets/js/41.5f96c201.js"><link rel="prefetch" href="/assets/js/42.e5023440.js"><link rel="prefetch" href="/assets/js/44.37f32c52.js"><link rel="prefetch" href="/assets/js/45.3973ea4b.js"><link rel="prefetch" href="/assets/js/46.87541312.js"><link rel="prefetch" href="/assets/js/47.04f0011f.js"><link rel="prefetch" href="/assets/js/48.1151f311.js"><link rel="prefetch" href="/assets/js/49.6830fb0c.js"><link rel="prefetch" href="/assets/js/50.84b34574.js"><link rel="prefetch" href="/assets/js/51.840f38c4.js"><link rel="prefetch" href="/assets/js/52.3dbda6e7.js"><link rel="prefetch" href="/assets/js/53.7f0a8896.js"><link rel="prefetch" href="/assets/js/54.5d7f6427.js"><link rel="prefetch" href="/assets/js/55.86c7b544.js"><link rel="prefetch" href="/assets/js/56.49a27b9a.js"><link rel="prefetch" href="/assets/js/57.287f9e58.js"><link rel="prefetch" href="/assets/js/58.40a49fdb.js"><link rel="prefetch" href="/assets/js/59.91487422.js"><link rel="prefetch" href="/assets/js/6.8880bb8c.js"><link rel="prefetch" href="/assets/js/60.8dfd58ee.js"><link rel="prefetch" href="/assets/js/61.7b4874b9.js"><link rel="prefetch" href="/assets/js/62.d83f3691.js"><link rel="prefetch" href="/assets/js/63.1237a900.js"><link rel="prefetch" href="/assets/js/64.1f096a25.js"><link rel="prefetch" href="/assets/js/65.809d988d.js"><link rel="prefetch" href="/assets/js/66.43c1e5f9.js"><link rel="prefetch" href="/assets/js/67.24ab137d.js"><link rel="prefetch" href="/assets/js/68.7b0346b5.js"><link rel="prefetch" href="/assets/js/69.2008c989.js"><link rel="prefetch" href="/assets/js/7.0c293177.js"><link rel="prefetch" href="/assets/js/70.e8cf3232.js"><link rel="prefetch" href="/assets/js/71.d661943d.js"><link rel="prefetch" href="/assets/js/72.e67a47a3.js"><link rel="prefetch" href="/assets/js/73.87f1db52.js"><link rel="prefetch" href="/assets/js/74.ac67cd0d.js"><link rel="prefetch" href="/assets/js/75.e25ebf69.js"><link rel="prefetch" href="/assets/js/76.a7222468.js"><link rel="prefetch" href="/assets/js/77.ffb71305.js"><link rel="prefetch" href="/assets/js/78.72c00bee.js"><link rel="prefetch" href="/assets/js/79.66ec368e.js"><link rel="prefetch" href="/assets/js/80.8792d3d7.js"><link rel="prefetch" href="/assets/js/81.49d3731a.js"><link rel="prefetch" href="/assets/js/82.fbe09e61.js"><link rel="prefetch" href="/assets/js/83.220a02bb.js"><link rel="prefetch" href="/assets/js/84.4b722410.js"><link rel="prefetch" href="/assets/js/85.f83d2db9.js"><link rel="prefetch" href="/assets/js/86.17b19d53.js"><link rel="prefetch" href="/assets/js/87.37568307.js"><link rel="prefetch" href="/assets/js/88.d7cc6612.js"><link rel="prefetch" href="/assets/js/89.ffb378d0.js"><link rel="prefetch" href="/assets/js/9.2a7e5bdc.js"><link rel="prefetch" href="/assets/js/90.02c91127.js"><link rel="prefetch" href="/assets/js/91.c22d9224.js"><link rel="prefetch" href="/assets/js/92.c79d457a.js"><link rel="prefetch" href="/assets/js/93.33a03732.js"><link rel="prefetch" href="/assets/js/94.c73ddbbc.js"><link rel="prefetch" href="/assets/js/95.a5151497.js"><link rel="prefetch" href="/assets/js/96.b8f204d2.js"><link rel="prefetch" href="/assets/js/97.d7ddaa6f.js"><link rel="prefetch" href="/assets/js/98.49dbda5e.js"><link rel="prefetch" href="/assets/js/99.d14f43ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2349a00.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Fancy Front End" class="logo"> <span class="site-name can-hide">Fancy Front End</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/react/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/plan/" class="sidebar-link">plan 计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调和（Reconciliation）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调度器（Scheduler）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新器（Updater）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>渲染器（Render）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hooks原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/summary/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/summary/bitOperation/" class="sidebar-link">位运算初探</a></li><li><a href="/react/summary/first-render/" aria-current="page" class="active sidebar-link">React 首次渲染过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#reactdom-render" class="sidebar-link">ReactDOM.render</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#legacyrendersubtreeintocontainer" class="sidebar-link">legacyRenderSubtreeIntoContainer</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#createfiberroot" class="sidebar-link">createFiberRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#createhostrootfiber" class="sidebar-link">createHostRootFiber</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#flushsync" class="sidebar-link">flushSync</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#updatecontainer" class="sidebar-link">updateContainer</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#q-a" class="sidebar-link">Q&amp;A</a></li><li class="sidebar-sub-header level2"><a href="/react/summary/first-render/#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/react/summary/event-listener/" class="sidebar-link">React 中的事件监听机制</a></li><li><a href="/react/summary/10-min-react/" class="sidebar-link">30 分钟看懂 React 框架原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React源码漂流记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-e1efabd0><div class="articleInfo" data-v-e1efabd0><ul class="breadcrumbs" data-v-e1efabd0><li data-v-e1efabd0><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-e1efabd0></a></li> <li data-v-e1efabd0><a href="/categories/?category=react" title="分类" data-v-e1efabd0>react</a></li><li data-v-e1efabd0><a href="/categories/?category=%E6%80%BB%E7%BB%93" title="分类" data-v-e1efabd0>总结</a></li></ul> <div class="info" data-v-e1efabd0><div title="作者" class="author iconfont icon-touxiang" data-v-e1efabd0><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-e1efabd0>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-e1efabd0><a href="javascript:;" data-v-e1efabd0>2022-04-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">React 首次渲染过程<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>React17</span></div> <!----> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <p></p><div class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#reactdom-render">ReactDOM.render</a><ul><li><a href="#jsxwithvalidation">jsxWithValidation</a></li><li><a href="#render">render</a></li></ul></li><li><a href="#legacyrendersubtreeintocontainer">legacyRenderSubtreeIntoContainer</a></li><li><a href="#createfiberroot">createFiberRoot</a></li><li><a href="#createhostrootfiber">createHostRootFiber</a></li><li><a href="#flushsync">flushSync</a><ul><li><a href="#flushpassiveeffects">flushPassiveEffects</a></li><li><a href="#flushsynccallbacks">flushSyncCallbacks</a></li></ul></li><li><a href="#updatecontainer">updateContainer</a></li><li><a href="#小结">小结</a></li><li><a href="#q-a">Q&amp;A</a><ul><li><a href="#executioncontext-有哪几种">executionContext 有哪几种？</a></li><li><a href="#使用位运算提高枚举计算效率">使用位运算提高枚举计算效率</a></li></ul></li><li><a href="#参考资料">参考资料</a></li></ul></div><p></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>本文的代码去除了 dev 环境的部分代码。</li></ul></div> <h2 id="reactdom-render"><a href="#reactdom-render" class="header-anchor">#</a> ReactDOM.render</h2> <p>通过在 ReactDOM.render 语句添加断点，我们来追溯一下 React 的首次渲染过程。</p> <h3 id="jsxwithvalidation"><a href="#jsxwithvalidation" class="header-anchor">#</a> jsxWithValidation</h3> <p>首先开始验证  <code>&lt;App /&gt;</code>  组件是否是合法的 jsx 组件。如果不合法，就打印错误消息和错误栈信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/fixtures/legacy-jsx-runtimes/react-17/cjs/react-jsx-dev-runtime.development.js</span>
<span class="token keyword">function</span> <span class="token function">jsxWithValidation</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isStaticChildren<span class="token punctuation">,</span> source<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">var</span> validType <span class="token operator">=</span> <span class="token function">isValidElementType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We warn in this case but don't throw. We expect the element creation to</span>
    <span class="token comment">// succeed and there will likely be errors in render.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// pass </span>
      <span class="token comment">// 报错处理</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回一个 ReactElement 对象</span>
    <span class="token keyword">var</span> element <span class="token operator">=</span> <span class="token function">jsxDEV</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> source<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The result can be nullish if a mock or a custom function is used.</span>
    <span class="token comment">// TODO: Drop this when these are no longer allowed as the type argument.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// Skip key warning if the type isn't valid since our key validation logic</span>
    <span class="token comment">// doesn't expect a non-string/function type and can throw confusing errors.</span>
    <span class="token comment">// We don't want exception behavior to differ between dev and prod.</span>
    <span class="token comment">// (Rendering will throw with a helpful message and as soon as the type is</span>
    <span class="token comment">// fixed, the key warnings will appear.)</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>validType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// isStaticChildren 则校验 key 值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isStaticChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">validateChildKeys</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>freeze<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'React.jsx: Static children should always be an array. '</span> <span class="token operator">+</span> <span class="token string">'You are likely explicitly calling React.jsxs or React.jsxDEV. '</span> <span class="token operator">+</span> <span class="token string">'Use the Babel transform instead.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">validateChildKeys</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> exports<span class="token punctuation">.</span>Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">validateFragmentProps</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">validatePropTypes</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> element<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// Local Stack</span>
<span class="token comment">// {</span>
<span class="token comment">//   &quot;props&quot;: {},</span>
<span class="token comment">//   &quot;isStaticChildren&quot;: false,</span>
<span class="token comment">//   &quot;source&quot;: {</span>
<span class="token comment">//     &quot;fileName&quot;: &quot;/Users/jonsam/Projects/update_in_github/react-source-reading/src/index.js&quot;,</span>
<span class="token comment">//     &quot;lineNumber&quot;: 9,</span>
<span class="token comment">//     &quot;columnNumber&quot;: 5</span>
<span class="token comment">//   },</span>
<span class="token comment">//   &quot;validType&quot;: true,</span>
<span class="token comment">//   &quot;element&quot;: {</span>
<span class="token comment">//     &quot;key&quot;: null,</span>
<span class="token comment">//     &quot;ref&quot;: null,</span>
<span class="token comment">//     &quot;props&quot;: {},</span>
<span class="token comment">//     &quot;_owner&quot;: null,</span>
<span class="token comment">//     &quot;_store&quot;: {}</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>那么如何判断是否是合法的 Element 呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isValidElementType</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是 string 和 function 是合法的 Element，分别代表着文本节点和 FC</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// Note: typeof might be other than 'symbol' or 'number' (e.g. if it's a polyfill).</span>

  <span class="token comment">// 判断 type 是否为 Fragment，profiler，suspense 之类的特殊类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> exports<span class="token punctuation">.</span>Fragment <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_PROFILER_TYPE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_DEBUG_TRACING_MODE_TYPE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_STRICT_MODE_TYPE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_SUSPENSE_TYPE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_SUSPENSE_LIST_TYPE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REACT_LEGACY_HIDDEN_TYPE</span> <span class="token operator">||</span> enableScopeAPI <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 判断 $$typeof 书否为内部类型，LAZY、MEMO、PROVIDER、CONTEXT、FORWARD_REF 等</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_LAZY_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_MEMO_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_PROVIDER_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_CONTEXT_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_FORWARD_REF_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_FUNDAMENTAL_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_BLOCK_TYPE</span> <span class="token operator">||</span> type<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token constant">REACT_SERVER_BLOCK_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>jsxDEV 如何返回一个 ReactElement 呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">ReactElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// This tag allows us to uniquely identify this as a React Element</span>
    <span class="token comment">// 添加 ReactElement 的 $$typeof 类型</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span>
    <span class="token comment">// Built-in properties that belong on the element</span>
    <span class="token comment">// 节点实际的类型，此处为 function</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> key<span class="token punctuation">,</span>
    <span class="token literal-property property">ref</span><span class="token operator">:</span> ref<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> props<span class="token punctuation">,</span>
    <span class="token comment">// Record the component responsible for creating this element.</span>
    <span class="token literal-property property">_owner</span><span class="token operator">:</span> owner
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token comment">// The validation flag is currently mutative. We put it on</span>
    <span class="token comment">// an external backing store so that we can freeze the whole object.</span>
    <span class="token comment">// This can be replaced with a WeakMap once they are implemented in</span>
    <span class="token comment">// commonly used development environments.</span>
    <span class="token comment">// 使用外部的代码块防止变量因为 _store 的引用而不能释放，可以放 weakMap 代替，给 element 添加类似于 weakMap 的 _store 属性</span>
    element<span class="token punctuation">.</span>_store <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// To make comparing ReactElements easier for testing purposes, we make</span>
    <span class="token comment">// the validation flag non-enumerable (where possible, which should</span>
    <span class="token comment">// include every environment we run tests in), so the test framework</span>
    <span class="token comment">// ignores it.</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>_store<span class="token punctuation">,</span> <span class="token string">'validated'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// self and source are DEV only properties.</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">'_self'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> self
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Two elements created in two different places should be considered</span>
    <span class="token comment">// equal for testing purposes and therefore we hide it from enumeration.</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">'_source'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> source
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>freeze<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Local Stack</span>
<span class="token comment">// {</span>
<span class="token comment">//   &quot;config&quot;: {},</span>
<span class="token comment">//   &quot;source&quot;: {</span>
<span class="token comment">//     &quot;fileName&quot;: &quot;/Users/jonsam/Projects/update_in_github/react-source-reading/src/index.js&quot;,</span>
<span class="token comment">//     &quot;lineNumber&quot;: 9,</span>
<span class="token comment">//     &quot;columnNumber&quot;: 5</span>
<span class="token comment">//   },</span>
<span class="token comment">//   &quot;props&quot;: {},</span>
<span class="token comment">//   &quot;key&quot;: null,</span>
<span class="token comment">//   &quot;ref&quot;: null</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><ul><li>ReactElement 是一个工厂函数，传入相关的属性，生成 ReactElement 对象。</li> <li>ReactElement 中  <code>$$typeof</code>  是指内部的节点类型，ReactElement 的内部类型为  <code>REACT_ELEMENT_TYPE</code> ，type 是指实际的节点类型，此处是一个 function。</li> <li>在测试环境下会在 ReactElement 上挂载 _store 属性，类似于 weakMap 是为了节省内存，目的是为了开发环境中测试提速。</li></ul> <h3 id="render"><a href="#render" class="header-anchor">#</a> render</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-dom/src/client/ReactDOMLegacy.js</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">element</span><span class="token operator">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidContainerLegacy</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    element<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <img src="/assets/img/render-fn-stack.jpeg" alt="render-fn-stack" data-zoomable=""></div> <p>生成 ReactElement 之后调用 render 方法，内部判断是否是合法的 container，然后调用 legacyRenderSubtreeIntoContainer 方法将 subTree 渲染到 container 中。</p> <p>怎么判断是否是合法的 container 呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// We only use it in places that are currently more relaxed.</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isValidContainerLegacy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token comment">// 通过 node.nodeType 来判断 node 是否是已知的类型</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    node <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">ELEMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_FRAGMENT_NODE</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>nodeValue <span class="token operator">===</span> <span class="token string">' react-mount-point-unstable '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <p>去除可访问性和事件之后的属性：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>assignedSlot: null
attributeStyleMap: StylePropertyMap {size: 0}
attributes: NamedNodeMap {0: id, id: id, length: 1}
autocapitalize: &quot;&quot;
autofocus: false
baseURI: &quot;http://localhost:3001/&quot;
childElementCount: 0
childNodes: NodeList []
children: HTMLCollection []
classList: DOMTokenList [value: '']
className: &quot;&quot;
clientHeight: 0
clientLeft: 0
clientTop: 0
clientWidth: 1792
contentEditable: &quot;inherit&quot;
dataset: DOMStringMap {}
dir: &quot;&quot;
draggable: false
elementTiming: &quot;&quot;
enterKeyHint: &quot;&quot;
firstChild: null
firstElementChild: null
hidden: false
id: &quot;root&quot;
innerHTML: &quot;&quot;
innerText: &quot;&quot;
inputMode: &quot;&quot;
isConnected: true
isContentEditable: false
lang: &quot;&quot;
lastChild: null
lastElementChild: null
localName: &quot;div&quot;
namespaceURI: &quot;http://www.w3.org/1999/xhtml&quot;
nextElementSibling: null
nextSibling: text
nodeName: &quot;DIV&quot;
nodeType: 1
nodeValue: null
nonce: &quot;&quot;
offsetHeight: 0
offsetLeft: 0
offsetParent: body
offsetTop: 0
offsetWidth: 1792
outerHTML: &quot;&lt;div id=\&quot;root\&quot;&gt;&lt;/div&gt;&quot;
outerText: &quot;&quot;
ownerDocument: document
parentElement: body
parentNode: body
part: DOMTokenList [value: '']
prefix: null
previousElementSibling: noscript
previousSibling: text
scrollHeight: 0
scrollLeft: 0
scrollTop: 0
scrollWidth: 1792
shadowRoot: null
slot: &quot;&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div></div> <p>可以看到，这里 nodeType: 1，即为 ELEMENT_NODE。</p> <h2 id="legacyrendersubtreeintocontainer"><a href="#legacyrendersubtreeintocontainer" class="header-anchor">#</a> legacyRenderSubtreeIntoContainer</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-dom/src/client/ReactDOMLegacy.js</span>
<span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">parentComponent</span><span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">forceHydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断是否已经创建过 RootContainer </span>
  <span class="token comment">// _reactRootContainer 标记为 container 上的 FiberRoot 对象</span>
  <span class="token keyword">let</span> root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token literal-property property">fiberRoot</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initial mount</span>
    <span class="token comment">// RootContainer 未创建则为首次挂载应用，调用 legacyCreateRootFromDOMContainer 创建 Root </span>
    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
      container<span class="token punctuation">,</span>
      forceHydrate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token comment">// 如果在 render 函数中传入了 callback，需要调用 callback</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Initial mount should not be batched.</span>
    <span class="token comment">// 在 mount 阶段，以最高优先级同步的执行所有的更新</span>
    <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Update</span>
    <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <p>当前传入的变量：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>callback: undefined
children: {$$typeof: Symbol(react.element), type: Symbol(react.strict_mode), key: null, ref: null, props: {…}, …}
container: div#root
fiberRoot: undefined
forceHydrate: false
originalCallback: undefined
parentComponent: null
root: undefined
_originalCallback: undefined
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></div> <p>render 函数中 callback 返回当前容器（container）中的 FiberRoot 对象，由下面这个递归的函数可见：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> PublicInstance <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> containerFiber <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// 最终返回的有效的 instance 是 Fiber.child.stateNode 刚好是 RootFiber</span>
      <span class="token keyword">return</span> containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="legacycreaterootfromdomcontainer"><a href="#legacycreaterootfromdomcontainer" class="header-anchor">#</a> legacyCreateRootFromDOMContainer</h4> <p>RootContainer 是如何根据 container 创建的呢？我们来追溯下 legacyCreateRootFromDOMContainer 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">forceHydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token punctuation">{</span>
  <span class="token comment">// First clear any existing content.</span>
  <span class="token comment">// 如果不是 SSR，就清空 container 中所有的节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forceHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用 createContainer 创建 RootContainer</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    <span class="token comment">// export const LegacyRoot = 0;</span>
    <span class="token comment">// export const ConcurrentRoot = 1;</span>
    LegacyRoot<span class="token punctuation">,</span>
    forceHydrate<span class="token punctuation">,</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// hydrationCallbacks</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// isStrictMode</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// concurrentUpdatesByDefaultOverride,</span>
    <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// identifierPrefix</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将 FiberRoot 挂载到 container 上，便于下次使用</span>
  <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> rootContainerElement <span class="token operator">=</span>
    container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span> <span class="token operator">?</span> container<span class="token punctuation">.</span>parentNode <span class="token operator">:</span> container<span class="token punctuation">;</span>
  <span class="token comment">// 开启 container 上所支持的事件监听</span>
  <span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span>rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">containerInfo</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrationCallbacks</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span>
  <span class="token literal-property property">isStrictMode</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">concurrentUpdatesByDefaultOverride</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">identifierPrefix</span><span class="token operator">:</span> string<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> OpaqueRoot <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
    containerInfo<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    hydrationCallbacks<span class="token punctuation">,</span>
    isStrictMode<span class="token punctuation">,</span>
    concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
    identifierPrefix<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/react/packages/react-dom/src/client/ReactDOMComponentTree.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">hostRoot</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token literal-property property">node</span><span class="token operator">:</span> Container</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将 FiberRoot 挂载到相应的 container 上</span>
  <span class="token comment">// internalContainerInstanceKey： &quot;__reactFiber$9yvlviys3ft&quot;</span>
  node<span class="token punctuation">[</span>internalContainerInstanceKey<span class="token punctuation">]</span> <span class="token operator">=</span> hostRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// randomKey 是每次启动应用生成的随机的 key 值，被应用在内部一些 key 值的使用上</span>
<span class="token keyword">const</span> randomKey <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> internalContainerInstanceKey <span class="token operator">=</span> <span class="token string">'__reactContainer$'</span> <span class="token operator">+</span> randomKey<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><ul><li>RootContainer 分为了两种：LegacyRoot 和 ConcurrentRoot。分别代表着这 React 运行的两种模式：Legacy Mode 和 Concurrent Mode。</li> <li>RootContainer 实际上就是 FiberRoot。这里开始了从 ReactElement 到 FiberRoot 的创建过程。注意 FiberRoot（HostRoot） 本质上是 Root，不是 Fiber；而 RootFiber 才是 Fiber，才是 FiberTree 的根。</li> <li>randomKey 之所以要随机生成，有以下两点原因：标记是打在 node 这样的原生节点上的，随机的标记名可以防止将用户或者其他库所生成的标记覆盖，同时加上  <code>__reactContainer$</code>  这样的特征串更能防止重复；随机的标记更加安全，防止被其他程序更改或者恶意篡改造成程序崩溃。</li></ul> <h4 id="listentoallsupportedevents"><a href="#listentoallsupportedevents" class="header-anchor">#</a> listenToAllSupportedEvents</h4> <p>container 上的事件是如何委托监听的呢，我们来看下 listenToAllSupportedEvents 这个函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-dom/src/events/DOMPluginEventSystem.js</span>
<span class="token comment">// 为当前的应用生成随机的监听器标记</span>
<span class="token keyword">const</span> listeningMarker <span class="token operator">=</span>
  <span class="token string">'_reactListening'</span> <span class="token operator">+</span>
  Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// We should not delegate these events to the container, but rather</span>
<span class="token comment">// set them on the actual target element itself. This is primarily</span>
<span class="token comment">// because these events do not consistently bubble in the DOM.</span>
<span class="token comment">// 如下事件不能委托在 container 上，需要设置在实际的 target element 上，这是因为他们不能持续的冒泡。</span>
<span class="token comment">// 不能持续冒泡的事件的集合</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">nonDelegatedEvents</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>DOMEventName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'cancel'</span><span class="token punctuation">,</span>
  <span class="token string">'close'</span><span class="token punctuation">,</span>
  <span class="token string">'invalid'</span><span class="token punctuation">,</span>
  <span class="token string">'load'</span><span class="token punctuation">,</span>
  <span class="token string">'scroll'</span><span class="token punctuation">,</span>
  <span class="token string">'toggle'</span><span class="token punctuation">,</span>
  <span class="token comment">// In order to reduce bytes, we insert the above array of media events</span>
  <span class="token comment">// into this Set. Note: the &quot;error&quot; event isn't an exclusive media event,</span>
  <span class="token comment">// and can occur on other elements too. Rather than duplicate that event,</span>
  <span class="token comment">// we just take it from the media events array.</span>
  <span class="token comment">// 将媒体先关的事件加入这里以节省内存。</span>
  <span class="token operator">...</span>mediaEventTypes<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// List of events that need to be individually attached to media elements.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">mediaEventTypes</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>DOMEventName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'abort'</span><span class="token punctuation">,</span>
  <span class="token string">'canplay'</span><span class="token punctuation">,</span>
  <span class="token string">'canplaythrough'</span><span class="token punctuation">,</span>
  <span class="token string">'durationchange'</span><span class="token punctuation">,</span>
  <span class="token string">'emptied'</span><span class="token punctuation">,</span>
  <span class="token string">'encrypted'</span><span class="token punctuation">,</span>
  <span class="token string">'ended'</span><span class="token punctuation">,</span>
  <span class="token string">'error'</span><span class="token punctuation">,</span>
  <span class="token string">'loadeddata'</span><span class="token punctuation">,</span>
  <span class="token string">'loadedmetadata'</span><span class="token punctuation">,</span>
  <span class="token string">'loadstart'</span><span class="token punctuation">,</span>
  <span class="token string">'pause'</span><span class="token punctuation">,</span>
  <span class="token string">'play'</span><span class="token punctuation">,</span>
  <span class="token string">'playing'</span><span class="token punctuation">,</span>
  <span class="token string">'progress'</span><span class="token punctuation">,</span>
  <span class="token string">'ratechange'</span><span class="token punctuation">,</span>
  <span class="token string">'resize'</span><span class="token punctuation">,</span>
  <span class="token string">'seeked'</span><span class="token punctuation">,</span>
  <span class="token string">'seeking'</span><span class="token punctuation">,</span>
  <span class="token string">'stalled'</span><span class="token punctuation">,</span>
  <span class="token string">'suspend'</span><span class="token punctuation">,</span>
  <span class="token string">'timeupdate'</span><span class="token punctuation">,</span>
  <span class="token string">'volumechange'</span><span class="token punctuation">,</span>
  <span class="token string">'waiting'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">rootContainerElement</span><span class="token operator">:</span> EventTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>rootContainerElement<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>listeningMarker<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将事件监听标记设为 true，防止重复监听</span>
    <span class="token punctuation">(</span>rootContainerElement<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>listeningMarker<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    allNativeEvents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">domEventName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// We handle selectionchange separately because it</span>
      <span class="token comment">// doesn't bubble and needs to be on the document.</span>
      <span class="token comment">// 除 selectionchange 事件之外，其余事件如果可以持续的冒泡，就开启原生事件监听，从冒泡阶段监听；如果无法持续冒泡，从捕获阶段监听。</span>
      <span class="token comment">// selectionchange 将会单独处理，因为此事件不允许冒泡，而且必须在 document 上监听</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>domEventName <span class="token operator">!==</span> <span class="token string">'selectionchange'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nonDelegatedEvents<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 container 所在的 document </span>
    <span class="token keyword">const</span> ownerDocument <span class="token operator">=</span>
      <span class="token punctuation">(</span>rootContainerElement<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span>
        <span class="token operator">?</span> rootContainerElement
        <span class="token operator">:</span> <span class="token punctuation">(</span>rootContainerElement<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>ownerDocument<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ownerDocument <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The selectionchange event also needs deduplication</span>
      <span class="token comment">// but it is attached to the document.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ownerDocument<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>listeningMarker<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在 container 所在的 document 上单独监听 selectionchange 事件</span>
        <span class="token punctuation">(</span>ownerDocument<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>listeningMarker<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span><span class="token string">'selectionchange'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ownerDocument<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>先总结一下如上的代码：</p> <ul><li>react 中为提高应用的性能，采用了事件委托机制来来统一处理事件。事件被委托到 container 上或者是 document 上。</li> <li>react 将事件分为三类，一类是可以在冒泡过程中监听的，一类是可以在冒泡过程中监听需要在捕获中监听的，还有一类是在 document 上监听的，如 selectionchange。</li> <li>react 将所有的原生事件都委托了一遍，原因在于基于 react 子树的时间监听将统一由受委托的容器来进行监听。</li></ul> <p>以上是 react 事件监听的策略，真正的时间监听在函数 listenToNativeEvent 实现。那么 listenToNativeEvent 是如何监听原生事件的呢？请参见 <a href="/10.react/80.总结/event-listener.html">React 中的事件监听机制</a></p> <h2 id="createfiberroot"><a href="#createfiberroot" class="header-anchor">#</a> createFiberRoot</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">containerInfo</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrationCallbacks</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span>
  <span class="token literal-property property">isStrictMode</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">concurrentUpdatesByDefaultOverride</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">identifierPrefix</span><span class="token operator">:</span> string<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token punctuation">{</span>
  <span class="token comment">// 根据 containerInfo 等信息创建 FiberRoot 对象</span>
  <span class="token keyword">const</span> <span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>
    containerInfo<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    identifierPrefix<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>hydrationCallbacks <span class="token operator">=</span> hydrationCallbacks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Cyclic construction. This cheats the type system right now because</span>
  <span class="token comment">// stateNode is any.</span>
  <span class="token comment">// 创建与 HostRoot 强关联的 RootFiber</span>
  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>
    tag<span class="token punctuation">,</span>
    isStrictMode<span class="token punctuation">,</span>
    concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// HostRoot 与 RootFiber 双向链接 HostRoot.current = RootFiber; RootFiber.stateNode = HostRoot</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>

  <span class="token comment">// 初始化 RootFiber 上的更新队列</span>
  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> identifierPrefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pingCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>isDehydrated <span class="token operator">=</span> hydrate<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>eventTimes <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTimes <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>suspendedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pingedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>expiredLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mutableReadLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>entangledLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>entanglements <span class="token operator">=</span> <span class="token function">createLaneMap</span><span class="token punctuation">(</span>NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>identifierPrefix <span class="token operator">=</span> identifierPrefix<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pooledCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pooledCacheLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsHydration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mutableSourceEagerHydrationData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hydrationCallbacks <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> enableProfilerCommitHooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>effectDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>passiveEffectDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableUpdaterTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedUpdaters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pendingUpdatersLaneMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingUpdatersLaneMap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TotalLanes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pendingUpdatersLaneMap<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在 fiber 上初始化一个更新队列</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> initializeUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>fiber<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">baseState</span><span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
    <span class="token literal-property property">firstBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastBaseUpdate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">interleaved</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lanes</span><span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">effects</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <p>createFiberRoot 函数的变量栈：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>containerInfo: div#root
hydrate: false
hydrationCallbacks: undefined
root: FiberRootNode
callbackNode: null
callbackPriority: 0
containerInfo: div#root
context: null
current: FiberNode
actualDuration: 0
actualStartTime: -1
alternate: null
child: null
childLanes: 0
dependencies: null
elementType: null
firstEffect: null
flags: 0
index: 0
key: null
lanes: 0
lastEffect: null
memoizedProps: null
memoizedState: null
mode: 8
nextEffect: null
pendingProps: null
ref: null
return: null
selfBaseDuration: 0
sibling: null
stateNode: FiberRootNode {tag: 0, containerInfo: div#root, pendingChildren: null, current: FiberNode, pingCache: null, …}
tag: 3
treeBaseDuration: 0
type: null
updateQueue:
baseState: null
effects: null
firstBaseUpdate: null
lastBaseUpdate: null
shared: {pending: null}
[[Prototype]]: Object
_debugHookTypes: null
_debugID: 1
_debugNeedsRemount: false
_debugOwner: null
_debugSource: null
[[Prototype]]: Object
entangledLanes: 0
entanglements: (31) [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
eventTimes: (31) [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
expirationTimes: (31) [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1]
expiredLanes: 0
finishedLanes: 0
finishedWork: null
hydrate: false
interactionThreadID: 1
memoizedInteractions: Set(0) {size: 0}
mutableReadLanes: 0
mutableSourceEagerHydrationData: null
pendingChildren: null
pendingContext: null
pendingInteractionMap: Map(0) {size: 0}
pendingLanes: 0
pingCache: null
pingedLanes: 0
suspendedLanes: 0
tag: 0
timeoutHandle: -1
_debugRootType: &quot;createLegacyRoot()&quot;
[[Prototype]]: Object
tag: 0
uninitializedFiber: FiberNode {tag: 3, key: null, elementType: null, type: null, stateNode: FiberRootNode, …}
Closure
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div></div> <h2 id="createhostrootfiber"><a href="#createhostrootfiber" class="header-anchor">#</a> createHostRootFiber</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">isStrictMode</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">concurrentUpdatesByDefaultOverride</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token keyword">let</span> mode<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> ConcurrentRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> ConcurrentMode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isStrictMode <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">|=</span> StrictLegacyMode<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableStrictEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mode <span class="token operator">|=</span> StrictEffectsMode<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>enableStrictEffects <span class="token operator">&amp;&amp;</span> createRootStrictEffectsByDefault<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">|=</span> StrictLegacyMode <span class="token operator">|</span> StrictEffectsMode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// We only use this flag for our repo tests to check both behaviors.</span>
      <span class="token comment">// TODO: Flip this flag and rename it something like &quot;forceConcurrentByDefaultForTesting&quot;</span>
      <span class="token operator">!</span>enableSyncDefaultUpdates <span class="token operator">||</span>
      <span class="token comment">// Only for internal experiments.</span>
      <span class="token punctuation">(</span>allowConcurrentByDefault <span class="token operator">&amp;&amp;</span> concurrentUpdatesByDefaultOverride<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">|=</span> ConcurrentUpdatesByDefaultMode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> NoMode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> isDevToolsPresent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Always collect profile timings when DevTools are present.</span>
    <span class="token comment">// This enables DevTools to start capturing timing at any point–</span>
    <span class="token comment">// Without some nodes in the tree having empty base times.</span>
    mode <span class="token operator">|=</span> ProfileMode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This is a constructor function, rather than a POJO constructor, still</span>
<span class="token comment">// please ensure we do the following:</span>
<span class="token comment">// 1) Nobody should add any instance methods on this. Instance methods can be</span>
<span class="token comment">//    more difficult to predict when they get optimized and they are almost</span>
<span class="token comment">//    never inlined properly in static compilers.</span>
<span class="token comment">// 2) Nobody should rely on `instanceof Fiber` for type testing. We should</span>
<span class="token comment">//    always know when it is a fiber.</span>
<span class="token comment">// 3) We might want to experiment with using numeric keys since they are easier</span>
<span class="token comment">//    to optimize in a non-JIT environment.</span>
<span class="token comment">// 4) We can easily go from a constructor to a createFiber object literal if that</span>
<span class="token comment">//    is faster.</span>
<span class="token comment">// 5) It should be easy to port this to a C struct and keep a C implementation</span>
<span class="token comment">//    compatible.</span>
<span class="token comment">// createFiber 是一个工厂函数，不支持构造器、instanceof 语法</span>
<span class="token keyword">const</span> <span class="token function-variable function">createFiber</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token comment">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Instance</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// Fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>

  <span class="token comment">// Effects</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Note: The following is done to avoid a v8 performance cliff.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Initializing the fields below to smis and later updating them with</span>
    <span class="token comment">// double values will cause Fibers to end up having separate shapes.</span>
    <span class="token comment">// This behavior/bug has something to do with Object.preventExtension().</span>
    <span class="token comment">// Fortunately this only impacts DEV builds.</span>
    <span class="token comment">// Unfortunately it makes React unusably slow for some applications.</span>
    <span class="token comment">// To work around this, initialize the fields below with doubles.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Learn more about this here:</span>
    <span class="token comment">// https://github.com/facebook/react/issues/14365</span>
    <span class="token comment">// https://bugs.chromium.org/p/v8/issues/detail?id=8538</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>actualDuration <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token number">NaN</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>actualStartTime <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token number">NaN</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selfBaseDuration <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token number">NaN</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>treeBaseDuration <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token number">NaN</span><span class="token punctuation">;</span>

    <span class="token comment">// It's okay to replace the initial doubles with smis after initialization.</span>
    <span class="token comment">// This won't trigger the performance cliff mentioned above,</span>
    <span class="token comment">// and it simplifies other profiler code (including DevTools).</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>actualDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>actualStartTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selfBaseDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>treeBaseDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><ul><li>RootFiber 本质上是 Fiber 的原因是调用了 createFiber 来构造 Fiber，同时传入的 tag 为 HostRoot 保证了 Fiber 的独特性。</li> <li>Fiber 的本质是一个对象。Fiber 上的重要属性大致分为三类：Instance 相关、Fiber 相关、Effects 相关、lanes 相关。instance 相关为 Fiber 对象实例的属性，tag 为 fiber 上节点类型标记。Fiber 相关为 FiberTree 的必要指针；Effects 相关为 render 过程中副作用的标记。lanes 为优先级相关的属性，alternate 则是版本记录的属性。</li> <li>uninitializedFiber 不是完整的 RootFiber，其中只初始化了 Instance 相关 的属性。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>tag 不是 Fiber 的类型，而是 Fiber 上标记的节点的类型。</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>Return value: FiberNode
actualDuration: 0
actualStartTime: -1
alternate: null
child: null
childLanes: 0
dependencies: null
elementType: null
firstEffect: null
flags: 0
index: 0
key: null
lanes: 0
lastEffect: null
memoizedProps: null
memoizedState: null
mode: 8
nextEffect: null
pendingProps: null
ref: null
return: null
selfBaseDuration: 0
sibling: null
stateNode: null
tag: 3
treeBaseDuration: 0
type: null
updateQueue: null
_debugHookTypes: null
_debugID: 1
_debugNeedsRemount: false
_debugOwner: null
_debugSource: null
[[Prototype]]: Object
this: undefined
mode: 8
tag: 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></div> <p>WorkTag 是怎么分类的，Fiber 标记了哪些类型？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactWorkTags.js</span>
<span class="token keyword">export</span> type WorkTag <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token number">0</span>
  <span class="token operator">|</span> <span class="token number">1</span>
  <span class="token operator">|</span> <span class="token number">2</span>
  <span class="token operator">|</span> <span class="token number">3</span>
  <span class="token operator">|</span> <span class="token number">4</span>
  <span class="token operator">|</span> <span class="token number">5</span>
  <span class="token operator">|</span> <span class="token number">6</span>
  <span class="token operator">|</span> <span class="token number">7</span>
  <span class="token operator">|</span> <span class="token number">8</span>
  <span class="token operator">|</span> <span class="token number">9</span>
  <span class="token operator">|</span> <span class="token number">10</span>
  <span class="token operator">|</span> <span class="token number">11</span>
  <span class="token operator">|</span> <span class="token number">12</span>
  <span class="token operator">|</span> <span class="token number">13</span>
  <span class="token operator">|</span> <span class="token number">14</span>
  <span class="token operator">|</span> <span class="token number">15</span>
  <span class="token operator">|</span> <span class="token number">16</span>
  <span class="token operator">|</span> <span class="token number">17</span>
  <span class="token operator">|</span> <span class="token number">18</span>
  <span class="token operator">|</span> <span class="token number">19</span>
  <span class="token operator">|</span> <span class="token number">20</span>
  <span class="token operator">|</span> <span class="token number">21</span>
  <span class="token operator">|</span> <span class="token number">22</span>
  <span class="token operator">|</span> <span class="token number">23</span>
  <span class="token operator">|</span> <span class="token number">24</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 函数组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 类组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Before we know whether it is function or class // 未知类型组件，在未知为函数组件还是类组件时使用</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Root of a host tree. Could be nested inside another node. // HostRoot 是包含 RootFiber 信息的容器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// A subtree. Could be an entry point to a different renderer. // HostPortal 是类型为 Portal 的 HostRoot</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// React.Fragment 类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// context.Consumer 类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//  context.Provider 类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span> <span class="token comment">// React.forwardRef 类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> 
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// suspense 组件类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span> <span class="token comment">// memo 组件类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SimpleMemoComponent <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// 没有 compare 的简单的 memo 组件类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LazyComponent <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// react.lazy 的组件类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IncompleteClassComponent <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DehydratedFragment <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseListComponent <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ScopeComponent <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> OffscreenComponent <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LegacyHiddenComponent <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> CacheComponent <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>FiberNode 中 Fiber 相关的属性构成了怎样的 FiberTree 的关系？</p> <img src="/assets/img/react_fiber_tree.jpeg" alt="react_fiber_tree" data-zoomable=""> <p>我们从这张图可以看出：</p> <ul><li>FiberRoot 和 RootFiber 的双向链接关系。</li> <li>Fiber 中 child 为子节点指针，sibling 为兄弟节点指针，return 为父节点指针，这三个指针共同构成了 FiberTree 的数据结构。注意 sibling 只指向下一个兄弟节点。</li> <li>从整体上看，child 指针和 return 指针决定了深度关系，而 sibling 指针决定了广度关系。return 指针决定了 FiberTree 的可逆性。</li></ul> <div class="custom-block tip"><p class="custom-block-title">Local Stack</p> <p>到目前为止，我们来看一下目前的调用栈：
<img src="/assets/img/call_stack_to_create_fiber.jpeg" alt="call_stack_to_create_fiber" data-zoomable=""></p> <p>过程如下：
render -&gt; legacyRenderSubtreeIntoContainer -&gt; legacyCreateRootFromDOMContainer -&gt; createContainer -&gt; createFiberRoot -&gt; createHostRootFiber -&gt; createFiber -&gt; ...</p></div> <h2 id="flushsync"><a href="#flushsync" class="header-anchor">#</a> flushSync</h2> <p>从上面的过程，已经创建了 HostRoot 和 RootFiber，以及</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>flushSync 函数处理同步渲染，在传入的回调中调用了 updateContainer 函数。</p> <p>下面是 flushSync 函数：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// Overload the definition to the two valid signatures.</span>
<span class="token comment">// Warning, this opts-out of checking the function body.</span>
<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">flushSync</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line no-redeclare</span>
<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line no-redeclare</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushSync</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// In legacy mode, we flush pending passive effects at the beginning of the</span>
  <span class="token comment">// next event, not at the end of the previous one.</span>
  <span class="token comment">// rootWithPendingPassiveEffects 表示当前已经 commit 的 HostRoot</span>
  <span class="token comment">// 如果当前已存在 commit 的 HostRoot，且当前执行阶段不是 RenderContext 或者 CommitContext，则 flush 所有待渲染的副作用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    rootWithPendingPassiveEffects<span class="token punctuation">.</span>tag <span class="token operator">===</span> LegacyRoot <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  <span class="token comment">// executionContext 指向 BatchedContext</span>
  executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span>

  <span class="token keyword">const</span> prevTransition <span class="token operator">=</span> ReactCurrentBatchConfig<span class="token punctuation">.</span>transition<span class="token punctuation">;</span>
  <span class="token keyword">const</span> previousPriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 fn 执行 抛出了错误，则回退至之前的状态</span>
    <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> prevTransition<span class="token punctuation">;</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
    <span class="token comment">// Flush the immediate callbacks that were scheduled during this batch.</span>
    <span class="token comment">// Note that this will happen even if batchedUpdates is higher up</span>
    <span class="token comment">// the stack.</span>
    <span class="token comment">// flush 本次 batch 中高优先级的 callbacks</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><ul><li>flushSync 使用了 ts 的函数重载，如果传入回调，会执行这个回调。</li> <li>从整体来看，flushSync 主要调用了 flushPassiveEffects 函数来处理已经 commit 的 HostRoot 上的待执行的副作用。</li> <li>flushSync 会先对已经 commit 的内容执行 flushPassiveEffects，执行完毕后才进入 BatchedContext 阶段。</li> <li>注意，在首次渲染时 rootWithPendingPassiveEffects 应该为 null，也就是说 flushPassiveEffects 不会被执行到，但是我们仍然来分析下 flushPassiveEffects 会做些什么事情。</li></ul> <h3 id="flushpassiveeffects"><a href="#flushpassiveeffects" class="header-anchor">#</a> flushPassiveEffects</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token comment">// Returns whether passive effects were flushed.</span>
  <span class="token comment">// TODO: Combine this check with the one in flushPassiveEFfectsImpl. We should</span>
  <span class="token comment">// probably just combine the two functions. I believe they were only separate</span>
  <span class="token comment">// in the first place because we used to wrap it with</span>
  <span class="token comment">// `Scheduler.runWithPriority`, which accepts a function. But now we track the</span>
  <span class="token comment">// priority within React itself, so we can mutate the variable directly.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cache the root since rootWithPendingPassiveEffects is cleared in</span>
    <span class="token comment">// flushPassiveEffectsImpl</span>
    <span class="token comment">// 这里缓存 root 是为了在发生错误回滚时即时释放缓存池</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> rootWithPendingPassiveEffects<span class="token punctuation">;</span>
    <span class="token comment">// Cache and clear the remaining lanes flag; it must be reset since this</span>
    <span class="token comment">// method can be called from various places, not always from commitRoot</span>
    <span class="token comment">// where the remaining lanes are known</span>
    <span class="token comment">// 重置 remainingLanes</span>
    <span class="token keyword">const</span> remainingLanes <span class="token operator">=</span> pendingPassiveEffectsRemainingLanes<span class="token punctuation">;</span>
    pendingPassiveEffectsRemainingLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

    <span class="token keyword">const</span> renderPriority <span class="token operator">=</span> <span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>pendingPassiveEffectsLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> priority <span class="token operator">=</span> <span class="token function">lowerEventPriority</span><span class="token punctuation">(</span>DefaultEventPriority<span class="token punctuation">,</span> renderPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevTransition <span class="token operator">=</span> ReactCurrentBatchConfig<span class="token punctuation">.</span>transition<span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousPriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">flushPassiveEffectsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// flushPassiveEffectsImpl 发生错误后回滚只上一状态</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> prevTransition<span class="token punctuation">;</span>

      <span class="token comment">// Once passive effects have run for the tree - giving components a</span>
      <span class="token comment">// chance to retain cache instances they use - release the pooled</span>
      <span class="token comment">// cache at the root (if there is one)</span>
      <span class="token function">releaseRootPooledCache</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>这个函数主要调用 flushPassiveEffectsImpl 函数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">flushPassiveEffectsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> root <span class="token operator">=</span> rootWithPendingPassiveEffects<span class="token punctuation">;</span>
  <span class="token keyword">const</span> lanes <span class="token operator">=</span> pendingPassiveEffectsLanes<span class="token punctuation">;</span>
  <span class="token comment">// 由于这里的 PassiveEffects 将会被 flush，这里将之清空</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: This is sometimes out of sync with rootWithPendingPassiveEffects.</span>
  <span class="token comment">// Figure out why and fix it. It's not causing any known issues (probably</span>
  <span class="token comment">// because it's only used for profiling), but it's a refactor hazard.</span>
  pendingPassiveEffectsLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">// Render 阶段和 Commit 阶段是不能 flush 的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Cannot flush passive effects while already rendering.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  <span class="token comment">// 将 executionContext 更新为 CommitContext，因为现在进入了 Commit 阶段</span>
  executionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>

  <span class="token comment">// 这里将 passiveEffects 分成了 Mount 和 Unmount 阶段，这两类都需要 commit，但是处理的逻辑不同</span>
  <span class="token function">commitPassiveUnmountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitPassiveMountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> root<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>

  <span class="token comment">// 所有的同步的 callback 都需要 flush</span>
  <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If additional passive effects were scheduled, increment a counter. If this</span>
  <span class="token comment">// exceeds the limit, we'll fire a warning.</span>
  <span class="token comment">// nestedPassiveUpdateCount 计数器递增，防止造成死循环</span>
  nestedPassiveUpdateCount <span class="token operator">=</span>
    rootWithPendingPassiveEffects <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> nestedPassiveUpdateCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li>flush effects 的目的是 commit effects。</li></ul> <h3 id="flushsynccallbacks"><a href="#flushsynccallbacks" class="header-anchor">#</a> flushSyncCallbacks</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberSyncTaskQueue.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// isFlushingSyncQueue 是 syncQueue 的互斥锁 </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushingSyncQueue <span class="token operator">&amp;&amp;</span> syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent re-entrance.</span>
    isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousUpdatePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> queue <span class="token operator">=</span> syncQueue<span class="token punctuation">;</span>
      <span class="token comment">// TODO: Is this necessary anymore? The only user code that runs in this</span>
      <span class="token comment">// queue is in the render or commit phases.</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// flush syncQueue，每个 callback 可以返回一个新的 callback</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> callback <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
          callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>isSync<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 重置 syncQueue</span>
      syncQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      includesLegacySyncCallbacks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If something throws, leave the remaining callbacks on the queue.</span>
      <span class="token comment">// 如果syncQueue 中每个 RootCallback 发生了错误，则跳过此项</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        syncQueue <span class="token operator">=</span> syncQueue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Resume flushing in the next tick</span>
      <span class="token comment">// 调度在下一个 tick 中继续执行</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediatePriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousUpdatePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isFlushingSyncQueue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>可以看到，flushSyncCallbacks 主要是在执行完 syncQueue 中的所有的回调，syncQueue 中的 callback 可以返回一个新的 callback，这种结构类似于数组 + 链表和结构，很是巧妙。这段代码中 syncQueue 的数据结构、flush syncQueue 的处理方式和错误处理方式，值得我们借鉴。这种消费 effect 的方式和 react 中响应式 effect 的消费很像。</p> <ul><li>因为 syncQueue 是公共资源，而 flushSyncCallbacks 是其消费者，因此消费者在消费 syncQueue 时需要添加互斥锁，以免造成资源争夺。</li> <li>出现错误时并不是直接继续执行，而是放到了 next tick 中继续消费，提高了 syncQueue 消费的效率。</li></ul> <h2 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h2> <p>updateContainer 是首次渲染中重要工作中的一项。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  element<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  container<span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">Function</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// 获取 RootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新 container 的 context 信息</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建一个更新</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Caution: React DevTools currently depends on this property</span>
  <span class="token comment">// being called &quot;element&quot;.</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>

  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将新建的更新入栈</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 请求一次调度更新</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">entangleTransitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>updateContainer 函数中主要是针对 RootFiber 创建了一次更新，加入到更新队列，并且请求调度器进行调度。调度更新部分，请参照 <a href="/react/reconciliation/scheduleWork.html">scheduleWork 与调度过程
</a>。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>通过上面的分析过程可知，React 的首次渲染的流程如下：首先执行一系列的初始化工作，包括创建 HostRoot 和 FiberRoot 以及建立两者之间的关联、初始化事件委托系统，然后创建一个同步的更新并向调度器提交调度请求。</p> <h2 id="q-a"><a href="#q-a" class="header-anchor">#</a> Q&amp;A</h2> <h3 id="executioncontext-有哪几种"><a href="#executioncontext-有哪几种" class="header-anchor">#</a> executionContext 有哪几种？</h3> <p>executionContext 表示 React 当前执行的上下文阶段，通过 executionContext 我们可以大致分出其总体渲染流程的不同阶段。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoContext <span class="token operator">=</span> <span class="token comment">/*             */</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> BatchedContext <span class="token operator">=</span> <span class="token comment">/*               */</span> <span class="token number">0b0001</span><span class="token punctuation">;</span> <span class="token comment">// Batch(批处理)阶段</span>
<span class="token keyword">const</span> RenderContext <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0010</span><span class="token punctuation">;</span> <span class="token comment">// Render(渲染)阶段</span>
<span class="token keyword">const</span> CommitContext <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0100</span><span class="token punctuation">;</span> <span class="token comment">// Commit(提交)阶段</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> RetryAfterError <span class="token operator">=</span> <span class="token comment">/*       */</span> <span class="token number">0b1000</span><span class="token punctuation">;</span> <span class="token comment">// 错误重试阶段</span>

<span class="token comment">// Describes where we are in the React execution stack</span>
<span class="token keyword">let</span> executionContext<span class="token operator">:</span> ExecutionContext <span class="token operator">=</span> NoContext<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>全局变量 executionContext 代表当前的执行上下文，初始化为 NoContent。下面是这四个阶段的对照表格:</p> <table><thead><tr><th>context</th> <th>所在函数</th> <th>阶段</th> <th>备注</th></tr></thead> <tbody><tr><td>NoContext</td> <td></td> <td>初始化</td> <td>初始阶段</td></tr> <tr><td>BatchedContext</td> <td>flushSync、batchedUpdates、flushControlled</td> <td>Batch (批处理) 阶段</td> <td>RenderSubtreeIntoContainer 之后，renderRoot 之前</td></tr> <tr><td>RenderContext</td> <td>renderRootSync、renderRootConcurrent</td> <td>Render (渲染) 阶段</td> <td>renderRoot 之后，commitRoot 之前</td></tr> <tr><td>CommitContext</td> <td>commitRootImpl、flushPassiveEffectsImpl</td> <td>Commit (提交) 阶段</td> <td>commitRoot 之后</td></tr> <tr><td>RetryAfterError</td> <td>recoverFromConcurrentError</td> <td>Error 阶段</td> <td>发生错误需要恢复之后</td></tr></tbody></table> <p>从表格可以总结出，React 的渲染总共分为 NoContext、BatchedContext、RenderContext、CommitContext、RetryAfterError 五个阶段。关于更新阶段的更多内容，请移步 <a href="/react/update/">React 更新周期</a>。</p> <h3 id="使用位运算提高枚举计算效率"><a href="#使用位运算提高枚举计算效率" class="header-anchor">#</a> 使用位运算提高枚举计算效率</h3> <p>React 中多处使用位运算进行枚举计算，使用位运算可以有效提交运行效率，尤其是大型的状态繁多的项目。在 react 源码中有很多类似的位运算，比如 effectTag，workTag 和上文中的 executionContext。</p> <p>下面我们来看看 React 中位运算枚举风格：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> NoContext <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> BatchedContext <span class="token operator">=</span>  <span class="token number">0b0001</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> RenderContext <span class="token operator">=</span>  <span class="token number">0b0010</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> CommitContext <span class="token operator">=</span>  <span class="token number">0b0100</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> RetryAfterError <span class="token operator">=</span> <span class="token number">0b1000</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> executionContext <span class="token operator">=</span> NoContext<span class="token punctuation">;</span>

<span class="token comment">// 如果现在开始 RenderContainer，进入 Batch 阶段</span>
<span class="token comment">// 增加枚举值</span>
executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token comment">// 判断是否在 Batch 阶段</span>
<span class="token comment">// 消费枚举值：0 表示没有枚举值，1 表示有枚举值。这里我们直接跟为 0 的 NoContext 作比较。</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> BatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token comment">// 判断是否处于 Render 阶段</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// false</span>
<span class="token comment">// 现在开始 RenderRoot，进入 Render 阶段</span>
executionContext <span class="token operator">|=</span> RenderContext<span class="token punctuation">;</span>
<span class="token comment">// 判断是否处于 Batch 阶段或者 Render 阶段</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BatchedContext <span class="token operator">|</span> RenderContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token comment">// 判断是否不处于 Commit 阶段或者 Error 阶段</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CommitContext <span class="token operator">|</span> RetryAfterError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>下面我们再来对比一些 Vue 源码中使用位运算的风格。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">{</span>
  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">FUNCTIONAL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token constant">SLOTS_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token constant">TELEPORT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token constant">SUSPENSE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT_SHOULD_KEEP_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT_KEPT_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT</span> <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>写法不一样，使用的方法是一样的。</p> <p>这种原理是什么？这是因为这些枚举数字是互相正交的（可以从数学上垂直的概念来理解），也可以从二进制为进行理解，没加入一个枚举值，在相应的下标出置为 1（按位或运算），判断是否有这个枚举值的时候，就可以那要判断的值与枚举值对齐比对（按位与运算）。</p> <p>位运算的更多技巧请参考文章：<a href="/react/summary/bitOperation">位运算初探</a></p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://zhuanlan.zhihu.com/p/32520194" target="_blank" rel="noopener noreferrer">深入理解 React 源码 - 首次渲染<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/60307571" target="_blank" rel="noopener noreferrer">深入剖析 React Concurrent<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://segmentfault.com/a/1190000020532672" target="_blank" rel="noopener noreferrer">React 的第一次渲染过程浅析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-front-end/edit/master/docs/10.react/80.总结/20.first-render.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/15, 00:23:56</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/react/summary/bitOperation/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">位运算初探</div></a> <a href="/react/summary/event-listener/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">React 中的事件监听机制</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react/summary/bitOperation/" class="prev">位运算初探</a></span> <span class="next"><a href="/react/summary/event-listener/">React 中的事件监听机制</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/solid/render/render-by-jsx/"><div>
            渲染原理之组件结构与 JSX 编译
            <!----></div></a> <span class="date">09-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/solid/plan/"><div>
            计划跟踪
            <!----></div></a> <span class="date">09-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/solid/index/"><div>
            开始上手
            <!----></div></a> <span class="date">09-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://ml.jonsam.site" title="机器学习" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy Front End | Made by <a href="https://www.jonsam.site" target="_blank">Jonsam</a> by ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.eb21b6ee.js" defer></script><script src="/assets/js/2.01e091c2.js" defer></script><script src="/assets/js/43.2cfdc8d9.js" defer></script><script src="/assets/js/4.54e60667.js" defer></script><script src="/assets/js/12.71337abb.js" defer></script><script src="/assets/js/10.ac472f43.js" defer></script><script src="/assets/js/11.c50183f9.js" defer></script><script src="/assets/js/8.7cbef5ec.js" defer></script><script src="/assets/js/5.f620477b.js" defer></script>
  </body>
</html>
