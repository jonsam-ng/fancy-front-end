<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码漂流记：React 调和器核心源码解读（一） | Fancy Front End</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <meta name="description" content="前端源码阅读栈，精读 React、Vue3 源码">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="前端源码,React源码,Vue源码,Vu3源码,Webpack源码">
    <meta name="theme-color" content="#3CB982">
    
    <link rel="preload" href="/assets/css/0.styles.e2349a00.css" as="style"><link rel="preload" href="/assets/js/app.eb21b6ee.js" as="script"><link rel="preload" href="/assets/js/2.01e091c2.js" as="script"><link rel="preload" href="/assets/js/62.d83f3691.js" as="script"><link rel="preload" href="/assets/js/4.54e60667.js" as="script"><link rel="preload" href="/assets/js/12.71337abb.js" as="script"><link rel="preload" href="/assets/js/10.ac472f43.js" as="script"><link rel="preload" href="/assets/js/11.c50183f9.js" as="script"><link rel="preload" href="/assets/js/8.7cbef5ec.js" as="script"><link rel="preload" href="/assets/js/5.f620477b.js" as="script"><link rel="prefetch" href="/assets/js/100.8081075e.js"><link rel="prefetch" href="/assets/js/101.943ea683.js"><link rel="prefetch" href="/assets/js/102.11c8554c.js"><link rel="prefetch" href="/assets/js/103.c2780521.js"><link rel="prefetch" href="/assets/js/104.81994794.js"><link rel="prefetch" href="/assets/js/105.f987244b.js"><link rel="prefetch" href="/assets/js/106.235a578e.js"><link rel="prefetch" href="/assets/js/107.94cdbb18.js"><link rel="prefetch" href="/assets/js/108.3a80cb29.js"><link rel="prefetch" href="/assets/js/109.8884be03.js"><link rel="prefetch" href="/assets/js/110.89ab5eb2.js"><link rel="prefetch" href="/assets/js/111.355b1782.js"><link rel="prefetch" href="/assets/js/112.34671c87.js"><link rel="prefetch" href="/assets/js/113.0cca0902.js"><link rel="prefetch" href="/assets/js/114.01616168.js"><link rel="prefetch" href="/assets/js/115.4915c0b5.js"><link rel="prefetch" href="/assets/js/116.ef93855a.js"><link rel="prefetch" href="/assets/js/117.e3526ed0.js"><link rel="prefetch" href="/assets/js/118.7d52a4ea.js"><link rel="prefetch" href="/assets/js/119.a4bb17bb.js"><link rel="prefetch" href="/assets/js/120.135aa6ea.js"><link rel="prefetch" href="/assets/js/121.86c35c15.js"><link rel="prefetch" href="/assets/js/122.1452986d.js"><link rel="prefetch" href="/assets/js/123.0181b553.js"><link rel="prefetch" href="/assets/js/124.edc508f8.js"><link rel="prefetch" href="/assets/js/125.46d932c1.js"><link rel="prefetch" href="/assets/js/126.17e05a12.js"><link rel="prefetch" href="/assets/js/127.98159dfe.js"><link rel="prefetch" href="/assets/js/128.9aaa5bc6.js"><link rel="prefetch" href="/assets/js/129.26bed928.js"><link rel="prefetch" href="/assets/js/13.292db5f6.js"><link rel="prefetch" href="/assets/js/130.9f74c846.js"><link rel="prefetch" href="/assets/js/131.d6ef0885.js"><link rel="prefetch" href="/assets/js/132.1d9ee075.js"><link rel="prefetch" href="/assets/js/133.2b23ed7b.js"><link rel="prefetch" href="/assets/js/134.c47e8a23.js"><link rel="prefetch" href="/assets/js/135.2aeb3426.js"><link rel="prefetch" href="/assets/js/136.0169c47b.js"><link rel="prefetch" href="/assets/js/137.70cdfc24.js"><link rel="prefetch" href="/assets/js/138.e54160ee.js"><link rel="prefetch" href="/assets/js/139.9a6d1932.js"><link rel="prefetch" href="/assets/js/14.54d2636a.js"><link rel="prefetch" href="/assets/js/140.ddabaeca.js"><link rel="prefetch" href="/assets/js/141.35844ecc.js"><link rel="prefetch" href="/assets/js/142.4ccdb5e4.js"><link rel="prefetch" href="/assets/js/143.37a7f36e.js"><link rel="prefetch" href="/assets/js/144.95ff6a63.js"><link rel="prefetch" href="/assets/js/145.9899e545.js"><link rel="prefetch" href="/assets/js/146.6865658b.js"><link rel="prefetch" href="/assets/js/147.2a55d18a.js"><link rel="prefetch" href="/assets/js/148.f3aab640.js"><link rel="prefetch" href="/assets/js/149.57b565a0.js"><link rel="prefetch" href="/assets/js/15.81d908ff.js"><link rel="prefetch" href="/assets/js/150.3f7143ae.js"><link rel="prefetch" href="/assets/js/151.5981cf9e.js"><link rel="prefetch" href="/assets/js/152.a3428a7b.js"><link rel="prefetch" href="/assets/js/153.0f0b339d.js"><link rel="prefetch" href="/assets/js/154.39f3b522.js"><link rel="prefetch" href="/assets/js/155.13c8170a.js"><link rel="prefetch" href="/assets/js/156.ccb66614.js"><link rel="prefetch" href="/assets/js/157.4b8bce50.js"><link rel="prefetch" href="/assets/js/158.6476dd1c.js"><link rel="prefetch" href="/assets/js/159.b261a009.js"><link rel="prefetch" href="/assets/js/16.68d8e787.js"><link rel="prefetch" href="/assets/js/160.e501007d.js"><link rel="prefetch" href="/assets/js/161.d3f56d3d.js"><link rel="prefetch" href="/assets/js/162.f8590797.js"><link rel="prefetch" href="/assets/js/163.91fe4509.js"><link rel="prefetch" href="/assets/js/164.6e92f3f4.js"><link rel="prefetch" href="/assets/js/165.56868a39.js"><link rel="prefetch" href="/assets/js/166.83812a3b.js"><link rel="prefetch" href="/assets/js/167.4b528df4.js"><link rel="prefetch" href="/assets/js/168.f2b151fb.js"><link rel="prefetch" href="/assets/js/169.cb2ee128.js"><link rel="prefetch" href="/assets/js/17.895175dc.js"><link rel="prefetch" href="/assets/js/170.63b574e9.js"><link rel="prefetch" href="/assets/js/171.ad38a311.js"><link rel="prefetch" href="/assets/js/172.b592b97e.js"><link rel="prefetch" href="/assets/js/173.302ef08b.js"><link rel="prefetch" href="/assets/js/174.d71ad1a3.js"><link rel="prefetch" href="/assets/js/175.2617c860.js"><link rel="prefetch" href="/assets/js/176.19a67035.js"><link rel="prefetch" href="/assets/js/177.75aab37d.js"><link rel="prefetch" href="/assets/js/178.b2773712.js"><link rel="prefetch" href="/assets/js/179.6a34b45f.js"><link rel="prefetch" href="/assets/js/18.736b781d.js"><link rel="prefetch" href="/assets/js/180.d447fc48.js"><link rel="prefetch" href="/assets/js/181.d6b96886.js"><link rel="prefetch" href="/assets/js/182.42c2bcd5.js"><link rel="prefetch" href="/assets/js/183.a6256a82.js"><link rel="prefetch" href="/assets/js/184.8a036f5a.js"><link rel="prefetch" href="/assets/js/185.811d5831.js"><link rel="prefetch" href="/assets/js/186.6436a583.js"><link rel="prefetch" href="/assets/js/187.4bcf94a3.js"><link rel="prefetch" href="/assets/js/188.33f39bd6.js"><link rel="prefetch" href="/assets/js/189.c1b90840.js"><link rel="prefetch" href="/assets/js/19.504bd141.js"><link rel="prefetch" href="/assets/js/20.e526fb51.js"><link rel="prefetch" href="/assets/js/21.8375d39e.js"><link rel="prefetch" href="/assets/js/22.0e15b626.js"><link rel="prefetch" href="/assets/js/23.83bcc15c.js"><link rel="prefetch" href="/assets/js/24.3df554ce.js"><link rel="prefetch" href="/assets/js/25.6c56da2b.js"><link rel="prefetch" href="/assets/js/26.76154857.js"><link rel="prefetch" href="/assets/js/27.155dbcb4.js"><link rel="prefetch" href="/assets/js/28.7178e96c.js"><link rel="prefetch" href="/assets/js/29.f7337396.js"><link rel="prefetch" href="/assets/js/3.50570587.js"><link rel="prefetch" href="/assets/js/30.191545d3.js"><link rel="prefetch" href="/assets/js/31.b6a0fe90.js"><link rel="prefetch" href="/assets/js/32.18cebeab.js"><link rel="prefetch" href="/assets/js/33.146782c3.js"><link rel="prefetch" href="/assets/js/34.c08af9cb.js"><link rel="prefetch" href="/assets/js/35.ea730de0.js"><link rel="prefetch" href="/assets/js/36.11aba0b0.js"><link rel="prefetch" href="/assets/js/37.0fd8e20a.js"><link rel="prefetch" href="/assets/js/38.2cde6902.js"><link rel="prefetch" href="/assets/js/39.07c230cc.js"><link rel="prefetch" href="/assets/js/40.e4fcccd0.js"><link rel="prefetch" href="/assets/js/41.5f96c201.js"><link rel="prefetch" href="/assets/js/42.e5023440.js"><link rel="prefetch" href="/assets/js/43.2cfdc8d9.js"><link rel="prefetch" href="/assets/js/44.37f32c52.js"><link rel="prefetch" href="/assets/js/45.3973ea4b.js"><link rel="prefetch" href="/assets/js/46.87541312.js"><link rel="prefetch" href="/assets/js/47.04f0011f.js"><link rel="prefetch" href="/assets/js/48.1151f311.js"><link rel="prefetch" href="/assets/js/49.6830fb0c.js"><link rel="prefetch" href="/assets/js/50.84b34574.js"><link rel="prefetch" href="/assets/js/51.840f38c4.js"><link rel="prefetch" href="/assets/js/52.3dbda6e7.js"><link rel="prefetch" href="/assets/js/53.7f0a8896.js"><link rel="prefetch" href="/assets/js/54.5d7f6427.js"><link rel="prefetch" href="/assets/js/55.86c7b544.js"><link rel="prefetch" href="/assets/js/56.49a27b9a.js"><link rel="prefetch" href="/assets/js/57.287f9e58.js"><link rel="prefetch" href="/assets/js/58.40a49fdb.js"><link rel="prefetch" href="/assets/js/59.91487422.js"><link rel="prefetch" href="/assets/js/6.8880bb8c.js"><link rel="prefetch" href="/assets/js/60.8dfd58ee.js"><link rel="prefetch" href="/assets/js/61.7b4874b9.js"><link rel="prefetch" href="/assets/js/63.1237a900.js"><link rel="prefetch" href="/assets/js/64.1f096a25.js"><link rel="prefetch" href="/assets/js/65.809d988d.js"><link rel="prefetch" href="/assets/js/66.43c1e5f9.js"><link rel="prefetch" href="/assets/js/67.24ab137d.js"><link rel="prefetch" href="/assets/js/68.7b0346b5.js"><link rel="prefetch" href="/assets/js/69.2008c989.js"><link rel="prefetch" href="/assets/js/7.0c293177.js"><link rel="prefetch" href="/assets/js/70.e8cf3232.js"><link rel="prefetch" href="/assets/js/71.d661943d.js"><link rel="prefetch" href="/assets/js/72.e67a47a3.js"><link rel="prefetch" href="/assets/js/73.87f1db52.js"><link rel="prefetch" href="/assets/js/74.ac67cd0d.js"><link rel="prefetch" href="/assets/js/75.e25ebf69.js"><link rel="prefetch" href="/assets/js/76.a7222468.js"><link rel="prefetch" href="/assets/js/77.ffb71305.js"><link rel="prefetch" href="/assets/js/78.72c00bee.js"><link rel="prefetch" href="/assets/js/79.66ec368e.js"><link rel="prefetch" href="/assets/js/80.8792d3d7.js"><link rel="prefetch" href="/assets/js/81.49d3731a.js"><link rel="prefetch" href="/assets/js/82.fbe09e61.js"><link rel="prefetch" href="/assets/js/83.220a02bb.js"><link rel="prefetch" href="/assets/js/84.4b722410.js"><link rel="prefetch" href="/assets/js/85.f83d2db9.js"><link rel="prefetch" href="/assets/js/86.17b19d53.js"><link rel="prefetch" href="/assets/js/87.37568307.js"><link rel="prefetch" href="/assets/js/88.d7cc6612.js"><link rel="prefetch" href="/assets/js/89.ffb378d0.js"><link rel="prefetch" href="/assets/js/9.2a7e5bdc.js"><link rel="prefetch" href="/assets/js/90.02c91127.js"><link rel="prefetch" href="/assets/js/91.c22d9224.js"><link rel="prefetch" href="/assets/js/92.c79d457a.js"><link rel="prefetch" href="/assets/js/93.33a03732.js"><link rel="prefetch" href="/assets/js/94.c73ddbbc.js"><link rel="prefetch" href="/assets/js/95.a5151497.js"><link rel="prefetch" href="/assets/js/96.b8f204d2.js"><link rel="prefetch" href="/assets/js/97.d7ddaa6f.js"><link rel="prefetch" href="/assets/js/98.49dbda5e.js"><link rel="prefetch" href="/assets/js/99.d14f43ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2349a00.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Fancy Front End" class="logo"> <span class="site-name can-hide">Fancy Front End</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/react/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/plan/" class="sidebar-link">plan 计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调和（Reconciliation）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调度器（Scheduler）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新器（Updater）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>渲染器（Render）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hooks原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React源码漂流记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/tour/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/tour/plan/" class="sidebar-link">Plan 计划</a></li><li><a href="/react/tour/talk/" class="sidebar-link">前言</a></li><li><a href="/react/tour/react-basic-element/" class="sidebar-link">React 源码漂流记：ReactElement 与基础概念</a></li><li><a href="/react/tour/react-basic-children/" class="sidebar-link">React 源码漂流记：ReactChildren 与节点操纵</a></li><li><a href="/react/tour/react-basic-glimpse/" class="sidebar-link">React 源码漂流记：React 整体结构和理念初认识</a></li><li><a href="/react/tour/react-reconciliation-1/" aria-current="page" class="active sidebar-link">React 源码漂流记：React 调和器核心源码解读（一）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#updatecontainer-星星之火-可以燎原" class="sidebar-link">updateContainer：星星之火，可以燎原</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#scheduleupdateonfiber-剥丝抽茧-追本溯源" class="sidebar-link">scheduleUpdateOnFiber：剥丝抽茧，追本溯源</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#ensurerootisscheduled-一花开两叶-结果自然成" class="sidebar-link">ensureRootIsScheduled：一花开两叶，结果自然成</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#扩展" class="sidebar-link">扩展</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-1/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/react/tour/react-reconciliation-2/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（二）</a></li><li><a href="/react/tour/react-reconciliation-3/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（三）</a></li><li><a href="/react/tour/react-reconciliation-4/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（四）</a></li><li><a href="/react/tour/react-reconciliation-5/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（五）</a></li><li><a href="/react/tour/react-reconciliation-6/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（六）</a></li><li><a href="/react/tour/react-reconciliation-7/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（七）</a></li><li><a href="/react/tour/react-reconciliation-8/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（八）</a></li><li><a href="/react/tour/react-reconciliation-9/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（九）</a></li><li><a href="/react/tour/react-reconciliation-10/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（十）</a></li><li><a href="/react/tour/react-scheduler-1/" class="sidebar-link">React 源码漂流记：React 调度器核心源码解读（一）</a></li><li><a href="/react/tour/dr-1/" class="sidebar-link">带着原理重读 React 官方文档（一）</a></li><li><a href="/react/tour/dr-2/" class="sidebar-link">带着原理重读 React 官方文档（二）</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-e1efabd0><div class="articleInfo" data-v-e1efabd0><ul class="breadcrumbs" data-v-e1efabd0><li data-v-e1efabd0><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-e1efabd0></a></li> <li data-v-e1efabd0><a href="/categories/?category=react" title="分类" data-v-e1efabd0>react</a></li><li data-v-e1efabd0><a href="/categories/?category=React%E6%BA%90%E7%A0%81%E6%BC%82%E6%B5%81%E8%AE%B0" title="分类" data-v-e1efabd0>React源码漂流记</a></li></ul> <div class="info" data-v-e1efabd0><div title="作者" class="author iconfont icon-touxiang" data-v-e1efabd0><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-e1efabd0>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-e1efabd0><a href="javascript:;" data-v-e1efabd0>2022-04-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">React 源码漂流记：React 调和器核心源码解读（一）<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>React17</span><span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>精简</span></div> <!----> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <p></p><div class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#前言">前言</a></li><li><a href="#updatecontainer-星星之火-可以燎原">updateContainer：星星之火，可以燎原</a></li><li><a href="#scheduleupdateonfiber-剥丝抽茧-追本溯源">scheduleUpdateOnFiber：剥丝抽茧，追本溯源</a></li><li><a href="#ensurerootisscheduled-一花开两叶-结果自然成">ensureRootIsScheduled：一花开两叶，结果自然成</a></li><li><a href="#扩展">扩展</a><ul><li><a href="#怎么理解-updatecontainer-是-引擎-这件事">怎么理解 updateContainer 是“引擎“这件事？</a></li><li><a href="#schedulemicrotask-与-queuemicrotask">scheduleMicrotask 与 queueMicrotask</a></li></ul></li><li><a href="#问题">问题</a><ul><li><a href="#位运算怎么理解">位运算怎么理解？</a></li><li><a href="#lanes-优先级怎么理解">lanes 优先级怎么理解？</a></li><li><a href="#fiberroot-和-rootfiber-什么关系">FiberRoot 和 RootFiber 什么关系？</a></li></ul></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <h2 id="updatecontainer-星星之火-可以燎原"><a href="#updatecontainer-星星之火-可以燎原" class="header-anchor">#</a> updateContainer：星星之火，可以燎原</h2> <blockquote><p>updateContainer 是燎原的第一颗火星。</p></blockquote> <p>先看一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberReconciler.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  <span class="token comment">// 待挂载的组件</span>
  <span class="token literal-property property">element</span><span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token comment">// 挂载容器</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// 获取 RootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 更新 container 的 context 信息</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建一个更新</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将新建的更新入栈</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 请求一次调度更新</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>如果你调试过 React 的首次更新过程，你会知道 React 会走到这里。如果你往前追溯 updateContainer 的调用链条，你会发现这些调度都来自于应用层 API。首次渲染是一次同步渲染，通过 updateContainer 这个函数，创建第一个 update 对象，将首个 update 对象入队列，发起首次调度。可以说，这里是 React 引擎的点火器。</p> <p>总结一下 updateContainer 核心功能：</p> <ul><li>初始化创建一个更新对象，并且将更新加入更新队列。</li> <li>调用 scheduleUpdateOnFiber，(向调度器) 发出一次调度的请求。【注：向调度器有些不妥，因为同步任务一般不会经过调度器，这里暂且这么表述，便于理解】</li></ul> <h2 id="scheduleupdateonfiber-剥丝抽茧-追本溯源"><a href="#scheduleupdateonfiber-剥丝抽茧-追本溯源" class="header-anchor">#</a> scheduleUpdateOnFiber：剥丝抽茧，追本溯源</h2> <blockquote><p>scheduleUpdateOnFiber 从 FiberTree 的枝繁叶茂中找到了当初的那枚种子。</p></blockquote> <p>在 updateContainer 中，调用了 scheduleUpdateOnFiber 以在 fiber（此处指的是 RootFiber） 上调度一次更新，那么调度更新是如何在 fiber 上展开的呢？</p> <p>首先来分析一下代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>
<span class="token keyword">let</span> <span class="token literal-property property">workInProgressRootRenderPhaseUpdatedLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">a</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane</span><span class="token punctuation">)</span><span class="token operator">:</span> Lanes <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">|</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token comment">//  RootFiber</span>
  <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// 调度优先级</span>
  <span class="token literal-property property">lane</span><span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  <span class="token literal-property property">eventTime</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查嵌套更新，防止死循环</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 fiber 向上收集 lanes，root：FiberRoot = fiber.stateNode。对于 updateContainer 来说，这里 fiber 就是 RootFiber。</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 标记 root 即将更新，root.pendingLanes |= lane</span>
  <span class="token function">markRootUpdated</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果当前已经是 Render 阶段，且 root 是待处理的 FiberRoot，这时跳过渲染的调度请求，并且追踪 lane，加入到 Render 阶段的 lanes，就在在当前调度的回调中参与渲染，或者等待下次渲染。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes <span class="token operator">&amp;&amp;</span>
    root <span class="token operator">===</span> workInProgressRoot
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 收集当前的 lane 到 workInProgressRootRenderPhaseUpdatedLanes，表示在当前 render 中当前正在渲染的 RootFiber 上的优先级队列。</span>
    workInProgressRootRenderPhaseUpdatedLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
      workInProgressRootRenderPhaseUpdatedLanes<span class="token punctuation">,</span>
      lane<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 确保 FiberRoot 发起调度请求</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>关注入参的伙伴可能已经发现，这里传入的是 fiber，返回的和传递给 ensureRootIsScheduled 函数的却是 root。root 是 FiberRoot，并不是 Fiber。可以把 FiberRoot 理解为 FiberTree 的容器。FiberRoot 与 RootFiber 双向索引。之后会详细展开。</p> <p>markUpdateLaneFromFiberToRoot 向上收集优先级的同时寻找到了 FiberRoot 容器，因为渲染任务的调度是依托于容器的，而非 RootFiber。这个过程更像是一个抽丝剥茧的过程，root 才是被调度的目标。</p> <p>这个函数的核心功能如下：</p> <ul><li>从 fiber 向父级收集 lanes，并且计算出 FiberRoot。</li> <li>调用 ensureRootIsScheduled，确保 FiberRoot 发起同步或者异步调度。</li></ul> <h2 id="ensurerootisscheduled-一花开两叶-结果自然成"><a href="#ensurerootisscheduled-一花开两叶-结果自然成" class="header-anchor">#</a> ensureRootIsScheduled：一花开两叶，结果自然成</h2> <blockquote><p>ensureRootIsScheduled 是封装调度任务的双线流水车间。</p></blockquote> <p>在上面对 scheduleUpdateOnFiber 的分析中，最重要的就是调用 ensureRootIsScheduled，以保证在 fiber 所在的 FiberRoot 上调度更新，那么 FiberRoot 上是如何继续调度的呢？继续来看代码。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberWorkLoop.new.js</span>
<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> <span class="token literal-property property">currentTime</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在本次调度之前的当前的记录的回调节点</span>
  <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>

  <span class="token comment">// 计算将要渲染的 lanes</span>
  <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 无需要渲染的 lanes，直接重置退出</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取 lanes 中优先级最高的 lane 作为本次调度的优先级</span>
  <span class="token keyword">const</span> newCallbackPriority <span class="token operator">=</span> <span class="token function">getHighestPriorityLane</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 由于即将要生成新的调度，先将现在的调度节点上的回调取消掉</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置一个新的回调节点</span>
  <span class="token keyword">let</span> newCallbackNode<span class="token punctuation">;</span>
  <span class="token comment">// 如果是同步更新任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackPriority <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 请求同步调度回调 performSyncWorkOnRoot，将该回调加入同步回调队列</span>
      <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsMicrotasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 支持微任务的浏览器不用再请求调度器的回调</span>
     <span class="token function">scheduleMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 消费完同步回调队列</span>
         <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不支持微任务则向调度器请求回调，优先级 ImmediatePriority（立即回调），回调后执行 flushSyncCallbacks 将同步回调队列消费完</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>ImmediateSchedulerPriority<span class="token punctuation">,</span> flushSyncCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 同步更新执行完毕，将 newCallbackNode 置为 null，performSyncWorkOnRoot 不会用到此值</span>
    newCallbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> schedulerPriorityLevel<span class="token punctuation">;</span>
    <span class="token comment">// 将 lanes 转化为事件优先级，然后将事件优先级转化为调度优先级</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 离散事件优先级：ImmediateSchedulerPriority</span>
      <span class="token keyword">case</span> <span class="token literal-property property">DiscreteEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> ImmediateSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// 连续事件优先级：UserBlockingSchedulerPriority</span>
      <span class="token keyword">case</span> <span class="token literal-property property">ContinuousEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> UserBlockingSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// 默认事件优先级：NormalSchedulerPriority</span>
      <span class="token keyword">case</span> <span class="token literal-property property">DefaultEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// Idle 事件优先级：IdleSchedulerPriority</span>
      <span class="token keyword">case</span> <span class="token literal-property property">IdleEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> IdleSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalSchedulerPriority<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 向调度器请求相应优先级的异步回调【也可能是立即执行的优先级】，回调后执行 performConcurrentWorkOnRoot，Scheduler.scheduleCallback 返回调度的 callbackNode(newTask)</span>
    newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>
      schedulerPriorityLevel<span class="token punctuation">,</span>
      <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新 callbackPriority 和 callbackNode 注意，此时只是发起调度，回调并未执行</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> newCallbackNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>ensureRootIsScheduled 将 FiberRoot 上的调度任务区分为同步任务和异步任务。</p> <p>这个函数有以下几个核心作用：</p> <ul><li>更新 root 的 callbackNode、callbackPriority 属性。下次 ensureRootIsScheduled 被调用会使用到。</li> <li>同步更新调度：调用 scheduleSyncCallback 将同步回调 performSyncWorkOnRoot 推入同步回调队列 syncQueue；支持微任务的直接在微任务的回调执行 flushSyncCallbacks；不支持微任务时以 ImmediateSchedulerPriority 的优先级向调度器请求同步回调，回调时执行 flushSyncCallbacks 消费同步队列中所有的同步回调。</li> <li>异步更新调度：根据 nextLanes 计算事件优先级，并且转化为调度优先级，以相应的调度优先级向调度器发起异步回调，回调时执行 performConcurrentWorkOnRoot。</li> <li>注意同步调度中调用了 scheduleSyncCallback、scheduleCallback 两个函数不可混淆，scheduleCallback 是 Scheduler 提供的一种基于优先级机制的任务（回调）调度手段，performSyncWorkOnRoot 和 performConcurrentWorkOnRoot 才是真正要通过调度执行的任务。同步的任务通过同步回调队列的方式进行了优化处理。scheduleSyncCallback 是将同步的任务加入同步任务队列。调度器不是不可缺少的，如果浏览器支持微任务，同步任务的处理就可以交给微任务处理，而不经过调度器。</li></ul> <h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <h3 id="怎么理解-updatecontainer-是-引擎-这件事"><a href="#怎么理解-updatecontainer-是-引擎-这件事" class="header-anchor">#</a> 怎么理解 updateContainer 是 “引擎 “这件事？</h3> <p>我们可以从 updateContainer 的调用来源来展开下。</p> <p>调用 updateContainer 的函数包括： legacyRenderSubtreeIntoContainer、ReactDOMRoot.prototype.render、ReactDOMRoot.prototype.unmount、hydrateRoot、scheduleRoot。ReactDOMRoot 是由 ReactDOM.createRoot 创建的。</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>// 应用层 API
legacyRenderSubtreeIntoContainer &lt;- ReactDOM.hydrate
                                 &lt;- ReactDOM.render
                                 &lt;- ReactDOM.unmountComponentAtNode
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由上面对函数调用链的分析可以看出，updateContainer 主要来源于应用层 API 的调用，加上 updateContainer 跟 scheduleUpdateOnFiber 的关系，可以看出 updateContainer 确实是针对 container 这个容器上的调度更新的入口而存在的，而这个 container，就是 FiberRoot。</p> <h3 id="schedulemicrotask-与-queuemicrotask"><a href="#schedulemicrotask-与-queuemicrotask" class="header-anchor">#</a> scheduleMicrotask 与 queueMicrotask</h3> <p>上文我们已经了解到支持微任务的浏览器会使用微任务的形式消费完（flush）同步任务队列，那么这个微任务是什么呢？下面来展开一下 scheduleMicrotask 的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> localPromise <span class="token operator">=</span> <span class="token keyword">typeof</span> Promise <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> Promise <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">scheduleTimeout</span><span class="token operator">:</span> any <span class="token operator">=</span>
  <span class="token keyword">typeof</span> setTimeout <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> setTimeout <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">scheduleMicrotask</span><span class="token operator">:</span> any <span class="token operator">=</span>
  <span class="token keyword">typeof</span> queueMicrotask <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> queueMicrotask
    <span class="token operator">:</span> <span class="token keyword">typeof</span> localPromise <span class="token operator">!==</span> <span class="token string">'undefined'</span>
    <span class="token operator">?</span> <span class="token parameter">callback</span> <span class="token operator">=&gt;</span>
        localPromise
          <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleErrorInNextTick<span class="token punctuation">)</span>
    <span class="token operator">:</span> scheduleTimeout<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handleErrorInNextTick</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 非阻塞式抛出异常</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>什么是 queueMicrotask？</p> <blockquote><p>queueMicrotask adds the function (task) into a queue and each function is executed one by one (FIFO) after the current task has completed its work and when there is no other code waiting to be run before control of the execution context is returned to the browser's event loop.【来自 MDN】</p></blockquote> <p>微任务使用 queueMicrotask，同时 queueMicrotask 可以由 Promise 来模拟，或者使用 setTimeout 优雅替代。</p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="位运算怎么理解"><a href="#位运算怎么理解" class="header-anchor">#</a> 位运算怎么理解？</h3> <p>关于 react 中常见的位运算，在之后的文章中会单独详解。本文主要用到  <code>|</code>  运算，按位或运算的规则是：两个位都为 0 时，结果才为 0。在这里举出一个例子，方便大家对文章的  <code>|=</code>  进行理解：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> NoContext <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> BatchedContext <span class="token operator">=</span>  <span class="token number">0b0001</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> RenderContext <span class="token operator">=</span>  <span class="token number">0b0010</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> executionContext <span class="token operator">=</span> NoContext<span class="token punctuation">;</span>

<span class="token comment">// 如果现在开始 RenderContainer，进入 Batch 阶段</span>
<span class="token comment">// 增加枚举值</span>
executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token comment">// 判断是否在 Batch 阶段</span>
<span class="token comment">// 消费枚举值：0 表示没有枚举值，1 表示有枚举值。这里我们直接跟为 0 的 NoContext 作比较。</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> BatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token comment">// 判断是否处于 Render 阶段</span>
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="lanes-优先级怎么理解"><a href="#lanes-优先级怎么理解" class="header-anchor">#</a> lanes 优先级怎么理解？</h3> <p>React 中需要基于优先级的调度机制以区分不同渲染任务的轻重缓急，在 v16 版本的 React 中还是使用 expirationTime 来管理优先级，在 v17 的版本中则采用了 lane 模型，相比于 expirationTime 模型，lane 模型有着更为细粒度、效率更高的特性。关于调度与优先级的内容，之后的文章会详述。</p> <h3 id="fiberroot-和-rootfiber-什么关系"><a href="#fiberroot-和-rootfiber-什么关系" class="header-anchor">#</a> FiberRoot 和 RootFiber 什么关系？</h3> <p>在本文中反复提到了 FiberRoot 和 RootFiber（HostRoot），关于两者的区别如下：</p> <ul><li>FiberRoot 和 RootFiber 具有双向链接关系。FiberRoot.current = RootFiber，RootFiber.stateNode = FiberRoot。</li> <li>FiberRoot 是 FiberTree 的容器，记录 FiberTree 在渲染过程中的数据。</li> <li>RootFiber 本质上是 Fiber，是 FiberTree 的根节点，是特殊的 Fiber。</li> <li>HostRoot 也就是 HostRootFiber，RootFiber 被标记为 HostRoot。</li></ul> <p>在之后的文章中会详述 Fiber、RootFiber 和 FiberRoot、以及 FiberTree 的结构。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>总结一下本文的内容：</p> <ul><li>updateContainer：初始化更新任务，调用 scheduleUpdateOnFiber 发出调度请求。</li> <li>scheduleUpdateOnFiber：收集优先级，计算 FiberRoot。调用 ensureRootIsScheduled，确保 FiberRoot 发起同步或者异步调度。</li> <li>ensureRootIsScheduled：包装同步更新任务和异步更新任务并采用不同的调度策略。同步更新任务入同步任务队列在微任务中执行，异步更新任务交给调度器进行调度与回调。</li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-front-end/edit/master/docs/10.react/90.React源码漂流记/90.react-reconciliation-1.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/22, 14:56:40</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/react/tour/react-basic-glimpse/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">React 源码漂流记：React 整体结构和理念初认识</div></a> <a href="/react/tour/react-reconciliation-2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">React 源码漂流记：React 调和器核心源码解读（二）</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react/tour/react-basic-glimpse/" class="prev">React 源码漂流记：React 整体结构和理念初认识</a></span> <span class="next"><a href="/react/tour/react-reconciliation-2/">React 源码漂流记：React 调和器核心源码解读（二）</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/solid/render/render-by-jsx/"><div>
            渲染原理之组件结构与 JSX 编译
            <!----></div></a> <span class="date">09-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/solid/plan/"><div>
            计划跟踪
            <!----></div></a> <span class="date">09-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/solid/index/"><div>
            开始上手
            <!----></div></a> <span class="date">09-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://ml.jonsam.site" title="机器学习" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy Front End | Made by <a href="https://www.jonsam.site" target="_blank">Jonsam</a> by ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.eb21b6ee.js" defer></script><script src="/assets/js/2.01e091c2.js" defer></script><script src="/assets/js/62.d83f3691.js" defer></script><script src="/assets/js/4.54e60667.js" defer></script><script src="/assets/js/12.71337abb.js" defer></script><script src="/assets/js/10.ac472f43.js" defer></script><script src="/assets/js/11.c50183f9.js" defer></script><script src="/assets/js/8.7cbef5ec.js" defer></script><script src="/assets/js/5.f620477b.js" defer></script>
  </body>
</html>
