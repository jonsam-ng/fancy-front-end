<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码漂流记：React 调和器核心源码解读（七） | Fancy Front End</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <meta name="description" content="前端源码阅读栈，精读 React、Vue3 源码">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="前端源码,React源码,Vue源码,Vu3源码,Webpack源码">
    <meta name="theme-color" content="#3CB982">
    
    <link rel="preload" href="/assets/css/0.styles.e2349a00.css" as="style"><link rel="preload" href="/assets/js/app.eb21b6ee.js" as="script"><link rel="preload" href="/assets/js/2.01e091c2.js" as="script"><link rel="preload" href="/assets/js/54.5d7f6427.js" as="script"><link rel="preload" href="/assets/js/4.54e60667.js" as="script"><link rel="preload" href="/assets/js/12.71337abb.js" as="script"><link rel="preload" href="/assets/js/10.ac472f43.js" as="script"><link rel="preload" href="/assets/js/11.c50183f9.js" as="script"><link rel="preload" href="/assets/js/8.7cbef5ec.js" as="script"><link rel="preload" href="/assets/js/5.f620477b.js" as="script"><link rel="prefetch" href="/assets/js/100.8081075e.js"><link rel="prefetch" href="/assets/js/101.943ea683.js"><link rel="prefetch" href="/assets/js/102.11c8554c.js"><link rel="prefetch" href="/assets/js/103.c2780521.js"><link rel="prefetch" href="/assets/js/104.81994794.js"><link rel="prefetch" href="/assets/js/105.f987244b.js"><link rel="prefetch" href="/assets/js/106.235a578e.js"><link rel="prefetch" href="/assets/js/107.94cdbb18.js"><link rel="prefetch" href="/assets/js/108.3a80cb29.js"><link rel="prefetch" href="/assets/js/109.8884be03.js"><link rel="prefetch" href="/assets/js/110.89ab5eb2.js"><link rel="prefetch" href="/assets/js/111.355b1782.js"><link rel="prefetch" href="/assets/js/112.34671c87.js"><link rel="prefetch" href="/assets/js/113.0cca0902.js"><link rel="prefetch" href="/assets/js/114.01616168.js"><link rel="prefetch" href="/assets/js/115.4915c0b5.js"><link rel="prefetch" href="/assets/js/116.ef93855a.js"><link rel="prefetch" href="/assets/js/117.e3526ed0.js"><link rel="prefetch" href="/assets/js/118.7d52a4ea.js"><link rel="prefetch" href="/assets/js/119.a4bb17bb.js"><link rel="prefetch" href="/assets/js/120.135aa6ea.js"><link rel="prefetch" href="/assets/js/121.86c35c15.js"><link rel="prefetch" href="/assets/js/122.1452986d.js"><link rel="prefetch" href="/assets/js/123.0181b553.js"><link rel="prefetch" href="/assets/js/124.edc508f8.js"><link rel="prefetch" href="/assets/js/125.46d932c1.js"><link rel="prefetch" href="/assets/js/126.17e05a12.js"><link rel="prefetch" href="/assets/js/127.98159dfe.js"><link rel="prefetch" href="/assets/js/128.9aaa5bc6.js"><link rel="prefetch" href="/assets/js/129.26bed928.js"><link rel="prefetch" href="/assets/js/13.292db5f6.js"><link rel="prefetch" href="/assets/js/130.9f74c846.js"><link rel="prefetch" href="/assets/js/131.d6ef0885.js"><link rel="prefetch" href="/assets/js/132.1d9ee075.js"><link rel="prefetch" href="/assets/js/133.2b23ed7b.js"><link rel="prefetch" href="/assets/js/134.c47e8a23.js"><link rel="prefetch" href="/assets/js/135.2aeb3426.js"><link rel="prefetch" href="/assets/js/136.0169c47b.js"><link rel="prefetch" href="/assets/js/137.70cdfc24.js"><link rel="prefetch" href="/assets/js/138.e54160ee.js"><link rel="prefetch" href="/assets/js/139.9a6d1932.js"><link rel="prefetch" href="/assets/js/14.54d2636a.js"><link rel="prefetch" href="/assets/js/140.ddabaeca.js"><link rel="prefetch" href="/assets/js/141.35844ecc.js"><link rel="prefetch" href="/assets/js/142.4ccdb5e4.js"><link rel="prefetch" href="/assets/js/143.37a7f36e.js"><link rel="prefetch" href="/assets/js/144.95ff6a63.js"><link rel="prefetch" href="/assets/js/145.9899e545.js"><link rel="prefetch" href="/assets/js/146.6865658b.js"><link rel="prefetch" href="/assets/js/147.2a55d18a.js"><link rel="prefetch" href="/assets/js/148.f3aab640.js"><link rel="prefetch" href="/assets/js/149.57b565a0.js"><link rel="prefetch" href="/assets/js/15.81d908ff.js"><link rel="prefetch" href="/assets/js/150.3f7143ae.js"><link rel="prefetch" href="/assets/js/151.5981cf9e.js"><link rel="prefetch" href="/assets/js/152.a3428a7b.js"><link rel="prefetch" href="/assets/js/153.0f0b339d.js"><link rel="prefetch" href="/assets/js/154.39f3b522.js"><link rel="prefetch" href="/assets/js/155.13c8170a.js"><link rel="prefetch" href="/assets/js/156.ccb66614.js"><link rel="prefetch" href="/assets/js/157.4b8bce50.js"><link rel="prefetch" href="/assets/js/158.6476dd1c.js"><link rel="prefetch" href="/assets/js/159.b261a009.js"><link rel="prefetch" href="/assets/js/16.68d8e787.js"><link rel="prefetch" href="/assets/js/160.e501007d.js"><link rel="prefetch" href="/assets/js/161.d3f56d3d.js"><link rel="prefetch" href="/assets/js/162.f8590797.js"><link rel="prefetch" href="/assets/js/163.91fe4509.js"><link rel="prefetch" href="/assets/js/164.6e92f3f4.js"><link rel="prefetch" href="/assets/js/165.56868a39.js"><link rel="prefetch" href="/assets/js/166.83812a3b.js"><link rel="prefetch" href="/assets/js/167.4b528df4.js"><link rel="prefetch" href="/assets/js/168.f2b151fb.js"><link rel="prefetch" href="/assets/js/169.cb2ee128.js"><link rel="prefetch" href="/assets/js/17.895175dc.js"><link rel="prefetch" href="/assets/js/170.63b574e9.js"><link rel="prefetch" href="/assets/js/171.ad38a311.js"><link rel="prefetch" href="/assets/js/172.b592b97e.js"><link rel="prefetch" href="/assets/js/173.302ef08b.js"><link rel="prefetch" href="/assets/js/174.d71ad1a3.js"><link rel="prefetch" href="/assets/js/175.2617c860.js"><link rel="prefetch" href="/assets/js/176.19a67035.js"><link rel="prefetch" href="/assets/js/177.75aab37d.js"><link rel="prefetch" href="/assets/js/178.b2773712.js"><link rel="prefetch" href="/assets/js/179.6a34b45f.js"><link rel="prefetch" href="/assets/js/18.736b781d.js"><link rel="prefetch" href="/assets/js/180.d447fc48.js"><link rel="prefetch" href="/assets/js/181.d6b96886.js"><link rel="prefetch" href="/assets/js/182.42c2bcd5.js"><link rel="prefetch" href="/assets/js/183.a6256a82.js"><link rel="prefetch" href="/assets/js/184.8a036f5a.js"><link rel="prefetch" href="/assets/js/185.811d5831.js"><link rel="prefetch" href="/assets/js/186.6436a583.js"><link rel="prefetch" href="/assets/js/187.4bcf94a3.js"><link rel="prefetch" href="/assets/js/188.33f39bd6.js"><link rel="prefetch" href="/assets/js/189.c1b90840.js"><link rel="prefetch" href="/assets/js/19.504bd141.js"><link rel="prefetch" href="/assets/js/20.e526fb51.js"><link rel="prefetch" href="/assets/js/21.8375d39e.js"><link rel="prefetch" href="/assets/js/22.0e15b626.js"><link rel="prefetch" href="/assets/js/23.83bcc15c.js"><link rel="prefetch" href="/assets/js/24.3df554ce.js"><link rel="prefetch" href="/assets/js/25.6c56da2b.js"><link rel="prefetch" href="/assets/js/26.76154857.js"><link rel="prefetch" href="/assets/js/27.155dbcb4.js"><link rel="prefetch" href="/assets/js/28.7178e96c.js"><link rel="prefetch" href="/assets/js/29.f7337396.js"><link rel="prefetch" href="/assets/js/3.50570587.js"><link rel="prefetch" href="/assets/js/30.191545d3.js"><link rel="prefetch" href="/assets/js/31.b6a0fe90.js"><link rel="prefetch" href="/assets/js/32.18cebeab.js"><link rel="prefetch" href="/assets/js/33.146782c3.js"><link rel="prefetch" href="/assets/js/34.c08af9cb.js"><link rel="prefetch" href="/assets/js/35.ea730de0.js"><link rel="prefetch" href="/assets/js/36.11aba0b0.js"><link rel="prefetch" href="/assets/js/37.0fd8e20a.js"><link rel="prefetch" href="/assets/js/38.2cde6902.js"><link rel="prefetch" href="/assets/js/39.07c230cc.js"><link rel="prefetch" href="/assets/js/40.e4fcccd0.js"><link rel="prefetch" href="/assets/js/41.5f96c201.js"><link rel="prefetch" href="/assets/js/42.e5023440.js"><link rel="prefetch" href="/assets/js/43.2cfdc8d9.js"><link rel="prefetch" href="/assets/js/44.37f32c52.js"><link rel="prefetch" href="/assets/js/45.3973ea4b.js"><link rel="prefetch" href="/assets/js/46.87541312.js"><link rel="prefetch" href="/assets/js/47.04f0011f.js"><link rel="prefetch" href="/assets/js/48.1151f311.js"><link rel="prefetch" href="/assets/js/49.6830fb0c.js"><link rel="prefetch" href="/assets/js/50.84b34574.js"><link rel="prefetch" href="/assets/js/51.840f38c4.js"><link rel="prefetch" href="/assets/js/52.3dbda6e7.js"><link rel="prefetch" href="/assets/js/53.7f0a8896.js"><link rel="prefetch" href="/assets/js/55.86c7b544.js"><link rel="prefetch" href="/assets/js/56.49a27b9a.js"><link rel="prefetch" href="/assets/js/57.287f9e58.js"><link rel="prefetch" href="/assets/js/58.40a49fdb.js"><link rel="prefetch" href="/assets/js/59.91487422.js"><link rel="prefetch" href="/assets/js/6.8880bb8c.js"><link rel="prefetch" href="/assets/js/60.8dfd58ee.js"><link rel="prefetch" href="/assets/js/61.7b4874b9.js"><link rel="prefetch" href="/assets/js/62.d83f3691.js"><link rel="prefetch" href="/assets/js/63.1237a900.js"><link rel="prefetch" href="/assets/js/64.1f096a25.js"><link rel="prefetch" href="/assets/js/65.809d988d.js"><link rel="prefetch" href="/assets/js/66.43c1e5f9.js"><link rel="prefetch" href="/assets/js/67.24ab137d.js"><link rel="prefetch" href="/assets/js/68.7b0346b5.js"><link rel="prefetch" href="/assets/js/69.2008c989.js"><link rel="prefetch" href="/assets/js/7.0c293177.js"><link rel="prefetch" href="/assets/js/70.e8cf3232.js"><link rel="prefetch" href="/assets/js/71.d661943d.js"><link rel="prefetch" href="/assets/js/72.e67a47a3.js"><link rel="prefetch" href="/assets/js/73.87f1db52.js"><link rel="prefetch" href="/assets/js/74.ac67cd0d.js"><link rel="prefetch" href="/assets/js/75.e25ebf69.js"><link rel="prefetch" href="/assets/js/76.a7222468.js"><link rel="prefetch" href="/assets/js/77.ffb71305.js"><link rel="prefetch" href="/assets/js/78.72c00bee.js"><link rel="prefetch" href="/assets/js/79.66ec368e.js"><link rel="prefetch" href="/assets/js/80.8792d3d7.js"><link rel="prefetch" href="/assets/js/81.49d3731a.js"><link rel="prefetch" href="/assets/js/82.fbe09e61.js"><link rel="prefetch" href="/assets/js/83.220a02bb.js"><link rel="prefetch" href="/assets/js/84.4b722410.js"><link rel="prefetch" href="/assets/js/85.f83d2db9.js"><link rel="prefetch" href="/assets/js/86.17b19d53.js"><link rel="prefetch" href="/assets/js/87.37568307.js"><link rel="prefetch" href="/assets/js/88.d7cc6612.js"><link rel="prefetch" href="/assets/js/89.ffb378d0.js"><link rel="prefetch" href="/assets/js/9.2a7e5bdc.js"><link rel="prefetch" href="/assets/js/90.02c91127.js"><link rel="prefetch" href="/assets/js/91.c22d9224.js"><link rel="prefetch" href="/assets/js/92.c79d457a.js"><link rel="prefetch" href="/assets/js/93.33a03732.js"><link rel="prefetch" href="/assets/js/94.c73ddbbc.js"><link rel="prefetch" href="/assets/js/95.a5151497.js"><link rel="prefetch" href="/assets/js/96.b8f204d2.js"><link rel="prefetch" href="/assets/js/97.d7ddaa6f.js"><link rel="prefetch" href="/assets/js/98.49dbda5e.js"><link rel="prefetch" href="/assets/js/99.d14f43ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2349a00.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Fancy Front End" class="logo"> <span class="site-name can-hide">Fancy Front End</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React源码" class="dropdown-title"><a href="/react/index/" class="link-title">React源码</a> <span class="title" style="display:none;">React源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/react/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/react/scheduler/index/" class="nav-link">调度器（Scheduler）</a></li><li class="dropdown-item"><!----> <a href="/react/updater/index/" class="nav-link">更新器（Updater）</a></li><li class="dropdown-item"><!----> <a href="/react/render/index/" class="nav-link">渲染器（Render）</a></li><li class="dropdown-item"><!----> <a href="/react/update/index/" class="nav-link">更新周期</a></li><li class="dropdown-item"><!----> <a href="/react/hooks/index/" class="nav-link">hooks 原理</a></li><li class="dropdown-item"><!----> <a href="/react/summary/index/" class="nav-link">总结</a></li><li class="dropdown-item"><!----> <a href="/react/tour/index/" class="nav-link">📙 React源码漂流记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3源码" class="dropdown-title"><a href="/vue3/index/" class="link-title">Vue3源码</a> <span class="title" style="display:none;">Vue3源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/index/" class="nav-link">开始上手</a></li><li class="dropdown-item"><!----> <a href="/vue3/basic/index/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/vue3/reactivity/index/" class="nav-link">reactivity</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-core/index/" class="nav-link">runtime-core</a></li><li class="dropdown-item"><!----> <a href="/vue3/runtime-dom/index/" class="nav-link">runtime-dom</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/web/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/" class="nav-link">Awesome Web</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">Awesome NodeJS</a></li></ul></div></div><div class="nav-item"><a href="/topic/" class="nav-link">话题</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/nav/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nav/" class="nav-link">导航</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">Q&amp;A</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-front-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/react/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/plan/" class="sidebar-link">plan 计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调和（Reconciliation）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调度器（Scheduler）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新器（Updater）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>渲染器（Render）</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hooks原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React源码漂流记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/tour/index/" class="sidebar-link">开始上手</a></li><li><a href="/react/tour/plan/" class="sidebar-link">Plan 计划</a></li><li><a href="/react/tour/talk/" class="sidebar-link">前言</a></li><li><a href="/react/tour/react-basic-element/" class="sidebar-link">React 源码漂流记：ReactElement 与基础概念</a></li><li><a href="/react/tour/react-basic-children/" class="sidebar-link">React 源码漂流记：ReactChildren 与节点操纵</a></li><li><a href="/react/tour/react-basic-glimpse/" class="sidebar-link">React 源码漂流记：React 整体结构和理念初认识</a></li><li><a href="/react/tour/react-reconciliation-1/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（一）</a></li><li><a href="/react/tour/react-reconciliation-2/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（二）</a></li><li><a href="/react/tour/react-reconciliation-3/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（三）</a></li><li><a href="/react/tour/react-reconciliation-4/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（四）</a></li><li><a href="/react/tour/react-reconciliation-5/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（五）</a></li><li><a href="/react/tour/react-reconciliation-6/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（六）</a></li><li><a href="/react/tour/react-reconciliation-7/" aria-current="page" class="active sidebar-link">React 源码漂流记：React 调和器核心源码解读（七）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#finishconcurrentrender" class="sidebar-link">finishConcurrentRender</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#commitroot" class="sidebar-link">commitRoot</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#effectlist-的遍历" class="sidebar-link">EffectList 的遍历</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#commitbeforemutationeffects" class="sidebar-link">commitBeforeMutationEffects</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#commitmutationeffects" class="sidebar-link">commitMutationEffects</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#commitlayouteffects" class="sidebar-link">commitLayoutEffects</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#扩展" class="sidebar-link">扩展</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/react/tour/react-reconciliation-7/#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/react/tour/react-reconciliation-8/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（八）</a></li><li><a href="/react/tour/react-reconciliation-9/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（九）</a></li><li><a href="/react/tour/react-reconciliation-10/" class="sidebar-link">React 源码漂流记：React 调和器核心源码解读（十）</a></li><li><a href="/react/tour/react-scheduler-1/" class="sidebar-link">React 源码漂流记：React 调度器核心源码解读（一）</a></li><li><a href="/react/tour/dr-1/" class="sidebar-link">带着原理重读 React 官方文档（一）</a></li><li><a href="/react/tour/dr-2/" class="sidebar-link">带着原理重读 React 官方文档（二）</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-e1efabd0><div class="articleInfo" data-v-e1efabd0><ul class="breadcrumbs" data-v-e1efabd0><li data-v-e1efabd0><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-e1efabd0></a></li> <li data-v-e1efabd0><a href="/categories/?category=react" title="分类" data-v-e1efabd0>react</a></li><li data-v-e1efabd0><a href="/categories/?category=React%E6%BA%90%E7%A0%81%E6%BC%82%E6%B5%81%E8%AE%B0" title="分类" data-v-e1efabd0>React源码漂流记</a></li></ul> <div class="info" data-v-e1efabd0><div title="作者" class="author iconfont icon-touxiang" data-v-e1efabd0><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-e1efabd0>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-e1efabd0><a href="javascript:;" data-v-e1efabd0>2022-08-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">React 源码漂流记：React 调和器核心源码解读（七）<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>React17</span><span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>精简</span></div> <!----> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <p></p><div class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#前言">前言</a></li><li><a href="#finishconcurrentrender">finishConcurrentRender</a></li><li><a href="#commitroot">commitRoot</a></li><li><a href="#effectlist-的遍历">EffectList 的遍历</a></li><li><a href="#commitbeforemutationeffects">commitBeforeMutationEffects</a></li><li><a href="#commitmutationeffects">commitMutationEffects</a></li><li><a href="#commitlayouteffects">commitLayoutEffects</a></li><li><a href="#扩展">扩展</a><ul><li><a href="#commitrootimpl-三次执行-flushpassiveeffects-有何含义">commitRootImpl 三次执行 flushPassiveEffects 有何含义？</a></li></ul></li><li><a href="#问题">问题</a><ul><li><a href="#为什么在-layout-阶段之后需要-requestpaint">为什么在 layout 阶段之后需要 requestPaint?</a></li></ul></li><li><a href="#总结">总结</a></li><li><a href="#参考">参考</a></li></ul></div><p></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在上篇文章中，我们对 React 渲染过程中的 “捕获” 与 “冒泡” 过程的理解有了更深一层的认识，并且从整体脉络上总结了  <code>Batch</code>  阶段和  <code>Render</code>  阶段的过程。从本文开始，我们将开始探讨  <code>Commit</code>  阶段的原理，逐步了解 FiberTree 向 DOMTree 飞跃的过程。</p> <p>渲染根据调度方式的不同被分成了同步渲染和异步渲染，在同步的渲染结束后调用  <code>commitRoot</code>  提交本次的调和结果，而在异步渲染结束后是通过  <code>finishConcurrentRender</code>  来处理后续的工作的。下面我们就从  <code>finishConcurrentRender</code>  函数开始深入分析。</p> <h2 id="finishconcurrentrender"><a href="#finishconcurrentrender" class="header-anchor">#</a> finishConcurrentRender</h2> <p>从本质上来说  <code>finishConcurrentRender</code>  的核心作用还是执行  <code>commitRoot</code>  以提交调和结果，但是相比同步渲染而言，异步渲染要更加复杂，换句话说， <code>Render</code>  结束后要视情况而定是否需要立即  <code>Commit</code> ，要根据 <code>Render</code>  阶段的执行情况（exitStatus）加以确认。 <code>Commit</code>  的操作应当足够高效，因为 DOM 的绘制过程成本不菲。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>exitStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ......</span>
    <span class="token keyword">case</span> <span class="token literal-property property">RootErrored</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">RootSuspended</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">RootSuspendedWithDelay</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">markRootSuspended</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ......</span>
      <span class="token comment">// The work expired. Commit immediately.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">RootCompleted</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// The work completed. Ready to commit.</span>
      <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  ......</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>分析如下：</p> <ul><li>只有在发生普通错误的时候才允许提交， <code>RootIncomplete</code>  (未完成状态) 和 <code>RootFatalErrored</code> （致命错误状态）是不允许提交的。这也很符合预期，因为在进入此函数之前，普通错误就已经重试多次了。</li> <li>对于  <code>RootSuspended</code>  和  <code>RootSuspendedWithDelay</code> ，必须等到任务超时，才能够进行提交。</li></ul> <h2 id="commitroot"><a href="#commitroot" class="header-anchor">#</a> commitRoot</h2> <div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-4f7c9f45>重要</span></div> <p><code>commitRoot</code>  主要调用  <code>commitRootImpl</code>  函数，源码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span>
    <span class="token comment">// means `flushPassiveEffects` will sometimes result in additional</span>
    <span class="token comment">// passive effects. So we need to keep flushing in a loop until there are</span>
    <span class="token comment">// no more pending effects.</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// 确保当前是 Batch 状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Should not already be working.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token comment">// 当前 commit 的优先级</span>
  <span class="token keyword">const</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes<span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// 合并finishedWork子树的 lanes，剩余的未处理的优先级</span>
  <span class="token keyword">let</span> remainingLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将剩余未处理的优先级挂载到 root.pendingLanes 上</span>
  <span class="token function">markRootFinished</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// If there are pending passive effects, schedule a callback to process them.</span>
  <span class="token comment">// Do this as early as possible, so it is queued before anything else that</span>
  <span class="token comment">// might get scheduled in the commit phase. </span>
  <span class="token comment">// 确保子树有 PassiveMask 副作用时被调度以处理副作用</span>
  <span class="token comment">// const PassiveMask = Passive | ChildDeletion;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">||</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// ......</span>
      <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// This render triggered passive effects</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check if there are any effects in the whole tree.</span>
  <span class="token comment">// 判断子树是否有副作用</span>
  <span class="token keyword">const</span> subtreeHasEffects <span class="token operator">=</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span>
      <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
    NoFlags<span class="token punctuation">;</span>
  <span class="token comment">// 判断根节点是否有副作用</span>
  <span class="token keyword">const</span> rootHasEffect <span class="token operator">=</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span>
      <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
    NoFlags<span class="token punctuation">;</span>
  <span class="token comment">// 如果子树或者根节点有副作用，则处理之</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>subtreeHasEffects <span class="token operator">||</span> rootHasEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ......</span>
    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
    <span class="token comment">// executionContext 更新为 CommitContext</span>
    executionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// The commit phase is broken into several sub-phases. We do a separate pass</span>
    <span class="token comment">// of the effect list for each phase: all mutation effects come before all</span>
    <span class="token comment">// layout effects, and so on.</span>

    <span class="token comment">// The first phase a &quot;before mutation&quot; phase. We use this phase to read the</span>
    <span class="token comment">// state of the host tree right before we mutate it. This is where</span>
    <span class="token comment">// getSnapshotBeforeUpdate is called.</span>
    <span class="token comment">// Commit  阶段分成三个步骤，分别是 before mutation, mutation 和 layout。</span>
    <span class="token comment">// before mutation 阶段在 mutation 之前读取旧状态，并调用相关的组件生命周期函数</span>
    <span class="token keyword">const</span> shouldFireAfterActiveInstanceBlur <span class="token operator">=</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>
      root<span class="token punctuation">,</span>
      finishedWork<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// The next phase is the mutation phase, where we mutate the host tree.</span>
    <span class="token comment">// mutation 阶段对副作用进行执行和更新，执行 DOM 操作，调用相关的生命周期函数</span>
    <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// The work-in-progress tree is now the current tree. This must come after</span>
    <span class="token comment">// the mutation phase, so that the previous tree is still current during</span>
    <span class="token comment">// componentWillUnmount, but before the layout phase, so that the finished</span>
    <span class="token comment">// work is current during componentDidMount/Update.</span>
    <span class="token comment">// workInProgress 树切换到current树的时机是在mutation结束后，layout开始前。</span>
    <span class="token comment">// 这样做的原因是在mutation阶段调用类组件的componentWillUnmount的时候，还可以获取到卸载前的组件信息；</span>
    <span class="token comment">// 在layout阶段调用componentDidMount/Update时，获取的组件信息更新后的。</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    <span class="token comment">// The next phase is the layout phase, where we call effects that read</span>
    <span class="token comment">// the host tree after it's been mutated. The idiomatic use case for this is</span>
    <span class="token comment">// layout, but class component lifecycles also fire here for legacy reasons.</span>
    <span class="token comment">// layout 阶段在 mutation 阶段之后，读取组件的最新状态，并执行相关的生命周期函数</span>
    <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span>
    <span class="token comment">// opportunity to paint.</span>
    <span class="token comment">// 请求调度器在帧尾阻塞 `Render` 过程，以使浏览器有足够的空闲时间绘制视图</span>
    <span class="token function">requestPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Commit 完毕后恢复  executionContext </span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
  <span class="token punctuation">}</span> 
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">includesSomeLane</span><span class="token punctuation">(</span>pendingPassiveEffectsLanes<span class="token punctuation">,</span> SyncLane<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    root<span class="token punctuation">.</span>tag <span class="token operator">!==</span> LegacyRoot
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// 退出 commitRoot 时调用，确保 Root 上新的任务会被调度</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// If layout work was scheduled, flush it now.</span>
  <span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p>此函数涵盖了  <code>Commit</code>  阶段的整个过程，有一些细节问题分析如下：</p> <ul><li><code>flushPassiveEffects</code> :  <code>flushPassiveEffects</code>  主要与  <code>useEffect</code>  的副作用相关，此函数以同步或者异步的方式执行  <code>useEffect</code>  的销毁函数和回调函数。细节部分将在 hook 相关章节进行详细探讨。如果子树有  <code>PassiveMask</code>  标记，则在调度器的回调中调用  <code>flushPassiveEffects</code> 。</li> <li>有四种副作用标记被用来判断是否需要  <code>Commit</code> ，分别是： <code>BeforeMutationMask</code> 、 <code>MutationMask</code> 、 <code>LayoutMask</code> 、 <code>PassiveMask</code> 。当  <code>finishedWork</code>  根节点上或者子树上具有如上的副作用，则执行  <code>Commit</code>  操作。</li> <li><code>Commit</code>  过程分成三个步骤，分别是  <code>beforeMutation</code> 、 <code>mutation</code>  和 <code>layout</code> ，分别调用  <code>commitBeforeMutationEffects</code> 、 <code>commitMutationEffects</code>  和  <code>commitLayoutEffects</code> 。</li> <li>workInProgress FiberTree 成为 current FiberTree 是在  <code>mutation</code>  阶段之后、layout 阶段之前完成的， <code>root.current = finishedWork</code> 。之前的 current FiberTree 现在利索当前的就成了  <code>workInProgress FiberTree</code> 。</li> <li>在  <code>mutation</code>  阶段，React 已经根据 EffectTag 操纵 JavaScript 对 DOM 进行了插入、更新、删除等操作，由于浏览器的空闲时间实际上是被调度器控制的，所以在  <code>layout</code>  阶段完成之后，需要通知调度器进行 yield（阻塞渲染回调），给浏览器重绘留下充足的时间。 <code>requestPaint</code>  函数将在调度器部分进行详细的分析。</li></ul> <div class="custom-block tip"><p class="custom-block-title">旧版本的执行逻辑</p> <p>三个阶段：</p> <ul><li>before mutation：读取组件变更前的状态，针对类组件，调用 getSnapshotBeforeUpdate，让我们可以在 DOM 变更前获取组件实例的信息；针对函数组件，异步调度 useEffect。</li> <li>mutation：针对 HostComponent，进行相应的 DOM 操作；针对类组件，调用 componentWillUnmount；针对函数组件，执行 useLayoutEffect 的销毁函数。</li> <li>layout：在 DOM 操作完成后，读取组件的状态，针对类组件，调用生命周期 componentDidMount 和 componentDidUpdate，调用 setState 的回调；针对函数组件填充 useEffect 的 effect 执行数组，并调度 useEffect。</li></ul></div> <p>在进入下面三个核心函数的分析之前，我们需要先分析一下 FiberTree 上 Effect 的遍历过程。从上文中我们已经知道了，新版的 React 去除了 EffectList 的概念，将 Effect 冒泡收集到  <code>subtreeFlags</code>  标记上。因此，在对 EffectList 的遍历时，就不能直接使用旧版中链表的遍历方式。</p> <h2 id="effectlist-的遍历"><a href="#effectlist-的遍历" class="header-anchor">#</a> EffectList 的遍历</h2> <p>下面以  <code>commitMutationEffects</code>  探讨 FiberTree 中  <code>EffectList</code>  的遍历过程。这里同样分为 “捕获” 和 “冒泡” 的过程，将遍历过程穿插执行的工作可以理解为  <code>beginWork</code>  和  <code>completeWork</code> 。（注意，此时遍历的原理与调和 FiberTree 时遍历的原理一致）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/react/packages/react-reconciler/src/ReactFiberCommitWork.new.js</span>
<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span> 
  <span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">firstChild</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nextEffect <span class="token operator">=</span> firstChild<span class="token punctuation">;</span>
  <span class="token function">commitMutationEffects_begin</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitMutationEffects_begin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> nextEffect<span class="token punctuation">;</span>
    <span class="token comment">// begin work......（beginWork插槽）</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token comment">// MutationMask 或者 BeforeMutationMask 或者 LayoutMask</span>
    <span class="token comment">// 如果当前 Fiber 有 subtreeFlags，说明子树中有相应的 EffectTag</span>
    <span class="token comment">// 这里的判断决定是否需要继续捕获</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> MutationMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ......</span>
      <span class="token comment">// 将子节点作为下一个遍历的节点，向下捕获</span>
      nextEffect <span class="token operator">=</span> child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不符合上述条件，说明子树中无响应的 EffectTag，因此开始冒泡</span>
      <span class="token function">commitMutationEffects_complete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitMutationEffects_complete</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> nextEffect<span class="token punctuation">;</span>

    <span class="token comment">// complete work......（completeWork插槽）</span>
    <span class="token comment">// 冒泡时先冒泡到兄弟节点，无兄弟节点时再冒泡到父节点</span>
    <span class="token comment">// 冒泡一次后需要仅此进行捕获的判断，因此需要 return</span>
    <span class="token keyword">const</span> sibling <span class="token operator">=</span> fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ......</span>
      nextEffect <span class="token operator">=</span> sibling<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>弄清楚上述的 “捕获” 和 “冒泡” 的遍历过程之后，在下文中  <code>commitBeforeMutationEffects</code> 、 <code>commitMutationEffects</code>  和 <code>commitLayoutEffects</code>  三个函数中都是对此遍历方法的应用。因此在下文的分析中，我们将着重探讨  <code>beginWork</code>  和  <code>completeWork</code>  插槽中的工作细节。</p> <h2 id="commitbeforemutationeffects"><a href="#commitbeforemutationeffects" class="header-anchor">#</a> commitBeforeMutationEffects</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// completeWork插槽</span>
<span class="token function">commitBeforeMutationEffectsOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>分析如下：</p> <ul><li>在冒泡阶段在 fiber 上执行  <code>commitBeforeMutationEffectsOnFiber</code> 。</li></ul> <h2 id="commitmutationeffects"><a href="#commitmutationeffects" class="header-anchor">#</a> commitMutationEffects</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// beginWork插槽</span>
<span class="token keyword">const</span> deletions <span class="token operator">=</span> fiber<span class="token punctuation">.</span>deletions<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>deletions <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deletions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> childToDelete <span class="token operator">=</span> deletions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> childToDelete<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// completeWork插槽</span>
<span class="token function">commitMutationEffectsOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>分析如下：</p> <ul><li>在捕获阶段查找 fiber 上  <code>deletions</code>  收集的待删除的节点，并且提交节点的删除。</li> <li>在冒泡阶段调用  <code>commitMutationEffectsOnFiber</code> 。</li> <li>为什么删除操作要在捕获阶段单独进行，而不是放在冒泡阶段一起处理？因为删除操作相对于更新操作（添加或者更新）而言要简单许多，在当前已经遍历到的节点上，只需将前置工作中收集到的待删除的节点进行处理即可；相对而言， <code>commitMutationEffectsOnFiber</code>  的处理过程则要复杂的多，需要通过不同的 EffectTag 以进行不同的处理，并且处理方式也与组件的类型有很大的关联。所以此处将删除操作在捕获时即执行，一是因为删除操纵本身与 EffectTag 类型、组件类型无关，而是因为提前处理能够避免 DOM 操作的混乱性。</li></ul> <h2 id="commitlayouteffects"><a href="#commitlayouteffects" class="header-anchor">#</a> commitLayoutEffects</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// completeWork插槽</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> LayoutMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">// ......</span>
  <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> fiber<span class="token punctuation">,</span> committedLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>分析如下：</p> <ul><li>在捕获阶段执行  <code>commitLayoutEffectOnFiber</code> ，但需使 fiber 上具有  <code>LayoutMask</code>  标记。</li></ul> <p>我们可能已经注意到，在上述  <code>commitBeforeMutationEffectsOnFiber</code> 、 <code>commitMutationEffectsOnFiber</code>  函数中，都没有 EffectTag 的标记要求，而  <code>commitLayoutEffectOnFiber</code>  却要求 fiber 具有  <code>LayoutMask</code>  标记。事实上  <code>MutationMask</code> 、 <code>BeforeMutationMask</code>  或者  <code>LayoutMask</code>  都是 EffectTag 的集合：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Groups of flags that are used in the commit phase to skip over trees that</span>
<span class="token comment">// don't contain effects, by checking subtreeFlags.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> BeforeMutationMask <span class="token operator">=</span> Update <span class="token operator">|</span> Snapshot <span class="token operator">|</span> ChildDeletion <span class="token operator">|</span> Visibility<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MutationMask <span class="token operator">=</span> Placement <span class="token operator">|</span> Update <span class="token operator">|</span> ChildDeletion <span class="token operator">|</span> ContentReset <span class="token operator">|</span> Ref <span class="token operator">|</span> Hydrating <span class="token operator">|</span> Visibility<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LayoutMask <span class="token operator">=</span> Update <span class="token operator">|</span> Callback <span class="token operator">|</span> Ref <span class="token operator">|</span> Visibility<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过判断 subtreeFlags 上是否有这个 EffectTag 的组合，可以使捕获和冒泡的过程能够进行的针对需要进行操作的节点进行处理。</p> <h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <h3 id="commitrootimpl-三次执行-flushpassiveeffects-有何含义"><a href="#commitrootimpl-三次执行-flushpassiveeffects-有何含义" class="header-anchor">#</a> <code>commitRootImpl</code>  三次执行  <code>flushPassiveEffects</code>  有何含义？</h3> <p>首先需要明确的是， <code>flushPassiveEffects</code>  是与  <code>useEffect</code>  所产生的的副作用是密切相关的，在发生一次 “渲染” 的前后，需要对这种  <code>Passive</code>  的副作用进行处理，包括执行副作用的销毁函数和副作用函数。</p> <p>所谓副作用，是在某些触发渲染的时机上执行 DOM 操作、网络请求、日志打印、事件订阅、定时任务等行为。副作用是不能直接在组件主体（函数式组件）中执行的，因为 React 无法保证副作用在执行时所处的环境是正确的。事实上，在函数主体执行时，React 还处于调和阶段，并没有  <code>Commit</code>  下一次的渲染，况且直接在函数体中执行的副作用会极大的阻塞调和的效率（参照前文内容）。</p> <p>因此，在函数式组件的主体函数中应当遵循 “<strong>只定义组件的特性和行为方式（包括视图的定义、事件回调的定义、副作用的定义、状态和计算属性的定义，因此可以把函数式组件分成  <code>Render</code> 、 <code>Callback/Handler</code> 、 <code>Effect</code>  和 <code>Props/State</code>  四个部分），不进行高成本的计算</strong> “的原则，“JSX” 本质上是一种<strong>动态的描述和定义组件的语法糖</strong>。<strong>组件的状态和行为的变化应该由副作用和事件机制来推动</strong>。（注意：副作用虽然可以用来模拟类似于类组件的生命周期，但是其理念是极为不同的，相比而言，副作用是函数式编程的产物，要更为灵活和高效，<strong>按照生命周期的想法去编写函数式组件是错误的，React 中提供的副作用钩子并不能准确的翻译 / 转化为类组件各种生命周期</strong>！参见<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render" target="_blank" rel="noopener noreferrer"> Hook 会因为在渲染时创建函数而变慢吗？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。）</p> <p>回归整体， <code>commitRootImpl</code>  函数中共有三次  <code>flushPassiveEffects</code>  的调用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// [1]</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// [2]</span>
<span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [3]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span>pendingPassiveEffectsLanes<span class="token punctuation">,</span> SyncLane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>第一次执行  <code>flushPassiveEffects</code>  是在  <code>Commit</code>  三大步骤未开始之前执行的，目的是判断是否有残留的  <code>passiveEffects</code> （useEffect 的副作用） 未执行，如果有则调用  <code>flushPassiveEffects</code>  处理之。之所有用  <code>while</code>  循环是因为副作用有可能产生新的副作用（注意：在函数式组件中，应该避免副作用之间相互调用以免造成死循环）。</li> <li>第二次执行  <code>flushPassiveEffects</code>  是在  <code>Commit</code>  三大步骤未开始之前请求一次  <code>flushPassiveEffects</code>  的调度，从前文中我们已经知道， <code>Commit</code>  步骤中会阻塞  <code>Render</code>  过程，但是并不会阻塞调度过程，因此，此次  <code>flushPassiveEffects</code>  调度能够保证其执行时间能够在本次  <code>Commit</code>  阶段之后，也就是说 <code>传给 useEffect 的函数会在浏览器完成布局与绘制之后，在一个延迟事件中被调用</code> ，参见<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer"> effect 的执行时机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>第三次执行  <code>flushPassiveEffects</code>  是在  <code>root.finishedLanes</code>  中有同步的 lanes 的时机下，这说明本次副作用的处理的优先级较高，需同步执行。 <code>从 React 18 开始，当它是离散的用户输入（如点击）的结果时，或者当它是由 flushSync 包装的更新结果时，传递给 useEffect 的函数将在屏幕布局和绘制之前同步执行</code> ，参见<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer"> effect 的执行时机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <div class="custom-block tip"><p class="custom-block-title">重点提示</p> <ul><li><code>flushPassiveEffects</code>  的执行是异步的，是通过调度器的调度完成的，但是可以保证相关的副作用是在当前  <code>Commit</code>  之后，也即视图更新渲染之后执行。</li> <li><code>useEffect</code>  中的副作用的执行时机是： <code>Commit</code>  完成之后进入  <code>Batch</code>  阶段中的某一次调度器的回调中，进一步将就是，屏幕视图布局和绘制之后的一个延迟事件中。 <code>useEffect</code>  中副作用的执行是异步的。</li> <li><code>useEffect</code>  中的副作用也可以同步的执行（ <code>useLayoutEffect</code>  中副作用执行之后，在  <code>Commit</code>  完成之时），当然这需要特殊的条件。</li></ul></div> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="为什么在-layout-阶段之后需要-requestpaint"><a href="#为什么在-layout-阶段之后需要-requestpaint" class="header-anchor">#</a> 为什么在  <code>layout</code>  阶段之后需要  <code>requestPaint</code> ?</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>By default, the browser will wait until the current thread of execution finishes and do one consolidated reflow and repaint (as this is considered more efficient than doing many reflows and repaints). This is not specified in any specification so the browser can implement as it wants to.</p> <p>But, there are some specific operations that will generally trigger a reflow (and sometimes a corresponding repaint). These operations are operations (requesting certain properties related to the position of elements) which can only be completed when an accurate reflow has been done. So, it is possible to manually trigger a reflow by requesting one of these properties.</p> <p>参见：<a href="https://stackoverflow.com/questions/27196753/when-does-the-dom-repaint-during-javascript-routines" target="_blank" rel="noopener noreferrer">html - When does the DOM repaint during Javascript routines? - Stack Overflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>默认情况下，浏览器会在当前线程执行完成之后，执行一次合并的  <code>reflow</code>  和  <code>repaint</code> 。但是也存在一些特殊的情况会触发  <code>reflow</code> ，这就是执行那些只有在  <code>reflow</code>  之后才能完成的任务。因此，操纵 JavaScript 执行 DOM 操作并不是会立即促使浏览器进行  <code>repaint</code> ，这其中浏览器有诸多优化措施以保证  <code>reflow</code>  和  <code>repaint</code>  高效的进行。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文中最最要的内容是对  <code>commitRoot</code>  函数的分析。 <code>commitRoot</code>  是  <code>Commit</code>  阶段提纲挈领的函数，它将整个  <code>Commit</code>  的过程分成了最要的三个步骤，分别是  <code>beforeMutation</code> 、 <code>mutation</code>  和  <code>layout</code> 。这三个步骤分别调用  <code>commitBeforeMutationEffects</code> 、 <code>commitMutationEffects</code>  和  <code>commitLayoutEffects</code>  函数进行处理，总结其特性分别是  <code>commitBeforeMutationEffects</code>  提供组件更新之前的实例数据， <code>commitMutationEffects</code>  操作原生 JavaScript 更新 DOM 节点，处理组件销毁前的副作用， <code>commitLayoutEffects</code>  处理组件挂载后（更新后）的副作用。</p> <p>另外一个重点是， <code>workInProgress</code>  树切换为  <code>current</code>  树的过程是在  <code>mutation</code>  之后  <code>layout</code>  之前完成的。三个步骤完成之后需要通知调度器进行 yield （中断  <code>Render</code>  阶段的执行），从而使浏览器有足够的时间对  <code>mutation</code>  阶段造成的 DOM 更新进行重排（reflow）和重绘（repaint）。</p> <p>上述三个步骤追根究底还是在  <code>EffectList</code> （沿用旧版本的概念） 的遍历过程中执行的，其总体过程可归纳为 “跳跃式的”（可精准的针对有相关  <code>EffectTagMask</code>  的节点进行操作）“捕获与冒泡” 的过程，其内部逻辑同样可抽象为   <code>beginWork</code>  和  <code>completeWork</code>  的工作。上述三个步骤其实质是要执行  <code>commitBeforeMutationEffectsOnFiber</code> 、 <code>commitMutationEffectsOnFiber</code>  和  <code>commitLayoutEffectOnFiber</code>  函数。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li>旧版本：<a href="https://ithelp.ithome.com.tw/articles/10255458" target="_blank" rel="noopener noreferrer">React 源碼 commit 階段詳解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-front-end/edit/master/docs/10.react/90.React源码漂流记/150.react-reconciliation-7.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/08/08, 19:51:35</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/react/tour/react-reconciliation-6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">React 源码漂流记：React 调和器核心源码解读（六）</div></a> <a href="/react/tour/react-reconciliation-8/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">React 源码漂流记：React 调和器核心源码解读（八）</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react/tour/react-reconciliation-6/" class="prev">React 源码漂流记：React 调和器核心源码解读（六）</a></span> <span class="next"><a href="/react/tour/react-reconciliation-8/">React 源码漂流记：React 调和器核心源码解读（八）</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/solid/render/render-by-jsx/"><div>
            渲染原理之组件结构与 JSX 编译
            <!----></div></a> <span class="date">09-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/solid/plan/"><div>
            计划跟踪
            <!----></div></a> <span class="date">09-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/solid/index/"><div>
            开始上手
            <!----></div></a> <span class="date">09-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://ml.jonsam.site" title="机器学习" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy Front End | Made by <a href="https://www.jonsam.site" target="_blank">Jonsam</a> by ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.eb21b6ee.js" defer></script><script src="/assets/js/2.01e091c2.js" defer></script><script src="/assets/js/54.5d7f6427.js" defer></script><script src="/assets/js/4.54e60667.js" defer></script><script src="/assets/js/12.71337abb.js" defer></script><script src="/assets/js/10.ac472f43.js" defer></script><script src="/assets/js/11.c50183f9.js" defer></script><script src="/assets/js/8.7cbef5ec.js" defer></script><script src="/assets/js/5.f620477b.js" defer></script>
  </body>
</html>
